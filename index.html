<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Material Escolar - Painel</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Cores */
      --bg:#f5f7fb;
      --card:#ffffff;
      --accent:#2b7cff;
      --accent-light: #eef4ff;
      --muted:#6b7280;
      --success:#16a34a;
      --success-light: #ecfdf5;
      --danger:#ef4444;
      --danger-light: #fef2f2;
      --warning: #f59e0b;
      --warning-light: #fffbeb;
      --glass: rgba(255,255,255,0.7);
      
      /* Geometria */
      --radius:10px;
      --pad:16px; 
      --border-color: #e6e9ef;
    }
    *{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    
    /* ATUALIZAÇÕES CRUCIAIS PARA O FOOTER FIXAR NO FINAL */
    body {
        margin: 0;
        background: var(--bg);
        min-height: 100vh; /* Garante altura mínima da tela */
        color: #111;
        padding-bottom: 0; 
        transition: overflow 0.3s;
        display: flex; /* NOVO: Habilita flexbox no body */
        flex-direction: column; /* NOVO: Organiza os filhos verticalmente */
    }
    
    /* Header (Cabeçalho) */
    header{display:flex;align-items:center;justify-content:space-between;padding:14px var(--pad);background:var(--card);box-shadow:0 1px 12px rgba(11,15,35,0.08);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;font-weight:700;}
    header .right{display:flex;gap:12px;align-items:center}
    
    /* Layout Principal */
    /* ATUALIZAÇÃO NO LAYOUT .container */
    .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 16px;
        flex-grow: 1; /* Faz o container principal crescer e empurrar o rodapé */
    }
    .grid{display:grid;grid-template-columns:300px 1fr;gap:20px} /* Desktop View */
    
    /* Cartões */
    .card{background:var(--card);padding:var(--pad);border-radius:var(--radius);box-shadow:0 4px 12px rgba(12,18,40,0.04);transition:transform 0.1s}
    .card:hover.clickable-card { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(12,18,40,0.08); } 
    .card.group-card { padding: 0; box-shadow: 0 4px 12px rgba(12,18,40,0.04); }
    
    /* Títulos e Texto */
    .section-title{font-weight:700;margin-bottom:12px;color:#0f172a;font-size:20px}
    .small{font-size:13px;color:var(--muted)}
    
    /* Navegação (Sidebar) - Desktop Default */
    nav {padding: 4px 0;}
    nav .nav-item{padding:10px;border-radius:8px;cursor:pointer;color:#111;display:flex;gap:10px;align-items:center;transition:background 0.2s, border 0.2s}
    nav .nav-item:hover{background:#f1f5f9;}
    nav .nav-item.active{background:var(--accent-light);color:var(--accent);font-weight:600;}
    
    /* Botões */
    .btn{display:inline-block;padding:10px 16px;border-radius:8px;background:var(--accent);color:white;text-decoration:none;border:none;cursor:pointer;transition:background 0.2s, opacity 0.2s;font-weight:500;font-size:14px;}
    .btn:hover:not(:disabled){filter:brightness(1.05); box-shadow: 0 2px 8px rgba(43,124,255,0.2);}
    .btn:disabled{opacity:0.6; cursor:not-allowed;}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid var(--border-color);padding:9px 15px;}
    .btn.secondary:hover:not(:disabled){background:#f8fafc; color:var(--accent); border-color:var(--accent-light); box-shadow: none;}

    /* Inputs/Formulários */
    .input, textarea, select{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--border-color);
      background:white;
      transition:border-color: 0.2s;
      font-size: 16px; /* MELHORIA MOBILE: Garante 16px para evitar zoom indesejado */
    }
    .input:focus, textarea:focus, select:focus {border-color: var(--accent); outline: none; box-shadow: 0 0 0 1px var(--accent-light);}
    
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center}
    .materials-list{max-height:300px;overflow:auto;padding-right:6px}
    
    /* Itens de Lista (Materiais/Alunos) */
    .material-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;background:#fcfdff;border:1px solid #eef2ff;transition:background 0.2s;}
    .material-item:hover{background:var(--accent-light); border-color:var(--accent);}
    
    .student-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:var(--radius);border:1px solid var(--border-color);background:var(--card);}
    .qr-img{width:120px;height:120px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center}
    
    /* Componentes Auxiliares */
    .hint{padding:10px;border-radius:8px;background:var(--accent-light);border:1px solid var(--accent);color:var(--accent);font-size:13px}
    .flex-col{display:flex;flex-direction:column;gap:10px}
    pre.rules{background:#0b1220;color:#f8fafc;padding:15px;border-radius:8px;overflow:auto;font-size:14px;line-height:1.4;}
    
    /* Overlay e Modal Checklist - NOVO/MELHORADO */
    #menuOverlay, #checklist-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        z-index: 15;
        display: none;
        transition: opacity 0.3s;
        opacity: 0;
    }
    #menuOverlay.visible, #checklist-modal.visible {
        opacity: 1;
        display: flex; 
        align-items: center;
        justify-content: center;
    }
    .checklist-modal-box {
        width: 650px; /* Largura maior para melhor visualização */
        max-width: 95vw;
        max-height: 90vh;
        overflow: hidden;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column; /* Essencial para que a lista cresça e empurre o rodapé */
    }
    #checklist-list-area {
        overflow-y: auto;
        padding: var(--pad);
        padding-top: 0;
        flex-grow: 1; /* Ocupa o espaço restante e permite a rolagem apenas nesta área */
    }
    .checklist-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 10px;
        border-bottom: 1px dashed var(--border-color);
    }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-item-details { flex-grow: 1; max-width: 60%; }
    .checklist-item-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    
    /* CORREÇÃO: Aumenta a largura para melhor visualização em todos os dispositivos */
    .delivery-input { 
        width: 60px !important; 
        padding: 4px; 
        border-radius: 4px; 
        border: 1px solid #ccc; 
        text-align: center; 
        font-size: 13px; /* Mantém 13px para não afetar o layout do modal */
    }

    /* Estilos para o Signature Pad */
    #signature-area {
        padding: var(--pad);
        background: #fcfdff;
        border-top: 1px solid var(--border-color); /* Mantido para separar do checklist */
    }
    #signature-canvas {
        border: 1px dashed var(--muted);
        border-radius: 4px;
        width: 100%;
        height: 150px;
        touch-action: none; /* Necessário para touch events e mouse */
    }
    #signature-preview {
        max-width: 100%;
        max-height: 150px;
        margin: 5px 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        object-fit: contain;
    }

    /* Estilos para o Documento de Impressão */
    .signature-block { display: inline-block; width: 45%; margin: 0 10px; vertical-align: top; }


    /* ------------------------------------- */
    /* ESTILOS DO RODAPÉ (FOOTER) - NOVO */
    /* ------------------------------------- */
    #main-footer {
        background-color: var(--card);
        color: var(--muted);
        padding: 20px var(--pad);
        text-align: center;
        font-size: 14px;
        margin-top: 40px; /* Espaço para separar do conteúdo principal */
        border-top: 1px solid var(--border-color); /* Linha sutil no topo */
        width: 100%;
        flex-shrink: 0; /* Impede que o footer encolha */
    }
    #main-footer .small-text {
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.8;
    }
    
    /* REFINAMENTO: Estilos do Botão Menu Hambúrguer (Desktop) */
    #menuToggle { 
        display: none; /* Escondido por padrão no desktop */
        padding: 6px 10px; 
        font-size: 16px; 
        margin-right: 10px;
    }


    /* Mobile Responsiveness (Hamburguer Menu) */
    @media (max-width: 992px) {
      /* ... (Estilos Mobile Anteriores) ... */
      header .left-controls { display: flex; align-items: center; }
      #menuToggle { display: inline-block !important; } /* Exibe no mobile */

      .grid { grid-template-columns: 1fr; } /* Layout de coluna única */
      .container { padding: 0 12px; }
      
      /* Sidebar */
      #sidebar {
        position: fixed;
        top: 50px; /* Abaixo do header */
        left: 0;
        width: 250px; /* Largura do menu */
        height: calc(100vh - 50px);
        z-index: 20;
        padding: var(--pad);
        transform: translateX(-100%); /* Inicialmente oculto fora da tela */
        transition: transform 0.3s ease-in-out;
        box-shadow: 4px 0 12px rgba(0,0,0,0.3);
        background: var(--card); /* Fundo sólido */
        margin: 0; /* Remove margem */
        border-radius: 0; /* Remove cantos arredondados na lateral */
        overflow-y: auto; /* Scroll dentro do menu, se necessário */
      }
      #sidebar.active {
        transform: translateX(0);
      }
      #menu {
        display: block; 
        gap: 0;
        padding: 0;
      }
      nav .nav-item {
        flex: none;
        text-align: left;
        justify-content: flex-start;
        padding: 12px 10px;
        min-width: unset;
      }
      
      /* Dashboard counters em coluna */
      #dashboard .row { flex-direction: column; gap: 10px; }
      #dashboard .row .card { width: 100%; }

      /* Ajuste para botões e inputs em linhas */
      /* MELHORIA MOBILE: Força o empilhamento vertical para formulários em linha */
      .row:not(#dashboard .row) { 
        flex-direction: column; 
        flex-wrap: nowrap; /* Não quebra, apenas empilha */
        gap: 8px; /* Ajusta o espaçamento */
      }
      .row .input, .row select, .row button { 
        min-width: 100%; 
        flex-grow: 1; 
        width: 100% !important; /* Garante que os inputs ocupem a largura total */
      }
      /* FIM MELHORIA MOBILE */

      
      /* Turmas/Materiais em coluna */
      #materials .row { flex-direction: column; gap: 15px; }
      #materials .row > div { width: 100%; }

      /* QR Gallery ajuste */
      #qrGallery { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
      
      /* Alunos - botões em coluna */
      .student-card > div:last-child {
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      .student-card button { padding: 6px 10px; font-size: 12px; }

      /* Ajustes específicos para o modal de checklist em mobile */
      .checklist-modal-box {
          width: 95vw !important;
          max-height: 95vh !important; 
          padding: 0 !important; 
      }
      .checklist-item-details { max-width: 100%; }
      .checklist-item-controls { justify-content: space-between; gap: 8px; width: 100%; }
      .checklist-item { flex-direction: column; align-items: flex-start; gap: 8px; }
      #checklist-list-area { padding: 12px; flex-shrink: 1; } /* Garantindo o flex-shrink para que os outros elementos fixos possam aparecer */
      #signature-area { padding: 12px; flex-shrink: 0; }
    }
  </style>
</head>
<body>

<header>
  <div class="left-controls" style="display:flex; align-items:center;">
    <button id="menuToggle" class="btn secondary">
      ☰
    </button>
    <h1>Controle de Material Escolar</h1>
  </div>
  
  <div class="right">
    <div id="userEmail" class="small" style="font-weight: 500;"></div>
    <button id="btnLogout" class="btn secondary" style="display:none; padding: 6px 10px;">Sair</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card" id="sidebar">
      <div class="section-title" style="margin-bottom: 10px;">Menu de Navegação</div>
      <nav id="menu">
        <div class="nav-item active" data-tab="dashboard">Dashboard</div>
        <div class="nav-item" data-tab="import">Importar Lista</div>
        <div class="nav-item" data-tab="materials">Materiais</div>
        <div class="nav-item" data-tab="students">Alunos</div>
        <div class="nav-item" data-tab="qrs">Gerar QR</div>
        <div class="nav-item" data-tab="reports">Relatórios</div>
        <div class="nav-item" data-tab="help">Ajuda</div>
      </nav>
      <hr style="margin:16px 0 10px;border:none;border-top:1px solid #f1f5f9"/>
      <div class="small">Dica: faça login com uma conta administrativa antes de salvar dados.</div>
    </div>

    <div class="card" id="main" style="grid-column: 2 / -1;"> 
      <div id="loginPanel">
        <h2 class="section-title">Login administrativo</h2>
        <div class="small">Use Email / Senha (autenticação Firebase)</div>
        <div style="height:12px"></div>
        <input id="loginEmail" class="input" placeholder="email@escola.com"/>
        <div style="height:8px"></div>
        <input id="conferenteName" class="input" placeholder="Nome Completo do Conferente (Você)" value=""/>
        <div style="height:8px"></div>
        <input id="loginPass" class="input" type="password" placeholder="Senha"/>
        <div style="height:12px"></div>
        <div class="row">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnSignup" class="btn secondary">Criar conta (teste)</button>
        </div>
        <div style="height:12px"></div>
        <div id="loginMsg" class="small" style="color:var(--danger)"></div>
        <div style="height:12px"></div>
        <div id="libStatus" class="hint small">Verificando bibliotecas...</div>
      </div>

      <div id="appContent" style="display:none">
        <div id="dashboard" class="tab">
          <h2 class="section-title">Dashboard</h2>
          <div class="row" style="gap:14px; margin-bottom: 25px; flex-direction: row !important; flex-wrap: wrap;">
            <div style="flex:1" class="card">
              <div class="small">Turmas cadastradas</div>
              <div id="countClasses" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Alunos cadastrados</div>
              <div id="countStudents" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Materiais totais</div>
              <div id="countMaterials" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
          </div>

          <h3 class="section-title" style="border-top: 1px solid #eee; padding-top:15px; margin-top: 0;">Status de Entrega por Segmento</h3>
          <div id="classStatusGrid" style="display:grid; grid-template-columns: 1fr; gap:20px;">
            <div class="small" style="grid-column: 1 / -1;">Carregando status das turmas...</div>
          </div>
        </div>

        <div id="import" class="tab" style="display:none">
          <h2 class="section-title">Importar Lista de Materiais (Texto)</h2>
          <div class="small">Cole abaixo o texto da lista de materiais copiado diretamente do PDF. O sistema tentará extrair a quantidade e o nome do item.</div>
          <div style="height:12px"></div>
          <textarea id="materialText" class="input" rows="10" placeholder="Cole a lista de materiais aqui, uma linha por item (se possível) ou o texto bruto do PDF. Ex: 1 Caderno Universitário, 4 Lápis, etc."></textarea>
          <div style="height:12px"></div>
          <button id="btnParseText" class="btn">Processar Texto</button>
          <div style="height:20px"></div>
          
          <h3 class="section-title" style="font-size: 16px;">Salvar materiais na Turma</h3>
          <div class="row">
            <select id="targetClass" class="input">
              <option value="">Escolha uma turma (ou crie abaixo)</option>
            </select>
            <button id="btnNewClass" class="btn secondary">Nova Turma</button>
          </div>
          <div style="height:8px"></div>
          <div id="newClassRow" style="display:none" class="row">
            <input id="newClassName" class="input" placeholder="Nome da turma (ex: 2ª Série Ensino Médio)"/>
            <select id="newClassSegment" class="input" style="width:200px;">
                <option value="">Selecione o Segmento</option>
                <option value="infantil">Educação Infantil</option>
                <option value="fund1">Fundamental I</option>
                <option value="fund2">Fundamental II</option>
                <option value="medio">Ensino Médio</option>
                <option value="other">Outros</option>
            </select>
            <button id="saveNewClass" class="btn">Criar</button>
          </div>

          <div style="height:16px"></div>
          <div class="card materials-list" id="parsedMaterials">
            <div class="small">Cole o texto acima e clique em "Processar Texto".</div>
          </div>
          <div style="height:12px"></div>
          <div class="row" style="justify-content: flex-end;">
            <button id="btnClearParsed" class="btn secondary">Limpar Lista</button>
            <button id="btnSaveMaterials" class="btn">Salvar materiais na turma</button>
          </div>
        </div>

        <div id="materials" class="tab" style="display:none">
          <h2 class="section-title">Materiais & Turmas</h2>
          <div class="row" style="gap:20px; align-items: flex-start;">
            <div style="flex:1" class="card">
              <div class="section-title" style="font-size: 16px;">Turmas Cadastradas</div>
              <div id="classesList" style="margin-top:8px"></div>
            </div>
            <div style="flex:2" class="card">
              <div class="section-title" style="font-size: 16px;">Materiais da Turma Selecionada</div>
              <div id="materialsOfClass" style="margin-top:8px">
                <div class="small">Clique em "Abrir" em uma turma ao lado.</div>
              </div>
            </div>
          </div>
        </div>

        <div id="students" class="tab" style="display:none">
          <h2 class="section-title">Alunos</h2>
          <div class="small">Use o filtro abaixo para visualizar alunos por turma ou adicione um novo aluno.</div>
          <div style="height:12px"></div>

          <div class="row" style="margin-bottom: 12px;">
            <select id="studentsFilterClass" class="input" style="flex:1;">
              <option value="">Mostrar Todos os Alunos (Filtro)</option>
            </select>
          </div>

          <div class="row" style="align-items: flex-end;">
            <input id="studentName" class="input" placeholder="Nome do aluno"/>
            <select id="studentClass" class="input" style="width:220px; min-width: 150px;">
              <option value="">Escolha a turma (Novo Aluno)</option>
            </select>
            <input id="studentIdInput" class="input" placeholder="Matricula / Nº" style="width:140px; min-width: 100px;"/>
            <button id="btnAddStudent" class="btn" style="min-width: 100px;">Adicionar</button>
          </div>
          <div style="height:16px"></div>
          <div id="studentsList" class="flex-col"></div>
        </div>

        <div id="qrs" class="tab" style="display:none">
          <h2 class="section-title">Gerar QR para sacolas</h2>
          <div class="small">Selecione uma turma e gere QR para cada aluno (downloadable). Este QR abre o **Documento Simplificado** (para conferência) diretamente ao ser escaneado.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="qrClassSelect" class="input"></select>
            <button id="btnGenerateQRs" class="btn" style="min-width: 120px;">Gerar QRs</button>
          </div>
          <div style="height:20px"></div>
          <div id="qrGallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px"></div>
        </div>

        <div id="reports" class="tab" style="display:none">
          <h2 class="section-title">Relatórios</h2>
          <div class="small">Relatório rápido: contagem total de itens que faltam por aluno na turma selecionada.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="reportClass" class="input"></select>
            <button id="btnRunReport" class="btn" style="min-width: 120px;">Gerar relatório</button>
          </div>
          <div id="reportArea" style="margin-top:20px" class="flex-col"></div>
        </div>

        <div id="help" class="tab" style="display:none">
          <h2 class="section-title">Ajuda e Regras do Firebase</h2>
          <div class="small">Se o console exibir "Missing or insufficient permissions", veja abaixo as regras mínimas para testes (apenas para ambiente de desenvolvimento).</div>
          <div style="height:10px"></div>
          <div class="hint small">Cole este snippet nas Regras do Firestore (Console Firebase → Firestore → Regras) para testes locais:</div>
          <pre class="rules">
// Regras de exemplo PARA DESENVOLVIMENTO (NÃO USAR EM PRODUÇÃO sem ajuste)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null; // permite a usuários autenticados
    }
  }
}
          </pre>
          <div style="height:8px"></div>
          <div class="small">Se você quiser acesso público apenas para leitura (temporário), substitua a linha por: <code>if true</code> — mas isso torna seus dados públicos.</div>
        </div>

      </div>
    </div>
  </div>
</div> <footer id="main-footer">
    <div class="footer-content">
        <p>&copy; Todos os direitos reservados.</p>
        <p class="small-text">Desenvolvido por Nay Cordeiro - Escola Traços & Letras 2026.</p>
    </div>
</footer>

<div id="menuOverlay"></div>

<div id="checklist-modal" style="display:none;">
    <div class="checklist-modal-box">
        </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<script>
/* ============================
   CONFIGURAÇÃO DO FIREBASE
   Substitua com sua config.
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDNpnxlyLEu6OqP_fN3SRtWpSRvZFkuAXI",
  authDomain: "materialescolar-126da.firebaseapp.com",
  projectId: "materialescolar-126da",
  storageBucket: "materialescolar-126da.firebasestorage.app",
  messagingSenderId: "498322809036",
  appId: "1:498322809036:web:ee71b80840ee8dc2676269"
};

/* ---------------------------
   Verificações de biblioteca
   --------------------------- */
function setLibStatus(msg,isError){
  const el = document.getElementById('libStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
  el.style.background = isError ? 'var(--danger-light)' : 'var(--accent-light)';
  el.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
}

(function checkLibs(){
  const missing = [];
  if(typeof firebase === 'undefined') missing.push('Firebase');
  if(typeof QRCode === 'undefined') missing.push('QRCode');
  if(typeof SignaturePad === 'undefined') missing.push('SignaturePad');
  
  if(missing.length){
    setLibStatus('Atenção: bibliotecas faltando: ' + missing.join(', ') + '. Verifique conexão com CDNs.', true);
  } else {
    setLibStatus('Bibliotecas carregadas corretamente.');
  }
})();

/* ---------------------------
   Inicialização Firebase (apenas se carregou)
   --------------------------- */
let auth = null, db = null, storage = null;
try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
} catch(e){
  console.error('Erro inicializar Firebase:', e);
  setLibStatus('Erro ao inicializar Firebase. Veja console.', true);
}

/* ---------------------------
   Util / UI helpers
   --------------------------- */
function $(id){ return document.getElementById(id); }

/* Lógica do Menu Hambúrguer */
const sidebar = $('sidebar');
const menuToggle = $('menuToggle');
const menuOverlay = $('menuOverlay') || (function() {
    const el = document.createElement('div');
    el.id = 'menuOverlay';
    document.body.appendChild(el);
    return el;
})();

/**
 * Alterna a visibilidade do menu lateral (sidebar) e do overlay.
 * @param {boolean | null} force - Força o estado (true para abrir, false para fechar).
 */
function toggleMenu(force = null) {
    // Detecta se estamos em modo mobile (media query de 992px)
    const isMobileView = window.innerWidth <= 992;
    if (!isMobileView && force === null) return; // Não faz nada se for desktop e não for forçado
    
    const isVisible = force !== null ? force : !sidebar.classList.contains('active');
    
    if (isVisible) {
        sidebar.classList.add('active');
        menuOverlay.classList.add('visible');
        document.body.style.overflow = 'hidden'; // Evita scroll do conteúdo principal
    } else {
        sidebar.classList.remove('active');
        menuOverlay.classList.remove('visible');
        document.body.style.overflow = '';
    }
}

// Adiciona listeners para o toggle e para o overlay
if(menuToggle) menuToggle.addEventListener('click', () => toggleMenu());
if(menuOverlay) menuOverlay.addEventListener('click', () => toggleMenu(false));


function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.querySelectorAll('#menu .nav-item').forEach(i=>i.classList.remove('active'));
  $('loginPanel').style.display = auth && auth.currentUser ? 'none' : '';
  if(!auth || !auth.currentUser){
    $('appContent').style.display='none';
    return;
  }
  $('appContent').style.display='';
  const tab = $(name);
  if(tab) tab.style.display='';
  const menuItem = document.querySelector('#menu .nav-item[data-tab="'+name+'"]');
  if(menuItem) menuItem.classList.add('active');

  // FECHA o menu hambúrguer após a navegação em mobile
  if(window.innerWidth <= 992) {
      toggleMenu(false);
  }
}
document.querySelectorAll('#menu .nav-item').forEach(it=>{
  it.addEventListener('click', ()=> showTab(it.dataset.tab));
});

/* ---------------------------
   GERADOR DE URL QR CODE PARA CHECKLIST/IMPRESSÃO
   --------------------------- */
/**
 * Constrói a URL para escanear o QR Code de um aluno, definindo o modo de visualização.
 * O modo 'print' abre o documento simplificado (para impressão/visualização rápida), 
 * 'checklist' abre o modal completo (padrão para conferência).
 * * @param {string} studentId - O ID do documento do aluno no Firestore.
 * @param {'checklist' | 'print'} [mode='checklist'] - O modo de abertura do documento.
 * @returns {string} A URL completa com parâmetros.
 */
function getStudentQRUrl(studentId, mode = 'checklist') { 
    // Usando window.location.origin e pathname garante que funcione em diferentes ambientes (local ou hospedado)
    return window.location.origin + window.location.pathname + '?studentId=' + studentId + '&mode=' + mode;
}

/* ---------------------------
   AUTH (Email/Password) & INITIAL LOAD
   --------------------------- */

// NOVIDADE: Função helper para obter o nome do conferente atual
function getCurrentClerkName() {
    // 1. Tenta pegar do input/localStorage
    const inputName = $('conferenteName') ? $('conferenteName').value.trim() : null;
    let name = inputName || localStorage.getItem('conferenteName');
    
    // 2. Fallback: Se estiver logado e não houver nome, usa a parte do email antes do '@' (melhor que nada)
    if (!name && auth && auth.currentUser && auth.currentUser.email) {
        name = auth.currentUser.email.split('@')[0];
    }
    
    // 3. Fallback final
    return name || 'Conferente Desconhecido';
}

// NOVIDADE: Puxa o nome do localStorage ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
    const conferenteNameInput = $('conferenteName');
    if (conferenteNameInput) {
        const storedName = localStorage.getItem('conferenteName');
        if (storedName) {
            conferenteNameInput.value = storedName;
        }
    }
});


if(auth){
  auth.onAuthStateChanged(user => {
    if(user){
      $('userEmail').textContent = user.email;
      $('btnLogout').style.display='';
      $('loginPanel').style.display='none';
      $('appContent').style.display='';
      
      // Carrega dados e mostra dashboard
      initialLoad();

    } else {
      $('userEmail').textContent = '';
      $('btnLogout').style.display='none';
      $('loginPanel').style.display='';
      $('appContent').style.display='none';
      showTab('dashboard'); // Volta para a tela de login
    }
  });

  $('btnLogout').addEventListener('click', async ()=>{
    try{
      await auth.signOut();
    }catch(err){
      alert('Erro ao sair: ' + err.message);
    }
  });
}

const SEGMENTS_MAP = {
    infantil: 'Ed. Infantil',
    fund1: 'Fundamental I',
    fund2: 'Fundamental II',
    medio: 'Ensino Médio',
    other: 'Outros'
};

async function initialLoad(){
    try {
        await Promise.all([
            loadClassesSelects(), // Preenche os selects em todas as abas
            loadClassesList(),    // Preenche a lista da aba Materiais
            loadStudentsList(null), // Carrega todos os alunos
            loadDashboardData(null)
        ]);
    } catch(e) {
        console.warn('Erro durante o carregamento inicial de dados após login:', e);
    }
    
    // --- FLUXO PARA SCANNER/CÂMERA ---
    const params = new URLSearchParams(window.location.search);
    const scannedStudentId = params.get('studentId');
    const scannedMode = params.get('mode');

    if (scannedStudentId) {
        // 1. Abre o documento para impressão (se for modo 'print') ou o modal de conferência (padrão/fallback).
        if (scannedMode === 'print') {
            generatePrintableChecklist(scannedStudentId);
        } else {
            openStudent(scannedStudentId);
        }
        
        // 2. Remove o parâmetro da barra de URL após a ação (evita loops)
        if (typeof history.replaceState === 'function') {
            history.replaceState(null, '', window.location.pathname);
        }
    }

    showTab('dashboard');
}

if(auth){
  $('btnLogin').addEventListener('click', async ()=>{
    const e = $('loginEmail').value.trim();
    const p = $('loginPass').value;
    const n = $('conferenteName').value.trim(); // Pega o nome do conferente

    if (!n) {
        $('loginMsg').textContent = 'Erro: Preencha o Nome Completo do Conferente.';
        return;
    }
    localStorage.setItem('conferenteName', n); // Salva o nome no local storage

    try{
      await auth.signInWithEmailAndPassword(e,p);
      $('loginMsg').textContent='';
    }catch(err){
      $('loginMsg').textContent = err.message || 'Erro ao logar';
    }
  });

  $('btnSignup').addEventListener('click', async ()=>{
    const e = $('loginEmail').value.trim();
    const p = $('loginPass').value;
    const n = $('conferenteName').value.trim(); // Pega o nome do conferente

    if (!n) {
        $('loginMsg').textContent = 'Erro: Preencha o Nome Completo do Conferente.';
        return;
    }
    localStorage.setItem('conferenteName', n); // Salva o nome no local storage
    
    try{
      await auth.createUserWithEmailAndPassword(e,p);
      $('loginMsg').textContent='Conta criada com sucesso! Faça login.';
    }catch(err){
      $('loginMsg').textContent = err.message || 'Erro ao criar conta';
    }
  });
}

/* ---------------------------
   DASHBOARD
   --------------------------- */

/**
 * Verifica se um aluno tem todos os materiais entregues.
 * @param {string} studentId O ID do documento do aluno.
 * @returns {Promise<{studentId: string, classId: string, isComplete: boolean}>}
 */
async function checkStudentFullDelivery(studentId) {
    const studentDoc = await db.collection('students').doc(studentId).get();
    if (!studentDoc.exists) return { studentId, classId: null, isComplete: false };
    const s = studentDoc.data();
    const classId = s.classId;

    if (!classId) return { studentId, classId, isComplete: false };

    // 1. Materiais Requeridos
    const materialsSnap = await db.collection('materials').where('classId', '==', classId).get();
    const materialsRequired = {};
    materialsSnap.forEach(m => materialsRequired[m.id] = m.data().quantity || 1);

    if (Object.keys(materialsRequired).length === 0) {
        // Se a turma não tem materiais cadastrados, consideramos "completo" para fins de contagem
        return { studentId, classId, isComplete: true };
    }

    // 2. Entregas Registradas
    const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentId).get();
    const materialsDelivered = {};
    deliveriesSnap.forEach(d => materialsDelivered[d.data().materialId] = d.data().quantityDelivered || 0);

    // 3. Comparação
    let isComplete = true;
    for (const matId in materialsRequired) {
        const required = materialsRequired[matId];
        const delivered = materialsDelivered[matId] || 0;
        if (delivered < required) {
            isComplete = false;
            break;
        }
    }

    return { studentId, classId, isComplete };
}


async function loadDashboardData(){
  if(!db) return;
  try{
    const [classesSnap, studentsSnap, materialsSnap] = await Promise.all([
      db.collection('classes').get(),
      db.collection('students').get(),
      db.collection('materials').get(),
    ]);

    // 1. Contadores
    const classesCount = classesSnap.size;
    const studentsCount = studentsSnap.size;
    const materialsCount = materialsSnap.size;

    $('countClasses').textContent = classesCount;
    $('countStudents').textContent = studentsCount;
    $('countMaterials').textContent = materialsCount;

    // 2. Status de Entrega por Segmento/Turma
    const classesData = {};
    classesSnap.forEach(doc => {
        classesData[doc.id] = { ...doc.data(), id: doc.id, totalStudents: 0, fullDeliveryStudents: 0 };
    });

    const studentPromises = [];
    studentsSnap.forEach(sDoc => {
        const s = sDoc.data();
        if (s.classId && classesData[s.classId]) {
            classesData[s.classId].totalStudents++;
            // Promessa para calcular se o aluno está completo
            studentPromises.push(checkStudentFullDelivery(sDoc.id));
        }
    });
    
    const studentDeliveryStatus = await Promise.all(studentPromises);
    studentDeliveryStatus.forEach(status => {
        if (status.isComplete && classesData[status.classId]) {
            classesData[status.classId].fullDeliveryStudents++;
        }
    });

    // 3. Agrupamento por Segmento
    const segmentsStatus = {};
    Object.values(classesData).forEach(c => {
        const segment = c.segment || 'other';
        if (!segmentsStatus[segment]) {
            segmentsStatus[segment] = { 
                name: SEGMENTS_MAP[segment] || 'Outros', 
                totalStudents: 0, 
                fullDeliveryStudents: 0, 
                classes: [] 
            };
        }
        segmentsStatus[segment].totalStudents += c.totalStudents;
        segmentsStatus[segment].fullDeliveryStudents += c.fullDeliveryStudents;
        segmentsStatus[segment].classes.push(c);
    });

    const grid = $('classStatusGrid');
    grid.innerHTML = '';
    
    const sortedSegments = Object.values(segmentsStatus).sort((a, b) => (a.name).localeCompare(b.name));

    sortedSegments.forEach(seg => {
        const segmentPercentage = seg.totalStudents > 0 ? Math.round((seg.fullDeliveryStudents / seg.totalStudents) * 100) : 0;
        const segmentColor = segmentPercentage === 100 ? 'var(--success)' : 'var(--danger)';
        
        let segmentHtml = `
            <div class="card group-card">
                <div style="padding: 16px; border-bottom: 1px solid var(--border-color);">
                    <div style="font-weight:700; font-size: 18px; color: ${segmentColor};">${seg.name}</div>
                    <div class="small" style="margin-top: 4px;">${seg.fullDeliveryStudents} / ${seg.totalStudents} alunos com 100% dos materiais</div>
                    <div style="font-size:24px; font-weight:700; color:${segmentColor}; margin-top: 8px;">${segmentPercentage}%</div>
                </div>
                <div style="padding: 16px; display:flex; flex-direction:column; gap:8px;">
        `;

        seg.classes.sort((a,b)=> (a.name).localeCompare(b.name)).forEach(c => {
            const classPercentage = c.totalStudents > 0 ? Math.round((c.fullDeliveryStudents / c.totalStudents) * 100) : 0;
            const classColor = classPercentage === 100 ? 'var(--success)' : (classPercentage > 0 ? 'var(--warning)' : 'var(--danger)');
            
            segmentHtml += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding: 6px 0;">
                    <div style="font-size:14px;">${c.name}</div>
                    <div style="font-weight:600; color:${classColor};">${classPercentage}% (${c.fullDeliveryStudents}/${c.totalStudents})</div>
                </div>
            `;
        });

        segmentHtml += `
                </div>
            </div>
        `;
        grid.innerHTML += segmentHtml;
    });

    if(sortedSegments.length === 0) {
        grid.innerHTML = '<div class="small" style="grid-column: 1 / -1;">Nenhuma turma encontrada. Cadastre uma turma na aba "Importar Lista".</div>';
    } else {
        // Redefine o layout da grid para 2 colunas no desktop (se mais de 2 segmentos)
        if (sortedSegments.length >= 2) {
             grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))';
        } else {
             grid.style.gridTemplateColumns = '1fr';
        }
    }


  }catch(err){
    console.error('Erro loadDashboardData', err);
    $('classStatusGrid').innerHTML = '<div class="small" style="color:var(--danger)">Erro ao carregar dados do dashboard.</div>';
  }
}

/* ---------------------------
   IMPORTAR LISTA
   --------------------------- */

$('btnParseText').addEventListener('click', function(){
    const text = $('materialText').value;
    const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
    
    const materials = [];
    const materialRegex = /^(\d+)\s*x?\s*([^\d].*)/i; // Ex: 10 Lápis | 10x Lápis
    
    lines.forEach(line => {
        const match = line.match(materialRegex);
        if (match) {
            let quantity = parseInt(match[1].trim(), 10);
            let name = match[2].trim().replace(/[,.:]$/, ''); // Remove pontuação no final
            
            if(name.length > 5 && quantity > 0) { // Filtro mínimo
                materials.push({ name, quantity });
            }

        } else {
            // Tenta o caso onde a quantidade está no final (menos comum)
            const reverseRegex = /^(.*)\s+x?\s*(\d+)$/i;
            const reverseMatch = line.match(reverseRegex);
            if (reverseMatch) {
                let quantity = parseInt(reverseMatch[2].trim(), 10);
                let name = reverseMatch[1].trim().replace(/[,.:]$/, '');
                if(name.length > 5 && quantity > 0) {
                    materials.push({ name, quantity });
                }
            } else {
                // Caso 3: apenas nome, assume 1
                const cleanedLine = line.trim().replace(/[,.:]$/, '');
                if(cleanedLine.length > 5) {
                    materials.push({ name: cleanedLine, quantity: 1 });
                }
            }
        }
    });

    // Filtra duplicatas e consolida quantidades
    const consolidated = materials.reduce((acc, item) => {
        const existing = acc.find(a => a.name.toLowerCase() === item.name.toLowerCase());
        if (existing) {
            existing.quantity += item.quantity;
        } else {
            acc.push(item);
        }
        return acc;
    }, []);


    // Renderiza
    const list = $('parsedMaterials');
    if(consolidated.length === 0) {
        list.innerHTML = '<div class="small" style="color:var(--danger)">Não foi possível extrair materiais. Tente formatar a lista com "Quantidade Nome" (ex: 2 Caderno).</div>';
        $('btnSaveMaterials').disabled = true;
        return;
    }

    list.innerHTML = consolidated.map(m => 
        `<div class="material-item">
            <div>
                <strong>${m.name}</strong> 
                <div class="small">Quantidade: ${m.quantity}</div>
            </div>
            <div style="display:flex;gap:6px">
                <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="editParsedMaterial(this, '${m.name.replace(/'/g, "\\'")}', ${m.quantity})">Editar</button>
                <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="removeParsedMaterial(this)">Remover</button>
            </div>
        </div>`
    ).join('');

    // Salva os dados consolidados no elemento para acesso posterior
    list.dataset.materials = JSON.stringify(consolidated);
    $('btnSaveMaterials').disabled = false;
});

function editParsedMaterial(button, currentName, currentQuantity) {
    const newQty = prompt(`Editar Quantidade Requerida de "${currentName}" (Atual: ${currentQuantity}):`);
    if (newQty === null || isNaN(parseInt(newQty, 10)) || parseInt(newQty, 10) < 1) {
        if (newQty !== null) alert('Quantidade inválida.');
        return;
    }
    
    const newQuantity = parseInt(newQty, 10);
    const itemEl = button.closest('.material-item');
    
    // Atualiza o display
    itemEl.querySelector('.small').textContent = `Quantidade: ${newQuantity}`;

    // Atualiza o JSON salvo no DOM
    const list = $('parsedMaterials');
    let materials = JSON.parse(list.dataset.materials || '[]');
    const materialToUpdate = materials.find(m => m.name === currentName && m.quantity === currentQuantity);
    
    if (materialToUpdate) {
        materialToUpdate.quantity = newQuantity;
        list.dataset.materials = JSON.stringify(materials);
    }
}

function removeParsedMaterial(button) {
    const itemEl = button.closest('.material-item');
    const name = itemEl.querySelector('strong').textContent;
    
    if (!confirm(`Remover "${name}" da lista?`)) return;
    
    // Simplesmente remove do DOM. O JSON salvo só será usado se o usuário não fizer mais edições.
    itemEl.remove();
    
    // Melhoria: Reconstruir o JSON a partir dos itens restantes (opcional, mas mais robusto)
    const list = $('parsedMaterials');
    const remainingItems = Array.from(list.querySelectorAll('.material-item')).map(el => {
        const name = el.querySelector('strong').textContent.trim();
        const qtyText = el.querySelector('.small').textContent.replace('Quantidade: ', '').trim();
        return { name, quantity: parseInt(qtyText, 10) };
    });
    
    list.dataset.materials = JSON.stringify(remainingItems);
    
    if(remainingItems.length === 0) {
        list.innerHTML = '<div class="small" style="color:var(--muted)">Lista limpa. Cole o texto acima e clique em "Processar Texto".</div>';
        $('btnSaveMaterials').disabled = true;
    }
}


// Nova Turma (Importar Lista)
$('btnNewClass').addEventListener('click', ()=>{
    const row = $('newClassRow');
    const btn = $('btnNewClass');
    const isVisible = row.style.display !== 'none';
    row.style.display = isVisible ? 'none' : 'flex';
    btn.textContent = isVisible ? 'Nova Turma' : 'Cancelar';
});

$('saveNewClass').addEventListener('click', async function(){
    if(!db) return;
    this.disabled = true;
    this.textContent = 'Criando...';
    
    const name = $('newClassName').value.trim();
    const segment = $('newClassSegment').value;

    if(!name || !segment) {
        alert('Preencha o nome da turma e selecione o segmento.');
        this.disabled = false;
        this.textContent = 'Criar';
        return;
    }
    
    try{
        const newClassRef = db.collection('classes').doc();
        await newClassRef.set({
            name,
            segment,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`Turma "${name}" criada com sucesso!`);
        $('newClassName').value = '';
        $('newClassSegment').value = '';
        $('newClassRow').style.display = 'none';
        $('btnNewClass').textContent = 'Nova Turma';
        
        await loadClassesSelects(); // Recarrega os selects
        $('targetClass').value = newClassRef.id; // Seleciona a nova turma
        
    }catch(err){
        console.error('Erro ao criar turma', err);
        alert('Erro ao criar turma: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Criar';
    }
});


$('btnSaveMaterials').addEventListener('click', async function(){
    if(!db) return;
    const classId = $('targetClass').value;
    const list = $('parsedMaterials');
    const materials = JSON.parse(list.dataset.materials || '[]');
    
    if(!classId) return alert('Selecione uma turma para salvar os materiais.');
    if(materials.length === 0) return alert('Nenhum material para salvar. Processe o texto primeiro.');
    
    this.disabled = true;
    this.textContent = 'Salvando...';

    try{
        const batch = db.batch();
        
        materials.forEach(m => {
            // Para um sistema mais robusto, seria bom verificar se o (name + classId) já existe.
            const newMaterialRef = db.collection('materials').doc();
            batch.set(newMaterialRef, {
                name: m.name,
                quantity: m.quantity,
                classId: classId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        await batch.commit();
        alert(`Sucesso! ${materials.length} materiais salvos na turma.`);
        
        // Limpa a interface
        $('materialText').value = '';
        $('parsedMaterials').innerHTML = '<div class="small">Materiais salvos! Limpe a lista para continuar.</div>';
        $('btnSaveMaterials').disabled = true;

        loadDashboardData(); // Atualiza contadores

    }catch(err){
        console.error('Erro ao salvar materiais', err);
        alert('Erro ao salvar materiais: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Salvar materiais na turma';
    }
});

async function loadClassesSelects(){
    if(!db) return;
    const selects = [$('targetClass'), $('studentClass'), $('studentsFilterClass'), $('qrClassSelect'), $('reportClass')];
    
    try{
        const snap = await db.collection('classes').orderBy('name').get();
        const optionsHtml = ['<option value="">Escolha a turma</option>'];
        
        snap.forEach(d => {
            const c = d.data();
            optionsHtml.push(`<option value="${d.id}">${c.name} (${SEGMENTS_MAP[c.segment] || 'Outros'})</option>`);
        });

        selects.forEach(sel => {
            if(sel){
                const currentValue = sel.value;
                sel.innerHTML = optionsHtml.join('');
                
                // Para o filtro de alunos, a primeira opção é "Mostrar Todos"
                if(sel.id === 'studentsFilterClass') {
                    sel.innerHTML = '<option value="">Mostrar Todos os Alunos (Filtro)</option>' + optionsHtml.slice(1).join('');
                }
                
                // Tenta manter o valor selecionado
                if (currentValue && sel.querySelector(`option[value="${currentValue}"]`)) {
                    sel.value = currentValue;
                }
            }
        });
        
    }catch(err){
        console.error('Erro loadClassesSelects', err);
    }
}

if($('btnNewClass')) $('btnNewClass').addEventListener('click', ()=>{
    const row = $('newClassRow');
    const btn = $('btnNewClass');
    const isVisible = row.style.display !== 'none';
    row.style.display = isVisible ? 'none' : 'flex';
    btn.textContent = isVisible ? 'Nova Turma' : 'Cancelar';
});


/* ---------------------------
   MATERIAIS & TURMAS
   --------------------------- */

async function loadClassesList(){
    if(!db) return;
    const list = $('classesList');
    list.innerHTML = '';
    
    try {
        const snap = await db.collection('classes').orderBy('name').get();
        
        if(snap.empty){
            list.innerHTML = '<div class="small">Nenhuma turma cadastrada.</div>';
            return;
        }

        snap.forEach(d => {
            const c = d.data();
            const e = document.createElement('div');
            e.className = 'material-item'; // Reutilizando o estilo do item
            e.innerHTML = `
                <div>
                    <strong>${c.name}</strong>
                    <div class="small">${SEGMENTS_MAP[c.segment] || 'Segmento Desconhecido'}</div>
                </div>
                <div style="display:flex;gap:6px">
                    <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="loadMaterialsOfClass('${d.id}')">Abrir</button>
                    <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteClass('${d.id}', '${c.name.replace(/'/g, "\\'")}')">Apagar</button>
                </div>
            `;
            list.appendChild(e);
        });

    } catch(err) {
        console.error('Erro loadClassesList', err);
        list.innerHTML = '<div class="small" style="color:var(--danger)">Erro ao carregar turmas.</div>';
    }
}

async function deleteClass(classId, className) {
    if (!confirm(`Tem certeza que deseja apagar a turma "${className}" e TODOS os materiais/alunos/entregas vinculados a ela? Esta ação é irreversível!`)) {
        return;
    }
    
    try {
        // 1. Apagar Materiais
        const materialsSnap = await db.collection('materials').where('classId', '==', classId).get();
        const materialBatch = db.batch();
        materialsSnap.forEach(doc => materialBatch.delete(doc.ref));
        await materialBatch.commit();

        // 2. Apagar Alunos
        const studentsSnap = await db.collection('students').where('classId', '==', classId).get();
        const studentBatch = db.batch();
        studentsSnap.forEach(doc => studentBatch.delete(doc.ref));
        await studentBatch.commit();
        
        // 3. Apagar Entregas
        const deliveriesSnap = await db.collection('deliveries').where('classId', '==', classId).get();
        const deliveryBatch = db.batch();
        deliveriesSnap.forEach(doc => deliveryBatch.delete(doc.ref));
        await deliveryBatch.commit();

        // 4. Apagar a Turma
        await db.collection('classes').doc(classId).delete();

        alert(`Turma "${className}" e todos os dados vinculados apagados com sucesso.`);
        
        loadClassesList();
        loadClassesSelects();
        loadDashboardData();
        $('materialsOfClass').innerHTML = '<div class="small">Clique em "Abrir" em uma turma ao lado.</div>';

    } catch (err) {
        console.error('Erro ao apagar turma', err);
        alert('Erro ao apagar turma: ' + (err.message || err));
    }
}


async function loadMaterialsOfClass(classId){
    if(!db) return;
    const container = $('materialsOfClass');
    container.innerHTML = '<div>Carregando...</div>';
    
    try{
        const [snap, classDoc] = await Promise.all([
            db.collection('materials').where('classId', '==', classId).orderBy('name').get(),
            db.collection('classes').doc(classId).get()
        ]);
        
        const className = classDoc.exists ? classDoc.data().name : 'Turma Desconhecida';
        
        container.innerHTML = `<h3 class="section-title" style="margin-top: 0; font-size: 18px;">Materiais de: ${className}</h3>`;

        if(snap.empty){
            container.innerHTML += '<div class="small">Nenhum material cadastrado para esta turma.</div>';
            return;
        }

        const listHtml = snap.docs.map(d => {
            const m = d.data();
            return `
                <div class="material-item">
                    <div>
                        <strong>${m.name}</strong> 
                        <div class="small">Quantidade Requerida: ${m.quantity}</div>
                    </div>
                    <div style="display:flex;gap:6px">
                        <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="editMaterial('${d.id}', ${m.quantity})">Editar Qtd</button>
                        <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteMaterial('${d.id}', '${m.name.replace(/'/g, "\\'")}')">Apagar</button>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML += `<div class="list">${listHtml}</div>`;

    }catch(err){
        console.error('Erro loadMaterialsOfClass', err);
        container.innerHTML = `<div class="small" style="color:var(--danger)">Erro ao carregar materiais: ${err.message || err}</div>`;
    }
}

async function editMaterial(materialId, currentQuantity) {
    const newQty = prompt(`Editar Quantidade Requerida (Atual: ${currentQuantity}):`);
    
    if (newQty === null || isNaN(parseInt(newQty, 10)) || parseInt(newQty, 10) < 1) {
        if (newQty !== null) alert('Quantidade inválida. Mínimo é 1.');
        return;
    }
    
    try {
        await db.collection('materials').doc(materialId).update({ 
            quantity: parseInt(newQty, 10) 
        });
        alert('Quantidade atualizada com sucesso. Recarregue a aba de materiais.');
        // Recarrega a lista para refletir a mudança (precisa do classId, que não está aqui, então força o user a re-abrir)
        const currentClassId = document.querySelector('#materialsOfClass h3') ? document.querySelector('#materialsOfClass h3').id : null;
        if(currentClassId) loadMaterialsOfClass(currentClassId);

    } catch (err) {
        console.error('Erro ao editar material', err);
        alert('Erro ao editar material: ' + (err.message || err));
    }
}

async function deleteMaterial(materialId, materialName) {
    if (!confirm(`Tem certeza que deseja apagar o material "${materialName}"?`)) return;
    
    try {
        await db.collection('materials').doc(materialId).delete();
        alert(`Material "${materialName}" apagado.`);
        
        // Recarrega a lista
        const currentClassId = document.querySelector('#materialsOfClass h3') ? document.querySelector('#materialsOfClass h3').id : null;
        if(currentClassId) loadMaterialsOfClass(currentClassId);

    } catch (err) {
        console.error('Erro ao apagar material', err);
        alert('Erro ao apagar material: ' + (err.message || err));
    }
}

/* ---------------------------
   ALUNOS (STUDENTS)
   --------------------------- */

$('btnAddStudent').addEventListener('click', async function(){
    if(!db) return;
    
    const name = $('studentName').value.trim();
    const classId = $('studentClass').value;
    const studentIdInput = $('studentIdInput').value.trim();
    
    if(!name || !classId) return alert('Preencha o nome do aluno e escolha a turma.');
    
    this.disabled = true;
    this.textContent = 'Adicionando...';

    try{
        const newStudentRef = db.collection('students').doc();
        await newStudentRef.set({
            name,
            classId,
            studentId: studentIdInput || null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`Aluno "${name}" adicionado com sucesso.`);
        
        // Limpa a interface
        $('studentName').value = '';
        $('studentIdInput').value = '';

        loadStudentsList($('studentsFilterClass').value); // Recarrega a lista com o filtro atual
        loadDashboardData(); // Atualiza contadores

    }catch(err){
        console.error('Erro ao adicionar aluno', err);
        alert('Erro ao adicionar aluno: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Adicionar';
    }
});

$('studentsFilterClass').addEventListener('change', function(){
    loadStudentsList(this.value);
});


async function loadStudentsList(filterClassId = null){
    if(!db) return;
    const list = $('studentsList');
    list.innerHTML = '<div>Carregando...</div>';
    
    try{
        let query = db.collection('students').orderBy('name');
        if(filterClassId) query = query.where('classId', '==', filterClassId);
        
        const [snap, classesSnap] = await Promise.all([
            query.get(),
            db.collection('classes').get()
        ]);
        
        const classesMap = {};
        classesSnap.forEach(d => classesMap[d.id] = d.data().name);

        if(snap.empty){
            list.innerHTML = '<div class="small">Nenhum aluno encontrado.</div>';
            return;
        }
        
        // Promises para verificar o status de entrega de cada aluno
        const statusPromises = snap.docs.map(doc => checkStudentFullDelivery(doc.id));
        const studentsStatus = await Promise.all(statusPromises);
        const statusMap = studentsStatus.reduce((acc, status) => {
            acc[status.studentId] = status.isComplete;
            return acc;
        }, {});

        // Promises para buscar assinaturas
        const signaturePromises = snap.docs.map(doc => db.collection('signatures').doc(doc.id).get());
        const signatureSnaps = await Promise.all(signaturePromises);
        const signatureMap = signatureSnaps.reduce((acc, sigSnap) => {
            acc[sigSnap.id] = sigSnap.exists;
            return acc;
        }, {});


        list.innerHTML = '';
        snap.forEach(d => {
            const s = d.data();
            const studentId = d.id;
            const className = classesMap[s.classId] || 'Turma Desconhecida';
            const isComplete = statusMap[studentId] || false;
            const hasSignature = signatureMap[studentId] || false;

            const statusColor = isComplete ? 'var(--success)' : 'var(--danger)';
            const statusText = isComplete ? 'Completo' : 'Faltando Itens';
            const signatureIndicator = hasSignature 
                ? '<span style="color:var(--success); font-size: 10px; margin-left: 10px;">(Assinado)</span>' 
                : '<span style="color:var(--danger); font-size: 10px; margin-left: 10px;">(Sem Assinatura)</span>';

            const e = document.createElement('div');
            e.className = 'student-card';
            e.innerHTML = `
                <div>
                    <strong>${s.name}</strong> (${s.studentId || 'N/A'})
                    <div class="small">${className}</div>
                    <div class="small" style="font-weight: 600; color: ${statusColor}; margin-top: 4px;">Status: ${statusText}${signatureIndicator}</div>
                </div>
                <div style="display:flex;gap:8px; align-items:center;">
                    <button class="btn" style="padding: 6px 10px; font-size:12px;" onclick="openStudent('${studentId}')">Conferir</button>
                    <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="generatePrintableChecklist('${studentId}')">Imprimir Doc.</button>
                    <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteStudent('${studentId}', '${s.name.replace(/'/g, "\\'")}')">Apagar</button>
                </div>
            `;
            list.appendChild(e);
        });

    }catch(err){
        console.error('Erro loadStudentsList', err);
        list.innerHTML = '<div class="small" style="color:var(--danger)">Erro ao carregar lista de alunos.</div>';
    }
}


async function deleteStudent(studentDocId, studentName) {
    if (!confirm(`Tem certeza que deseja apagar o aluno "${studentName}" e todos os registros de entrega e assinatura vinculados? Esta ação é irreversível!`)) {
        return;
    }
    
    try {
        // 1. Apagar Entregas
        const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentDocId).get();
        const deliveryBatch = db.batch();
        deliveriesSnap.forEach(doc => deliveryBatch.delete(doc.ref));
        await deliveryBatch.commit();

        // 2. Apagar Assinatura (se existir)
        await db.collection('signatures').doc(studentDocId).delete();
        
        // 3. Apagar o Aluno
        await db.collection('students').doc(studentDocId).delete();

        alert(`Aluno "${studentName}" e dados vinculados apagados com sucesso.`);
        
        loadStudentsList($('studentsFilterClass').value);
        loadDashboardData();

    } catch (err) {
        console.error('Erro ao apagar aluno', err);
        alert('Erro ao apagar aluno: ' + (err.message || err));
    }
}


/* ---------------------------
   CHECKLIST (MODAL DE CONFERÊNCIA)
   --------------------------- */

let signaturePadInstance = null; // Instância global para o SignaturePad

/**
 * Salva a entrega de um material específico para um aluno.
 * @param {string} studentDocId - O ID do documento do aluno.
 * @param {string} materialId - O ID do documento do material.
 * @param {number} requiredQty - A quantidade requerida.
 * @param {number} newQty - A nova quantidade entregue.
 * @param {HTMLElement} inputEl - O elemento <input> da quantidade.
 * @param {HTMLElement} remainingEl - O elemento <span> da quantidade restante.
 * @returns {Promise<boolean>} True se salvou, false se deu erro.
 */
async function saveDelivery(studentDocId, materialId, requiredQty, newQty, inputEl, remainingEl, isBatch = false){
    if (!db) { alert('Firestore não inicializado.'); return false; }
    
    const delivered = Math.min(newQty, requiredQty);
    const missing = requiredQty - delivered;
    const clerkName = getCurrentClerkName();
    
    try{
        const classId = (await db.collection('students').doc(studentDocId).get()).data().classId;
        
        await db.collection('deliveries').doc(`${studentDocId}_${materialId}`).set({
            studentId: studentDocId,
            materialId: materialId,
            classId: classId,
            quantityRequired: requiredQty,
            quantityDelivered: delivered,
            missing: missing,
            clerkName: clerkName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Atualiza o display imediatamente, mesmo em batch
        inputEl.value = delivered;
        remainingEl.textContent = missing;
        remainingEl.style.color = missing > 0 ? 'var(--danger)' : 'var(--success)';

        if(!isBatch) {
            // Se não for parte de um batch, dá um feedback visual mais forte.
            loadDashboardData();
        }

        return true;

    } catch(e) {
        console.error('Erro ao salvar entrega:', e);
        if(!isBatch) alert('Erro ao salvar entrega: ' + (e.message || e));
        return false;
    }
}


/**
 * Abre o modal de conferência (checklist) para um aluno.
 * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function openStudent(studentDocId){
    if(!db) return alert('Firestore não inicializado.');
    
    // 1. Limpa e prepara o modal
    const modal = $('checklist-modal');
    const box = modal.querySelector('.checklist-modal-box');
    box.innerHTML = ''; // Limpa o conteúdo anterior
    
    // Destrói a instância anterior do SignaturePad se existir
    if (signaturePadInstance) {
        signaturePadInstance.off();
        signaturePadInstance = null;
    }
    
    // 2. Fetch de Dados
    const sdoc = await db.collection('students').doc(studentDocId).get();
    if(!sdoc.exists) return alert('Aluno não encontrado');
    const s = sdoc.data();

    // 2.1. Fetch Class Name
    let className = s.classId || 'Turma Desconhecida (ID: N/A)';
    if(s.classId){
        try{
            const classDoc = await db.collection('classes').doc(s.classId).get();
            if(classDoc.exists) className = classDoc.data().name;
            else className = `Turma Desconhecida (ID: ${s.classId})`;
        }catch(e){
            console.error('Erro ao buscar nome da turma:', e);
            className = `Erro ao buscar Turma (ID: ${s.classId})`;
        }
    }

    // 2.2. Fetch Materials & Deliveries
    const [matsnap, deliveriesSnap, signatureSnap] = await Promise.all([
        db.collection('materials').where('classId','==',s.classId).get(),
        db.collection('deliveries').where('studentId','==',studentDocId).get(),
        db.collection('signatures').doc(studentDocId).get()
    ]);
    
    const materialsArray = [];
    matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
    materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome

    const deliveredQuantities = {}; // Mapeia {materialId: {quantity: N, by: clerkName, timestamp: T}}
    deliveriesSnap.forEach(d => {
        const data = d.data();
        deliveredQuantities[data.materialId] = {
            quantity: data.quantityDelivered || 0,
            by: data.clerkName || 'Desconhecido',
            timestamp: data.timestamp
        };
    });
    
    const signatureData = signatureSnap.exists ? signatureSnap.data() : null;
    const hasExistingSignature = !!signatureData && !!signatureData.signatureUrl;
    const currentClerkName = getCurrentClerkName();

    // 3. Monta o Conteúdo

    // --- Header ---
    const header = document.createElement('div');
    header.style = 'padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;';
    header.innerHTML = `
        <div>
            <h3 class="section-title" style="margin: 0;">Checklist de Materiais</h3>
            <div class="small">Aluno: <strong>${s.name}</strong> (${s.studentId || 'N/A'}) - Turma: ${className}</div>
        </div>
        <button id="closeChecklist" class="btn secondary" style="padding: 6px 10px; font-size: 14px;">Fechar</button>
    `;
    box.appendChild(header);

    // --- List Area Header/Controls ---
    const listControls = document.createElement('div');
    listControls.style = 'padding: var(--pad); padding-bottom: 10px; border-bottom: 1px solid var(--border-color);';
    listControls.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4 class="section-title" style="font-size: 16px; margin: 0;">Itens da Lista</h4>
            <button id="markCompleteBtn" class="btn secondary" style="padding: 6px 10px; font-size: 13px;">Marcar Todos como Entregues</button>
        </div>
    `;
    box.appendChild(listControls);

    // --- List Area ---
    const listArea = document.createElement('div');
    listArea.id = 'checklist-list-area';
    
    if (materialsArray.length === 0) {
        listArea.innerHTML = '<div class="small" style="padding: 16px;">Nenhum material cadastrado para esta turma.</div>';
    } else {
        materialsArray.forEach(m => {
            const id = m.id;
            const required = m.quantity || 1;
            const deliveryInfo = deliveredQuantities[id] || { quantity: 0, by: 'N/A', timestamp: null };
            const delivered = deliveryInfo.quantity;
            const remaining = required - delivered;
            const remainingColor = remaining > 0 ? 'var(--danger)' : 'var(--success)';
            const lastUpdate = deliveryInfo.timestamp ? new Date(deliveryInfo.timestamp.toDate()).toLocaleString('pt-BR') : 'Nunca';

            const item = document.createElement('div');
            item.className = 'checklist-item';
            item.innerHTML = `
                <div class="checklist-item-details">
                    <strong style="font-size: 15px;">${m.name}</strong> 
                    <div class="small">Requerido: ${required} | Última Conf.: ${lastUpdate} (${deliveryInfo.by})</div>
                </div>
                <div class="checklist-item-controls">
                    <label class="small" style="font-weight: 500; min-width: 100px; text-align: right;">Entregue:</label>
                    <input type="number" 
                        min="0" 
                        max="${required}" 
                        value="${delivered}" 
                        data-required="${required}" 
                        data-matid="${id}"
                        class="input delivery-input"
                        style="width: 60px; text-align: center;" />
                    <label class="small" style="font-weight: 500; min-width: 100px; text-align: right;">Faltam: 
                        <span class="remaining-qty" style="color: ${remainingColor}; font-weight: 700;">${remaining}</span>
                    </label>
                    <button class="btn save-delivery-btn" style="padding: 6px 10px; font-size: 12px; min-width: 70px;">Salvar</button>
                </div>
            `;
            listArea.appendChild(item);
        });
    }
    box.appendChild(listArea);

    // --- Signature Area ---
    const signatureArea = document.createElement('div');
    signatureArea.id = 'signature-area';
    signatureArea.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;">
            <h4 class="section-title" style="font-size: 16px; margin: 0;">Assinatura do Responsável</h4>
            <button id="toggleSignatureBtn" class="btn secondary" style="padding: 6px 10px; font-size: 13px;">
                ${hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura'}
            </button>
        </div>

        <div id="signature-preview-container" style="display:${hasExistingSignature ? 'block' : 'none'};">
            <img id="signature-preview" src="${signatureData?.signatureUrl || ''}" alt="Assinatura prévia" />
            <div class="small" style="margin-bottom: 10px; color: var(--muted);">Assinatura: ${signatureData?.signerName || 'N/A'} - Conferente: ${signatureData?.clerkName || 'N/A'}</div>
            <div class="small" style="margin-bottom: 10px; color: var(--muted);">Salvo em: ${signatureData?.timestamp ? new Date(signatureData.timestamp.toDate()).toLocaleString('pt-BR') : 'N/A'}</div>
        </div>

        <div id="signature-content" style="display:${hasExistingSignature ? 'none' : 'block'};">
            <canvas id="signature-canvas"></canvas>
            <div class="row" style="margin-top: 5px;">
                <input id="signerName" class="input" placeholder="Nome Completo do Responsável" value="${s.signerName || ''}" ${hasExistingSignature ? 'disabled' : ''}/>
            </div>
            <div class="row" style="margin-top: 8px;">
                <button id="clearSignature" class="btn secondary" style="width: 100px;">Limpar</button>
                <button id="saveSignature" class="btn" style="flex:1;">Salvar Assinatura & Conferente</button>
            </div>
        </div>
        <div class="small" style="margin-top: 10px;">Conferente atual: <strong>${currentClerkName}</strong></div>
    `;
    box.appendChild(signatureArea);

    // --- 5. Exibe o modal ---
    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';

    // --- 6. Listeners do Modal ---
    $('closeChecklist').addEventListener('click', ()=>{
        modal.classList.remove('visible');
        document.body.style.overflow = '';
        loadStudentsList($('studentsFilterClass').value); // Recarrega a lista para atualizar o status de assinatura
    });

    // Toggle Assinatura
    const toggleBtn = $('toggleSignatureBtn');
    const signatureContent = $('signature-content');
    const previewContainer = $('signature-preview-container');

    // Se houver assinatura prévia, já exibe por padrão (configurado no innerHTML)
    if (hasExistingSignature) {
        signatureContent.style.display = 'none';
        previewContainer.style.display = 'block';
        toggleBtn.textContent = 'Ocultar Assinatura';
    }

    toggleBtn.addEventListener('click', function() {
        const isContentVisible = signatureContent.style.display === 'block';
        
        if(isContentVisible) {
            signatureContent.style.display = 'none';
            if(hasExistingSignature) previewContainer.style.display = 'block';
            this.textContent = hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura';
        } else {
            signatureContent.style.display = 'block';
            previewContainer.style.display = 'none';
            this.textContent = hasExistingSignature ? 'Ocultar Assinatura' : 'Ocultar';
        }

        // Inicializa o SignaturePad apenas se a área estiver sendo aberta e não houver instância
        if(!signaturePadInstance && signatureContent.style.display === 'block') {
             const canvas = $('signature-canvas');
             // Ajusta o canvas para caber no container (essencial para mobile)
             function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }
            resizeCanvas();
            window.onresize = resizeCanvas;
            
            signaturePadInstance = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            $('clearSignature').addEventListener('click', () => signaturePadInstance.clear());
            
            $('saveSignature').addEventListener('click', async function(){
                if(signaturePadInstance.isEmpty()) return alert('Por favor, colete a assinatura primeiro.');
                const signerName = $('signerName').value.trim();
                if(!signerName) return alert('Por favor, preencha o nome do responsável.');
                
                this.disabled = true;
                this.textContent = 'Salvando...';
                
                try{
                    // 1. Converte a assinatura para base64
                    const dataURL = signaturePadInstance.toDataURL('image/png');
                    
                    // 2. Salva a imagem no Storage (usando o ID do aluno como nome do arquivo)
                    const storageRef = storage.ref();
                    const signatureRef = storageRef.child(`signatures/${studentDocId}.png`);
                    
                    // Converte base64 para Blob para upload
                    const blob = await (await fetch(dataURL)).blob();
                    const snapshot = await signatureRef.put(blob);
                    const signatureUrl = await snapshot.ref.getDownloadURL();
                    
                    // 3. Salva a URL e metadados no Firestore
                    await db.collection('signatures').doc(studentDocId).set({
                        studentId: studentDocId,
                        signerName: signerName,
                        signatureUrl: signatureUrl,
                        clerkName: getCurrentClerkName(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 4. Atualiza o dado do aluno (signerName)
                    await db.collection('students').doc(studentDocId).update({ signerName: signerName });

                    alert('Assinatura salva com sucesso!');
                    this.textContent = 'Assinatura Salva';

                    // Desabilita a edição após salvar
                    signaturePadInstance.off();
                    $('signerName').disabled = true;
                    $('clearSignature').disabled = true;
                    this.disabled = true; 
                    
                } catch(e) {
                    console.error('Erro ao salvar assinatura:', e);
                    alert('Erro ao salvar assinatura: ' + (e.message || e));
                } finally {
                    // Se deu erro, reabilita o botão
                    if(this.textContent !== 'Assinatura Salva') {
                        this.disabled = false;
                        this.textContent = 'Salvar Assinatura & Conferente';
                    }
                }
            });
        }
    });

    // 7. Listeners para os itens de entrega
    listArea.querySelectorAll('.checklist-item').forEach(item => {
        const inputEl = item.querySelector('.delivery-input');
        const remainingEl = item.querySelector('.remaining-qty');
        const saveBtn = item.querySelector('.save-delivery-btn');
        const matId = inputEl.dataset.matid;
        const requiredQty = parseInt(inputEl.dataset.required, 10);

        // Listener para o input de mudança de valor
        inputEl.addEventListener('input', function() {
            const newQty = parseInt(this.value, 10);
            const delivered = Math.min(newQty, requiredQty);
            const remaining = requiredQty - delivered;
            
            remainingEl.textContent = remaining;
            remainingEl.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)';
        });

        // Listener para o botão Salvar
        saveBtn.addEventListener('click', async function(){
            this.disabled = true;
            this.textContent = '...';
            
            const newQty = parseInt(inputEl.value, 10);
            
            const success = await saveDelivery(studentDocId, matId, requiredQty, newQty, inputEl, remainingEl, false);
            
            this.disabled = false;
            this.textContent = 'Salvar';
            
            if (success) {
                // Feedback visual temporário de sucesso
                const originalBg = item.style.backgroundColor;
                item.style.backgroundColor = 'var(--success-light)';
                setTimeout(() => {
                    item.style.backgroundColor = originalBg;
                }, 300);
            }
        });
    });

    // 8. Listener para o botão "Marcar Todos"
    $('markCompleteBtn').addEventListener('click', async function(){
        if(!confirm('Tem certeza que deseja marcar TODOS os materiais como ENTREGUES (Qtd. Entregue = Qtd. Necessária)?')) return;
        
        this.disabled = true;
        this.textContent = 'Marcando...';

        try {
            const savePromises = [];
            listArea.querySelectorAll('.checklist-item').forEach(item => {
                const inputEl = item.querySelector('.delivery-input');
                const remainingEl = item.querySelector('.remaining-qty');
                const matId = inputEl.dataset.matid;
                const requiredQty = parseInt(inputEl.dataset.required, 10);
                
                // Força o valor do input para a quantidade requerida
                inputEl.value = requiredQty;

                // Salva (em batch, mas usando a função que atualiza o display)
                savePromises.push(saveDelivery(studentDocId, matId, requiredQty, requiredQty, inputEl, remainingEl, true));

                // Feedback visual imediato (sem esperar o save)
                item.style.backgroundColor = 'var(--success-light)';
                setTimeout(() => { item.style.backgroundColor = ''; }, 500);
            });

            await Promise.all(savePromises);
            
            loadDashboardData(); // Atualiza o dashboard após o batch

            this.textContent = 'Completo!';
            setTimeout(() => {
                this.textContent = 'Marcar Todos como Entregues';
                this.disabled = false;
            }, 1000);

        } catch(e) {
            console.error('Erro ao marcar todos:', e);
            alert('Erro ao marcar todos como entregues.');
            this.textContent = 'Marcar Todos como Entregues';
            this.disabled = false;
        }
    });

}

/* ---------------------------
   IMPRESSÃO SIMPLIFICADA (Para PDF/Etiqueta)
   --------------------------- */

/**
 * Gera o documento simplificado (sem interação) para impressão/visualização rápida.
 * * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function generatePrintableChecklist(studentDocId){
    if(!db) return alert('Firestore não inicializado');

    // 1. Fetch Student Info
    const sdoc = await db.collection('students').doc(studentDocId).get();
    if(!sdoc.exists) return alert('Aluno não encontrado');
    const s = sdoc.data();

    // NOVIDADE: 1.1. Fetch Class Name
    let className = s.classId || 'Turma Desconhecida (ID: N/A)';
    if(s.classId){
        try{
            const classDoc = await db.collection('classes').doc(s.classId).get();
            if(classDoc.exists) className = classDoc.data().name;
            else className = `Turma Desconhecida (ID: ${s.classId})`;
        }catch(e){
            console.error('Erro ao buscar nome da turma:', e);
            className = `Erro ao buscar Turma (ID: ${s.classId})`;
        }
    }

    // 2. Fetch Class Materials
    const matsnap = await db.collection('materials').where('classId','==',s.classId).get();
    
    // 3. Fetch Deliveries
    const deliveriesSnap = await db.collection('deliveries').where('studentId','==',studentDocId).get();
    const deliveredQuantities = {};
    deliveriesSnap.forEach(d=> deliveredQuantities[d.data().materialId] = d.data().quantityDelivered || 0);

    // 4. Fetch Signature
    const signatureSnap = await db.collection('signatures').doc(studentDocId).get();
    const signatureData = signatureSnap.exists ? signatureSnap.data() : null;
    const signatureImageHtml = signatureData?.signatureUrl 
        ? `<img class="signature-image" src="${signatureData.signatureUrl}" alt="Assinatura do Responsável" />`
        : '<div class="signature-image" style="background:#fef2f2; border: 1px solid var(--danger);">SEM ASSINATURA</div>';
    const signerName = signatureData?.signerName || 'Nome do Responsável';
    const clerkName = signatureData?.clerkName || 'Nome do Conferente';
    
    // 5. Monta a Lista
    const materialsArray = [];
    matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
    materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome

    let checklistHtml = '';
    let totalMissing = 0;
    
    materialsArray.forEach(m => {
        const required = m.quantity || 1;
        const delivered = deliveredQuantities[m.id] || 0;
        const missing = required - delivered;
        if(missing > 0) totalMissing += missing;
        
        const status = missing === 0 ? 'OK' : 'FALTA';
        const statusColor = missing === 0 ? 'var(--success)' : 'var(--danger)';

        checklistHtml += `
            <div class="material-item-doc" style="border-left: 4px solid ${missing === 0 ? 'var(--success)' : 'var(--danger)'};">
                <div style="flex:3; font-size: 13px;">${m.name}</div>
                <div style="flex:1; text-align:center; font-weight: bold;">${required}</div>
                <div style="flex:1; text-align:center; font-weight: bold;">${delivered}</div>
                <div style="flex:1; text-align:center; color:${statusColor}; font-weight: bold;">${missing}</div>
            </div>
        `;
    });
    
    const missingColor = totalMissing > 0 ? 'var(--danger)' : 'var(--success)';


    // 6. Monta o Documento
    const printableContent = `
        <style>
            /* Estilos para o documento de impressão (oculta o restante da aplicação) */
            @media screen {
                body > *:not(#print-doc) { display: none; }
                body { background: #eee; }
            }
            @media print {
                body { margin: 0; }
            }

            #print-doc {
                width: 210mm; /* A4 width */
                min-height: 297mm; /* A4 height */
                margin: 0 auto;
                padding: 20mm;
                background: white;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                font-family: 'Inter', sans-serif;
                color: #333;
                box-sizing: border-box;
            }
            .header-doc { text-align: center; margin-bottom: 25px; }
            .header-doc h2 { margin: 0 0 5px; color: #2b7cff; font-size: 22px; }
            .header-doc p { margin: 0; font-size: 12px; color: #666; }
            .student-info { 
                border: 1px solid #ccc; 
                padding: 15px; 
                margin-bottom: 25px; 
                border-radius: 4px; 
                background: #f9f9f9;
                display: flex;
                justify-content: space-between;
            }
            .student-info div { font-size: 14px; }
            .student-info strong { font-size: 16px; color: #111; display: block; margin-bottom: 5px;}
            .student-info span { font-weight: normal; color: #666; }
            
            h3 { font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 25px; }
            
            .material-list { 
                border: 1px solid #ccc; 
                border-radius: 4px; 
                margin-top: 10px; 
                overflow: hidden; 
            }
            .material-header-doc, .material-item-doc {
                display: flex;
                padding: 8px 10px;
                border-bottom: 1px solid #eee;
                align-items: center;
            }
            .material-header-doc {
                font-weight: bold;
                background: #eef4ff;
                color: #2b7cff;
                border-bottom: 2px solid #ccc;
                font-size: 13px;
            }
            .material-item-doc:last-child { border-bottom: none; }
            .material-item-doc > div { overflow: hidden; text-overflow: ellipsis; }

            .signature-area { display: flex; justify-content: space-between; margin-top: 50px; }
            .signature-block { 
                display: inline-block; 
                width: 48%; /* Aumentado um pouco para ocupar mais espaço */
                vertical-align: top; 
                text-align: center;
            }
            .signature-line {
                border-top: 1px solid #000;
                margin-top: 15px; /* Aumentado o espaço para a linha */
                padding-top: 5px;
                font-weight: bold;
                font-size: 14px;
            }
            .signature-image {
                max-width: 100%;
                max-height: 100px;
                height: 100px; /* Altura fixa para o bloco da assinatura */
                border: 1px solid #ccc;
                object-fit: contain;
                background: #f9f9f9;
                margin-bottom: 5px;
                border-radius: 4px;
            }
            .footer-text { margin-top: 30px; text-align: center; font-size: 11px; color: #888; }
            
            /* Mídia de Impressão */
            @media print {
                #print-doc {
                    box-shadow: none;
                    margin: 0;
                    width: 100%;
                    min-height: auto;
                    padding: 0;
                }
                body { 
                    -webkit-print-color-adjust: exact; 
                    print-color-adjust: exact; 
                }
            }
        </style>
        <div id="print-doc">
            <div class="header-doc">
                <h2>DOCUMENTO DE CONFERÊNCIA DE MATERIAL</h2>
                <p>Controle de Material Escolar - ${new Date().toLocaleDateString('pt-BR')}</p>
            </div>
            
            <div class="student-info">
                <div>
                    <strong>Aluno: ${s.name}</strong> 
                    Turma: ${className}
                </div>
                <div>
                    <strong>Matrícula/Nº: ${s.studentId || 'N/A'}</strong>
                    Status Geral: <span style="font-weight: bold; color: ${missingColor};">${totalMissing === 0 ? 'Entrega Completa' : `Faltam ${totalMissing} Itens`}</span>
                </div>
            </div>

            <h3>Lista de Materiais Requeridos:</h3>
            <div class="material-list">
                <div class="material-header-doc">
                    <div style="flex:3;">Item</div>
                    <div style="flex:1; text-align:center;">Req.</div>
                    <div style="flex:1; text-align:center;">Ent.</div>
                    <div style="flex:1; text-align:center;">Falta</div>
                </div>
                ${checklistHtml}
            </div>

            <div class="signature-area">
                <div class="signature-block">
                    ${signatureImageHtml}
                    <div class="signature-line">${signerName}</div>
                    <p class="small" style="font-size: 12px; margin-top: 5px;">Responsável Legal</p>
                </div>
                <div class="signature-block">
                    <div class="signature-image" style="background:#eee; border: 1px solid #ccc;"></div>
                    <div class="signature-line">${clerkName}</div>
                    <p class="small" style="font-size: 12px; margin-top: 5px;">Conferente (Escola)</p>
                </div>
            </div>
            
            <div class="footer-text">
                <p>Este documento comprova a conferência do material escolar na data de emissão. Versão ${new Date().getFullYear()}.</p>
            </div>
            
        </div>
    `;

    // 7. Renderiza e abre a janela de impressão
    const printWindow = window.open('', '_blank');
    if (printWindow) {
        printWindow.document.write(printableContent);
        printWindow.document.close();
        
        // Espera um momento antes de imprimir para garantir que o CSS seja aplicado
        setTimeout(() => {
            printWindow.print();
            // Opcional: printWindow.close(); // Fechar após a impressão
        }, 300); 
    } else {
        alert('O navegador bloqueou a abertura da janela de impressão. Verifique as configurações de pop-up.');
    }
}


/* ---------------------------
   GERAR QR CODE
   --------------------------- */

$('btnGenerateQRs').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');

    const classId = $('qrClassSelect').value;
    if(!classId) return alert('Selecione uma turma para gerar os QRs.');

    this.disabled = true;
    this.textContent = 'Gerando...';

    const gallery = $('qrGallery');
    gallery.innerHTML = '';
    
    try {
        const studentsSnap = await db.collection('students').where('classId', '==', classId).orderBy('name').get();
        
        if(studentsSnap.empty){
            gallery.innerHTML = '<div class="small" style="grid-column: 1 / -1;">Nenhum aluno encontrado nesta turma.</div>';
            return;
        }

        studentsSnap.forEach(d => {
            const s = d.data();
            const studentId = d.id;
            
            // Cria um contêiner para cada QR Code
            const qrContainer = document.createElement('div');
            qrContainer.style = 'border: 1px solid var(--border-color); padding: 10px; border-radius: var(--radius); text-align: center; background: var(--card);';
            qrContainer.innerHTML = `
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px; height: 3em; overflow: hidden;">${s.name}</div>
                <div id="qr-${studentId}" style="display: inline-block; padding: 10px; background: white; border: 1px solid #ddd;"></div>
                <div class="small" style="margin-top: 5px;">Nº: ${s.studentId || 'N/A'}</div>
                <button class="btn secondary download-btn" data-name="${s.name.replace(/\s/g, '_')}_QR" style="padding: 4px 8px; font-size: 10px; margin-top: 8px;">Baixar QR</button>
            `;
            gallery.appendChild(qrContainer);

            // Gera o QR Code com a URL do checklist (modo padrão 'checklist')
            const url = getStudentQRUrl(studentId, 'checklist');
            new QRCode(document.getElementById(`qr-${studentId}`), {
                text: url,
                width: 120,
                height: 120,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        
        // Adiciona listeners para download
        document.querySelectorAll('.download-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const name = this.dataset.name;
                const qrDiv = this.previousElementSibling.previousElementSibling;
                const img = qrDiv.querySelector('img');
                
                if (img) {
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.download = `${name}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('QR Code ainda não foi renderizado.');
                }
            });
        });

    } catch(err) {
        console.error('Erro ao gerar QRs', err);
        gallery.innerHTML = `<div class="small" style="grid-column: 1 / -1; color:var(--danger)">Erro ao gerar QRs: ${err.message || err}</div>`;
    } finally {
        this.disabled = false;
        this.textContent = 'Gerar QRs';
    }
});

/* ---------------------------
   RELATÓRIOS
   --------------------------- */

$('btnRunReport').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');
    const classId = $('reportClass').value;
    if(!classId) return alert('Selecione uma turma para gerar o relatório.');

    this.disabled = true;
    this.textContent = 'Gerando...';

    try{
        // 1. Fetch Students
        const studentsnap = await db.collection('students').where('classId', '==', classId).orderBy('name').get();
        
        // 2. Fetch Materials for the class
        const materialsnap = await db.collection('materials').where('classId', '==', classId).get();
        const materialsRequired = {}; // {materialId: quantity}
        materialsnap.forEach(m => materialsRequired[m.id] = m.data().quantity || 1);

        if (Object.keys(materialsRequired).length === 0) {
            $('reportArea').innerHTML = '<div class="small">Nenhum material cadastrado para esta turma.</div>';
            return;
        }

        // 3. Process data for each student
        const reportData = [];
        for (const studentDoc of studentsnap.docs) {
            const s = studentDoc.data();
            const studentId = studentDoc.id;

            // Fetch deliveries for the student
            const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentId).get();
            const materialsDelivered = {}; // {materialId: quantityDelivered}
            deliveriesSnap.forEach(d => materialsDelivered[d.data().materialId] = d.data().quantityDelivered || 0);

            let totalMissing = 0;
            
            for (const matId in materialsRequired) {
                const required = materialsRequired[matId];
                const delivered = materialsDelivered[matId] || 0;
                const missing = required - delivered;
                if (missing > 0) {
                    totalMissing += missing;
                }
            }

            if (totalMissing > 0) {
                reportData.push({
                    name: s.name,
                    studentId: s.studentId || 'N/A',
                    totalMissing: totalMissing,
                    studentDocId: studentId
                });
            }
        }
        
        this.disabled = false;
        this.textContent = 'Gerar relatório';
        
        if (reportData.length === 0) {
            $('reportArea').innerHTML = '<div class="small" style="color:var(--success); font-weight: 600;">Excelente! Todos os alunos desta turma estão com 100% dos materiais entregues.</div>';
            return;
        }

        // 4. Render Table
        const table = document.createElement('table');
        table.style = 'width: 100%; border-collapse: collapse; margin-top: 15px; background: var(--card); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);';
        
        const tableHeader = `
            <thead>
                <tr style="background: var(--accent-light);">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--accent);">Aluno</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid var(--accent); width: 120px;">Matrícula</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid var(--accent); width: 100px;">Total Faltando</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid var(--accent); width: 100px;">Ação</th>
                </tr>
            </thead>
        `;
        
        const tableBody = reportData.map(item => {
            const missingColor = item.totalMissing > 0 ? 'var(--danger)' : 'var(--success)';
            return `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 10px; text-align: left;">${item.name}</td>
                    <td style="padding: 10px; text-align: center;">${item.studentId}</td>
                    <td style="padding: 10px; text-align: center; color: ${missingColor}; font-weight: 600;">${item.totalMissing}</td>
                    <td style="padding: 10px; text-align: center;">
                        <button class="btn secondary" style="padding: 4px 8px; font-size: 11px;" onclick="openStudent('${item.studentDocId}')">Ver Checklist</button>
                    </td>
                </tr>
            `;
        }).join('');

        table.innerHTML = tableHeader + `<tbody>${tableBody}</tbody>`;

        $('reportArea').innerHTML = ''; // Limpa a área
        
        if (studentsnap.empty) {
            $('reportArea').innerHTML = '<div class="small">Nenhum aluno encontrado nesta turma para gerar o relatório.</div>';
        } else {
            // Cria um contêiner para o botão e a tabela
            const contentWrapper = document.createElement('div');
            
            // Adiciona o botão de fechar no topo
            contentWrapper.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <button class="btn secondary" 
                            style="background-color: var(--muted); color: white;" 
                            onclick="document.getElementById('reportArea').innerHTML = ''">
                        &larr; Fechar Relatório
                    </button>
                </div>`;

            // Anexa a tabela de relatório ao contêiner
            contentWrapper.appendChild(table);
            
            // Insere o contêiner completo na área do relatório
            $('reportArea').appendChild(contentWrapper);
        }
        
    }catch(err){
        console.error('Erro Relatório',err);
        alert('Erro ao gerar relatório: ' + (err.message||err));
        this.disabled = false;
        this.textContent = 'Gerar relatório';
    }
});

/* --------------------------- END OF JS --------------------------- */
</script>
</html>
