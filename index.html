<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Material Escolar - Painel</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Cores */
      --bg:#f5f7fb;
      --card:#ffffff;
      --accent:#2b7cff;
      --accent-light: #eef4ff;
      --muted:#6b7280;
      --success:#16a34a;
      --success-light: #ecfdf5;
      --danger:#ef4444;
      --danger-light: #fef2f2;
      --warning: #f59e0b;
      --warning-light: #fffbeb;
      --glass: rgba(255,255,255,0.7);
      
      /* Geometria */
      --radius:10px;
      --pad:16px; 
      --border-color: #e6e9ef;
    }
    *{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    
    /* ATUALIZAÇÕES CRUCIAIS PARA O FOOTER FIXAR NO FINAL */
    body {
        margin: 0;
        background: var(--bg);
        min-height: 100vh; /* Garante altura mínima da tela */
        color: #111;
        padding-bottom: 0; 
        transition: overflow 0.3s;
        display: flex; /* NOVO: Habilita flexbox no body */
        flex-direction: column; /* NOVO: Organiza os filhos verticalmente */
    }
    
    /* Header (Cabeçalho) */
    header{display:flex;align-items:center;justify-content:space-between;padding:14px var(--pad);background:var(--card);box-shadow:0 1px 12px rgba(11,15,35,0.08);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;font-weight:700;}
    header .right{display:flex;gap:12px;align-items:center}
    
    /* Layout Principal */
    /* ATUALIZAÇÃO NO LAYOUT .container */
    .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 16px;
        flex-grow: 1; /* Faz o container principal crescer e empurrar o rodapé */
    }
    .grid{display:grid;grid-template-columns:300px 1fr;gap:20px} /* Desktop View */
    
    /* Cartões */
    .card{background:var(--card);padding:var(--pad);border-radius:var(--radius);box-shadow:0 4px 12px rgba(12,18,40,0.04);transition:transform 0.1s}
    .card:hover.clickable-card { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(12,18,40,0.08); } 
    .card.group-card { padding: 0; box-shadow: 0 4px 12px rgba(12,18,40,0.04); }
    
    /* Títulos e Texto */
    .section-title{font-weight:700;margin-bottom:12px;color:#0f172a;font-size:20px}
    .small{font-size:13px;color:var(--muted)}
    
    /* Navegação (Sidebar) - Desktop Default */
    nav {padding: 4px 0;}
    nav .nav-item{padding:10px;border-radius:8px;cursor:pointer;color:#111;display:flex;gap:10px;align-items:center;transition:background 0.2s, border 0.2s}
    nav .nav-item:hover{background:#f1f5f9;}
    nav .nav-item.active{background:var(--accent-light);color:var(--accent);font-weight:600;}
    
    /* Botões */
    .btn{display:inline-block;padding:10px 16px;border-radius:8px;background:var(--accent);color:white;text-decoration:none;border:none;cursor:pointer;transition:background 0.2s, opacity 0.2s;font-weight:500;font-size:14px;}
    .btn:hover:not(:disabled){filter:brightness(1.05); box-shadow: 0 2px 8px rgba(43,124,255,0.2);}
    .btn:disabled{opacity:0.6; cursor:not-allowed;}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid var(--border-color);padding:9px 15px;}
    .btn.secondary:hover:not(:disabled){background:#f8fafc; color:var(--accent); border-color:var(--accent-light); box-shadow: none;}

    /* Inputs/Formulários */
    .input, textarea, select{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--border-color);
      background:white;
      transition:border-color: 0.2s;
      font-size: 16px; /* MELHORIA MOBILE: Garante 16px para evitar zoom indesejado */
    }
    .input:focus, textarea:focus, select:focus {border-color: var(--accent); outline: none; box-shadow: 0 0 0 1px var(--accent-light);}
    
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center}
    .materials-list{max-height:300px;overflow:auto;padding-right:6px}
    
    /* Itens de Lista (Materiais/Alunos) */
    .material-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;background:#fcfdff;border:1px solid #eef2ff;transition:background 0.2s;}
    .material-item:hover{background:var(--accent-light); border-color:var(--accent);}
    
    .student-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:var(--radius);border:1px solid var(--border-color);background:var(--card);}
    .qr-img{width:120px;height:120px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center}
    
    /* Componentes Auxiliares */
    .hint{padding:10px;border-radius:8px;background:var(--accent-light);border:1px solid var(--accent);color:var(--accent);font-size:13px}
    .flex-col{display:flex;flex-direction:column;gap:10px}
    pre.rules{background:#0b1220;color:#f8fafc;padding:15px;border-radius:8px;overflow:auto;font-size:14px;line-height:1.4;}
    
    /* Overlay e Modal Checklist - NOVO/MELHORADO */
    #menuOverlay, #checklist-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        z-index: 15;
        display: none;
        transition: opacity 0.3s;
        opacity: 0;
    }
    #menuOverlay.visible, #checklist-modal.visible {
        opacity: 1;
        display: flex; 
        align-items: center;
        justify-content: center;
    }
    .checklist-modal-box {
        width: 650px; /* Largura maior para melhor visualização */
        max-width: 95vw;
        max-height: 90vh;
        overflow: hidden;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column; /* Essencial para que a lista cresça e empurre o rodapé */
    }
    #checklist-list-area {
        overflow-y: auto;
        padding: var(--pad);
        padding-top: 0;
        flex-grow: 1; /* Ocupa o espaço restante e permite a rolagem apenas nesta área */
    }
    .checklist-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 10px;
        border-bottom: 1px dashed var(--border-color);
    }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-item-details { flex-grow: 1; max-width: 60%; }
    .checklist-item-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    
    /* CORREÇÃO: Aumenta a largura para melhor visualização em todos os dispositivos */
    .delivery-input { 
        width: 60px !important; 
        padding: 4px; 
        border-radius: 4px; 
        border: 1px solid #ccc; 
        text-align: center; 
        font-size: 13px; /* Mantém 13px para não afetar o layout do modal */
    }

    /* Estilos para o Signature Pad */
    #signature-area {
        padding: var(--pad);
        background: #fcfdff;
        border-top: 1px solid var(--border-color); /* Mantido para separar do checklist */
    }
    #signature-canvas {
        border: 1px dashed var(--muted);
        border-radius: 4px;
        width: 100%;
        height: 150px;
        touch-action: none; /* Necessário para touch events e mouse */
    }
    #signature-preview {
        max-width: 100%;
        max-height: 150px;
        margin: 5px 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        object-fit: contain;
    }

    /* Estilos para o Documento de Impressão */
    .signature-block { display: inline-block; width: 45%; margin: 0 10px; vertical-align: top; }


    /* ------------------------------------- */
    /* ESTILOS DO RODAPÉ (FOOTER) - NOVO */
    /* ------------------------------------- */
    #main-footer {
        background-color: var(--card);
        color: var(--muted);
        padding: 20px var(--pad);
        text-align: center;
        font-size: 14px;
        margin-top: 40px; /* Espaço para separar do conteúdo principal */
        border-top: 1px solid var(--border-color); /* Linha sutil no topo */
        width: 100%;
        flex-shrink: 0; /* Impede que o footer encolha */
    }
    #main-footer .small-text {
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.8;
    }

    /* Mobile Responsiveness (Hamburguer Menu) */
    @media (max-width: 992px) {
      /* ... (Estilos Mobile Anteriores) ... */
      header .left-controls { display: flex; align-items: center; }
      #menuToggle { display: inline-block !important; margin-right: 10px; }

      .grid { grid-template-columns: 1fr; } /* Layout de coluna única */
      .container { padding: 0 12px; }
      
      /* Sidebar */
      #sidebar {
        position: fixed;
        top: 50px; /* Abaixo do header */
        left: 0;
        width: 250px; /* Largura do menu */
        height: calc(100vh - 50px);
        z-index: 20;
        padding: var(--pad);
        transform: translateX(-100%); /* Inicialmente oculto fora da tela */
        transition: transform 0.3s ease-in-out;
        box-shadow: 4px 0 12px rgba(0,0,0,0.3);
        background: var(--card); /* Fundo sólido */
        margin: 0; /* Remove margem */
        border-radius: 0; /* Remove cantos arredondados na lateral */
        overflow-y: auto; /* Scroll dentro do menu, se necessário */
      }
      #sidebar.active {
        transform: translateX(0);
      }
      #menu {
        display: block; 
        gap: 0;
        padding: 0;
      }
      nav .nav-item {
        flex: none;
        text-align: left;
        justify-content: flex-start;
        padding: 12px 10px;
        min-width: unset;
      }
      
      /* Dashboard counters em coluna */
      #dashboard .row { flex-direction: column; gap: 10px; }
      #dashboard .row .card { width: 100%; }

      /* Ajuste para botões e inputs em linhas */
      /* MELHORIA MOBILE: Força o empilhamento vertical para formulários em linha */
      .row:not(#dashboard .row) { 
        flex-direction: column; 
        flex-wrap: nowrap; /* Não quebra, apenas empilha */
        gap: 8px; /* Ajusta o espaçamento */
      }
      .row .input, .row select, .row button { 
        min-width: 100%; 
        flex-grow: 1; 
        width: 100% !important; /* Garante que os inputs ocupem a largura total */
      }
      /* FIM MELHORIA MOBILE */

      
      /* Turmas/Materiais em coluna */
      #materials .row { flex-direction: column; gap: 15px; }
      #materials .row > div { width: 100%; }

      /* QR Gallery ajuste */
      #qrGallery { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
      
      /* Alunos - botões em coluna */
      .student-card > div:last-child {
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      .student-card button { padding: 6px 10px; font-size: 12px; }

      /* Ajustes específicos para o modal de checklist em mobile */
      .checklist-modal-box {
          width: 95vw !important;
          max-height: 95vh !important; 
          padding: 0 !important; 
      }
      .checklist-item-details { max-width: 100%; }
      .checklist-item-controls { justify-content: space-between; gap: 8px; width: 100%; }
      .checklist-item { flex-direction: column; align-items: flex-start; gap: 8px; }
      #checklist-list-area { padding: 12px; flex-shrink: 1; } /* Garantindo o flex-shrink para que os outros elementos fixos possam aparecer */
      #signature-area { padding: 12px; flex-shrink: 0; }
    }
  </style>
</head>
<body>

<header>
  <div class="left-controls" style="display:flex; align-items:center;">
    <button id="menuToggle" class="btn secondary" style="display:none; padding: 6px 10px; font-size: 16px; margin-right: 10px;">
      ☰
    </button>
    <h1>Controle de Material Escolar</h1>
  </div>
  
  <div class="right">
    <div id="userEmail" class="small" style="font-weight: 500;"></div>
    <button id="btnLogout" class="btn secondary" style="display:none; padding: 6px 10px;">Sair</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card" id="sidebar">
      <div class="section-title" style="margin-bottom: 10px;">Menu de Navegação</div>
      <nav id="menu">
        <div class="nav-item active" data-tab="dashboard">Dashboard</div>
        <div class="nav-item" data-tab="import">Importar Lista</div>
        <div class="nav-item" data-tab="materials">Materiais</div>
        <div class="nav-item" data-tab="students">Alunos</div>
        <div class="nav-item" data-tab="qrs">Gerar QR</div>
        <div class="nav-item" data-tab="reports">Relatórios</div>
        <div class="nav-item" data-tab="help">Ajuda</div>
      </nav>
      <hr style="margin:16px 0 10px;border:none;border-top:1px solid #f1f5f9"/>
      <div class="small">Dica: faça login com uma conta administrativa antes de salvar dados.</div>
    </div>

    <div class="card" id="main" style="grid-column: 2 / -1;"> 
      <div id="loginPanel">
        <h2 class="section-title">Login administrativo</h2>
        <div class="small">Use Email / Senha (autenticação Firebase)</div>
        <div style="height:12px"></div>
        <input id="loginEmail" class="input" placeholder="email@escola.com"/>
        <div style="height:8px"></div>
        <input id="conferenteName" class="input" placeholder="Nome Completo do Conferente (Você)" value=""/>
        <div style="height:8px"></div>
        <input id="loginPass" class="input" type="password" placeholder="Senha"/>
        <div style="height:12px"></div>
        <div class="row">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnSignup" class="btn secondary">Criar conta (teste)</button>
        </div>
        <div style="height:12px"></div>
        <div id="loginMsg" class="small" style="color:var(--danger)"></div>
        <div style="height:12px"></div>
        <div id="libStatus" class="hint small">Verificando bibliotecas...</div>
      </div>

      <div id="appContent" style="display:none">
        <div id="dashboard" class="tab">
          <h2 class="section-title">Dashboard</h2>
          <div class="row" style="gap:14px; margin-bottom: 25px; flex-direction: row !important; flex-wrap: wrap;">
            <div style="flex:1" class="card">
              <div class="small">Turmas cadastradas</div>
              <div id="countClasses" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Alunos cadastrados</div>
              <div id="countStudents" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Materiais totais</div>
              <div id="countMaterials" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
          </div>

          <h3 class="section-title" style="border-top: 1px solid #eee; padding-top:15px; margin-top: 0;">Status de Entrega por Segmento</h3>
          <div id="classStatusGrid" style="display:grid; grid-template-columns: 1fr; gap:20px;">
            <div class="small" style="grid-column: 1 / -1;">Carregando status das turmas...</div>
          </div>
        </div>

        <div id="import" class="tab" style="display:none">
          <h2 class="section-title">Importar Lista de Materiais (Texto)</h2>
          <div class="small">Cole abaixo o texto da lista de materiais copiado diretamente do PDF. O sistema tentará extrair a quantidade e o nome do item.</div>
          <div style="height:12px"></div>
          <textarea id="materialText" class="input" rows="10" placeholder="Cole a lista de materiais aqui, uma linha por item (se possível) ou o texto bruto do PDF. Ex: 1 Caderno Universitário, 4 Lápis, etc."></textarea>
          <div style="height:12px"></div>
          <button id="btnParseText" class="btn">Processar Texto</button>
          <div style="height:20px"></div>
          
          <h3 class="section-title" style="font-size: 16px;">Salvar materiais na Turma</h3>
          <div class="row">
            <select id="targetClass" class="input">
              <option value="">Escolha uma turma (ou crie abaixo)</option>
            </select>
            <button id="btnNewClass" class="btn secondary">Nova Turma</button>
          </div>
          <div style="height:8px"></div>
          <div id="newClassRow" style="display:none" class="row">
            <input id="newClassName" class="input" placeholder="Nome da turma (ex: 2ª Série Ensino Médio)"/>
            <select id="newClassSegment" class="input" style="width:200px;">
                <option value="">Selecione o Segmento</option>
                <option value="infantil">Educação Infantil</option>
                <option value="fund1">Fundamental I</option>
                <option value="fund2">Fundamental II</option>
                <option value="medio">Ensino Médio</option>
                <option value="other">Outros</option>
            </select>
            <button id="saveNewClass" class="btn">Criar</button>
          </div>

          <div style="height:16px"></div>
          <div class="card materials-list" id="parsedMaterials">
            <div class="small">Cole o texto acima e clique em "Processar Texto".</div>
          </div>
          <div style="height:12px"></div>
          <div class="row" style="justify-content: flex-end;">
            <button id="btnClearParsed" class="btn secondary">Limpar Lista</button>
            <button id="btnSaveMaterials" class="btn">Salvar materiais na turma</button>
          </div>
        </div>

        <div id="materials" class="tab" style="display:none">
          <h2 class="section-title">Materiais & Turmas</h2>
          <div class="row" style="gap:20px; align-items: flex-start;">
            <div style="flex:1" class="card">
              <div class="section-title" style="font-size: 16px;">Turmas Cadastradas</div>
              <div id="classesList" style="margin-top:8px"></div>
            </div>
            <div style="flex:2" class="card">
              <div class="section-title" style="font-size: 16px;">Materiais da Turma Selecionada</div>
              <div id="materialsOfClass" style="margin-top:8px">
                <div class="small">Clique em "Abrir" em uma turma ao lado.</div>
              </div>
            </div>
          </div>
        </div>

        <div id="students" class="tab" style="display:none">
          <h2 class="section-title">Alunos</h2>
          <div class="small">Use o filtro abaixo para visualizar alunos por turma ou adicione um novo aluno.</div>
          <div style="height:12px"></div>

          <div class="row" style="margin-bottom: 12px;">
            <select id="studentsFilterClass" class="input" style="flex:1;">
              <option value="">Mostrar Todos os Alunos (Filtro)</option>
            </select>
          </div>

          <div class="row" style="align-items: flex-end;">
            <input id="studentName" class="input" placeholder="Nome do aluno"/>
            <select id="studentClass" class="input" style="width:220px; min-width: 150px;">
              <option value="">Escolha a turma (Novo Aluno)</option>
            </select>
            <input id="studentIdInput" class="input" placeholder="Matricula / Nº" style="width:140px; min-width: 100px;"/>
            <button id="btnAddStudent" class="btn" style="min-width: 100px;">Adicionar</button>
          </div>
          <div style="height:16px"></div>
          <div id="studentsList" class="flex-col"></div>
        </div>

        <div id="qrs" class="tab" style="display:none">
          <h2 class="section-title">Gerar QR para sacolas</h2>
          <div class="small">Selecione uma turma e gere QR para cada aluno (downloadable). Este QR abre o **Documento Simplificado** (para conferência) diretamente ao ser escaneado.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="qrClassSelect" class="input"></select>
            <button id="btnGenerateQRs" class="btn" style="min-width: 120px;">Gerar QRs</button>
          </div>
          <div style="height:20px"></div>
          <div id="qrGallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px"></div>
        </div>

        <div id="reports" class="tab" style="display:none">
          <h2 class="section-title">Relatórios</h2>
          <div class="small">Relatório rápido: contagem total de itens que faltam por aluno na turma selecionada.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="reportClass" class="input"></select>
            <button id="btnRunReport" class="btn" style="min-width: 120px;">Gerar relatório</button>
          </div>
          <div id="reportArea" style="margin-top:20px" class="flex-col"></div>
        </div>

        <div id="help" class="tab" style="display:none">
          <h2 class="section-title">Ajuda e Regras do Firebase</h2>
          <div class="small">Se o console exibir "Missing or insufficient permissions", veja abaixo as regras mínimas para testes (apenas para ambiente de desenvolvimento).</div>
          <div style="height:10px"></div>
          <div class="hint small">Cole este snippet nas Regras do Firestore (Console Firebase → Firestore → Regras) para testes locais:</div>
          <pre class="rules">
// Regras de exemplo PARA DESENVOLVIMENTO (NÃO USAR EM PRODUÇÃO sem ajuste)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null; // permite a usuários autenticados
    }
  }
}
          </pre>
          <div style="height:8px"></div>
          <div class="small">Se você quiser acesso público apenas para leitura (temporário), substitua a linha por: <code>if true</code> — mas isso torna seus dados públicos.</div>
        </div>

      </div>
    </div>
  </div>
</div> <footer id="main-footer">
    <div class="footer-content">
        <p>&copy; Todos os direitos reservados.</p>
        <p class="small-text">Desenvolvido por Nay Cordeiro - Escola Traços & Letras 2026.</p>
    </div>
</footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<script>
/* ============================
   CONFIGURAÇÃO DO FIREBASE
   Substitua com sua config.
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDNpnxlyLEu6OqP_fN3SRtWpSRvZFkuAXI",
  authDomain: "materialescolar-126da.firebaseapp.com",
  projectId: "materialescolar-126da",
  storageBucket: "materialescolar-126da.firebasestorage.app",
  messagingSenderId: "498322809036",
  appId: "1:498322809036:web:ee71b80840ee8dc2676269"
};

/* ---------------------------
   Verificações de biblioteca
   --------------------------- */
function setLibStatus(msg,isError){
  const el = document.getElementById('libStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
  el.style.background = isError ? 'var(--danger-light)' : 'var(--accent-light)';
  el.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
}

(function checkLibs(){
  const missing = [];
  if(typeof firebase === 'undefined') missing.push('Firebase');
  if(typeof QRCode === 'undefined') missing.push('QRCode');
  if(typeof SignaturePad === 'undefined') missing.push('SignaturePad');
  
  if(missing.length){
    setLibStatus('Atenção: bibliotecas faltando: ' + missing.join(', ') + '. Verifique conexão com CDNs.', true);
  } else {
    setLibStatus('Bibliotecas carregadas corretamente.');
  }
})();

/* ---------------------------
   Inicialização Firebase (apenas se carregou)
   --------------------------- */
let auth = null, db = null, storage = null;
try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
} catch(e){
  console.error('Erro inicializar Firebase:', e);
  setLibStatus('Erro ao inicializar Firebase. Veja console.', true);
}

/* ---------------------------
   Util / UI helpers
   --------------------------- */
function $(id){ return document.getElementById(id); }

/* Lógica do Menu Hambúrguer */
const sidebar = $('sidebar');
const menuToggle = $('menuToggle');
const menuOverlay = $('menuOverlay') || (function() {
    const el = document.createElement('div');
    el.id = 'menuOverlay';
    document.body.appendChild(el);
    return el;
})();

/**
 * Alterna a visibilidade do menu lateral (sidebar) e do overlay.
 * @param {boolean | null} force - Força o estado (true para abrir, false para fechar).
 */
function toggleMenu(force = null) {
    // Detecta se estamos em modo mobile (media query de 992px)
    const isMobileView = window.innerWidth <= 992;
    if (!isMobileView && force === null) return; // Não faz nada se for desktop e não for forçado
    
    const isVisible = force !== null ? force : !sidebar.classList.contains('active');
    
    if (isVisible) {
        sidebar.classList.add('active');
        menuOverlay.classList.add('visible');
        document.body.style.overflow = 'hidden'; // Evita scroll do conteúdo principal
    } else {
        sidebar.classList.remove('active');
        menuOverlay.classList.remove('visible');
        document.body.style.overflow = '';
    }
}

// Adiciona listeners para o toggle e para o overlay
if(menuToggle) menuToggle.addEventListener('click', () => toggleMenu());
if(menuOverlay) menuOverlay.addEventListener('click', () => toggleMenu(false));


function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.querySelectorAll('#menu .nav-item').forEach(i=>i.classList.remove('active'));
  $('loginPanel').style.display = auth && auth.currentUser ? 'none' : '';
  if(!auth || !auth.currentUser){
    $('appContent').style.display='none';
    return;
  }
  $('appContent').style.display='';
  const tab = $(name);
  if(tab) tab.style.display='';
  const menuItem = document.querySelector('#menu .nav-item[data-tab="'+name+'"]');
  if(menuItem) menuItem.classList.add('active');

  // FECHA o menu hambúrguer após a navegação em mobile
  if(window.innerWidth <= 992) {
      toggleMenu(false);
  }
}
document.querySelectorAll('#menu .nav-item').forEach(it=>{
  it.addEventListener('click', ()=> showTab(it.dataset.tab));
});

/* ---------------------------
   GERADOR DE URL QR CODE PARA CHECKLIST/IMPRESSÃO
   --------------------------- */
/**
 * Constrói a URL para escanear o QR Code de um aluno, definindo o modo de visualização.
 * O modo 'print' abre o documento simplificado (para impressão/visualização rápida), 
 * 'checklist' abre o modal completo (padrão para conferência).
 * * @param {string} studentId - O ID do documento do aluno no Firestore.
 * @param {'checklist' | 'print'} [mode='checklist'] - O modo de abertura do documento.
 * @returns {string} A URL completa com parâmetros.
 */
function getStudentQRUrl(studentId, mode = 'checklist') { 
    // Usando window.location.origin e pathname garante que funcione em diferentes ambientes (local ou hospedado)
    return window.location.origin + window.location.pathname + '?studentId=' + studentId + '&mode=' + mode;
}

/* ---------------------------
   AUTH (Email/Password) & INITIAL LOAD
   --------------------------- */

// NOVIDADE: Função helper para obter o nome do conferente atual
function getCurrentClerkName() {
    // 1. Tenta pegar do input/localStorage
    const inputName = $('conferenteName') ? $('conferenteName').value.trim() : null;
    let name = inputName || localStorage.getItem('conferenteName');
    
    // 2. Fallback: Se estiver logado e não houver nome, usa a parte do email antes do '@' (melhor que nada)
    if (!name && auth && auth.currentUser && auth.currentUser.email) {
        name = auth.currentUser.email.split('@')[0];
    }
    
    // 3. Fallback final
    return name || 'Conferente Desconhecido';
}

// NOVIDADE: Puxa o nome do localStorage ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
    const conferenteNameInput = $('conferenteName');
    if (conferenteNameInput) {
        const storedName = localStorage.getItem('conferenteName');
        if (storedName) {
            conferenteNameInput.value = storedName;
        }
    }
});


async function completeLoginAndLoad(){
    try {
        // Carrega dados em paralelo para agilizar
        await Promise.all([
            loadDashboardData(),
            loadClassesSelects(),
            // Usa o valor atual do filtro se já foi definido, senão carrega todos
            loadStudentsList($('studentsFilterClass') ? $('studentsFilterClass').value : null) 
        ]);
    } catch(e) {
        console.warn('Erro durante o carregamento inicial de dados após login:', e);
    }
    
    // --- FLUXO PARA SCANNER/CÂMERA ---
    const params = new URLSearchParams(window.location.search);
    const scannedStudentId = params.get('studentId');
    const scannedMode = params.get('mode');

    if (scannedStudentId) {
        // 1. Abre o documento para impressão (se for modo 'print') ou o modal de conferência (padrão/fallback).
        if (scannedMode === 'print') {
            generatePrintableChecklist(scannedStudentId);
        } else {
            openStudent(scannedStudentId);
        }
        // 2. Remove o parâmetro da barra de URL após a ação (evita loops)
        if (typeof history.replaceState === 'function') {
            history.replaceState(null, '', window.location.pathname); 
        }
    }
    
    showTab('dashboard');
}

if(auth){
  $('btnLogin').addEventListener('click', async ()=>{
    const e = $('loginEmail').value.trim();
    const p = $('loginPass').value;
    const n = $('conferenteName').value.trim(); // Pega o nome do conferente
    
    if (!n) {
        $('loginMsg').textContent = 'Erro: Preencha o Nome Completo do Conferente.';
        return;
    }
    localStorage.setItem('conferenteName', n); // Salva o nome no local storage

    try{
      await auth.signInWithEmailAndPassword(e,p);
      $('loginMsg').textContent='';
    }catch(err){
      $('loginMsg').textContent = err.message || 'Erro ao logar';
    }
  });
  
  $('btnSignup').addEventListener('click', async ()=>{
    const e = $('loginEmail').value.trim();
    const p = $('loginPass').value;
    const n = $('conferenteName').value.trim(); // Pega o nome do conferente
    
    if (!n) {
        $('loginMsg').textContent = 'Erro: Preencha o Nome Completo do Conferente.';
        return;
    }
    localStorage.setItem('conferenteName', n); // Salva o nome no local storage

    try{
      await auth.createUserWithEmailAndPassword(e,p);
      $('loginMsg').textContent='Conta criada com sucesso! Faça login.';
    }catch(err){
      $('loginMsg').textContent = err.message || 'Erro ao criar conta';
    }
  });
  
  $('btnLogout').addEventListener('click', async ()=>{
    try{
      await auth.signOut();
    }catch(err){
      console.error('Erro ao deslogar', err);
    }
  });
  
  auth.onAuthStateChanged(user=>{
    if(user){
      $('loginPanel').style.display = 'none';
      $('appContent').style.display = '';
      $('userEmail').textContent = getCurrentClerkName() + ' (' + user.email + ')';
      $('btnLogout').style.display = 'inline-block';
      completeLoginAndLoad();
    }else{
      $('loginPanel').style.display = '';
      $('appContent').style.display = 'none';
      $('userEmail').textContent = 'Desconectado';
      $('btnLogout').style.display = 'none';
    }
  });
}

/* ---------------------------
   CLASSES (TURMAS)
   --------------------------- */
$('btnNewClass').addEventListener('click', ()=> {
  const row = $('newClassRow');
  row.style.display = row.style.display === 'none' ? 'flex' : 'none';
});

$('saveNewClass').addEventListener('click', async function(){
  if(!db) return alert('Firestore não inicializado');
  const name = $('newClassName').value.trim();
  const segment = $('newClassSegment').value;

  if(!name || !segment) return alert('Preencha o nome da turma e o segmento.');

  this.disabled = true;
  this.textContent = 'Salvando...';

  try{
    await db.collection('classes').add({
      name: name,
      segment: segment,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Turma criada com sucesso!');
    $('newClassName').value = '';
    $('newClassSegment').value = '';
    $('newClassRow').style.display = 'none';
    loadClassesSelects(); // Recarrega os selects
    loadDashboardData(); // Atualiza contadores
  }catch(err){
    console.error('Erro ao criar turma', err);
    alert('Erro ao criar turma: ' + (err.message || err));
  }finally{
    this.disabled = false;
    this.textContent = 'Criar';
  }
});

/**
 * Carrega a lista de turmas em todos os elementos <select>
 */
async function loadClassesSelects(){
  if(!db) return;
  const selects = [$('targetClass'), $('studentClass'), $('studentsFilterClass'), $('qrClassSelect'), $('reportClass')];
  
  // Limpa e adiciona opções padrão
  selects.forEach(s => {
    if(!s) return;
    s.innerHTML = '';
    if (s.id === 'studentsFilterClass') {
        s.innerHTML = '<option value="">Mostrar Todos os Alunos (Filtro)</option>';
    } else if (s.id === 'studentClass') {
         s.innerHTML = '<option value="">Escolha a turma (Novo Aluno)</option>';
    } else {
        s.innerHTML = '<option value="">Escolha uma turma</option>';
    }
  });

  try{
    const snap = await db.collection('classes').orderBy('name').get();
    
    if(snap.empty){
      document.getElementById('classesList').innerHTML = '<div class="small">Nenhuma turma cadastrada.</div>';
      return;
    }
    
    const classesList = [];
    snap.forEach(d => {
      classesList.push({ id: d.id, name: d.data().name });
      selects.forEach(s => {
        if(s) s.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
      });
    });
    
    // Lista para a aba "Materiais & Turmas"
    const listHtml = classesList.map(c => `
      <div class="material-item">
        <span>${c.name}</span>
        <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="loadMaterialsOfClass('${c.id}', '${c.name.replace(/'/g, "\\'")}')">Abrir</button>
      </div>
    `).join('');
    document.getElementById('classesList').innerHTML = `<div class="list">${listHtml}</div>`;

  }catch(err){
    console.error('Erro loadClassesSelects', err);
  }
}

let classId_currently_viewed = null;
async function loadMaterialsOfClass(classId, className){
  if(!db) return;
  classId_currently_viewed = classId;
  const container = $('materialsOfClass');
  container.innerHTML = `<h4>Materiais da Turma: ${className}</h4><div class="small">Carregando...</div>`;

  try{
    const matsnap = await db.collection('materials').where('classId','==',classId).orderBy('name').get();
    
    if(matsnap.empty){
      container.innerHTML = `<h4>Materiais da Turma: ${className}</h4><div class="small">Nenhum material cadastrado para esta turma.</div>`;
      return;
    }
    
    const listHtml = matsnap.docs.map(d => {
      const m = d.data();
      return `
        <div class="material-item">
          <div>
            <strong>${m.name}</strong>
            <div class="small">Qtd. Requerida: ${m.quantity || 1}</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="editMaterial('${d.id}', ${m.quantity})">Editar Qtd</button>
            <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteMaterial('${d.id}', '${m.name.replace(/'/g, "\\'")}')">Apagar</button>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = `<h4>Materiais da Turma: ${className}</h4><div class="list">${listHtml}</div>`;

  }catch(err){
    console.error('Erro loadMaterialsOfClass', err);
    container.innerHTML = `<div class="small" style="color:var(--danger)">Erro ao carregar materiais: ${err.message || err}</div>`;
  }
}

async function editMaterial(materialId, currentQuantity) {
    const newQty = prompt(`Editar Quantidade Requerida (Atual: ${currentQuantity}):`);
    if (newQty === null || isNaN(parseInt(newQty, 10)) || parseInt(newQty, 10) < 1) {
        if (newQty !== null) alert('Quantidade inválida.');
        return;
    }
    const quantity = parseInt(newQty, 10);
    try {
        await db.collection('materials').doc(materialId).update({ quantity });
        alert('Quantidade atualizada com sucesso. Recarregue a lista de materiais para conferir.');
        // Força recarregar a lista se possível, mas aqui vamos focar no reload do tab para simplicidade
        // loadMaterialsOfClass(classId_currently_viewed)
    } catch (err) {
        console.error('Erro ao editar material', err);
        alert('Erro ao editar material: ' + (err.message || err));
    }
}

async function deleteMaterial(materialId, materialName) {
    if (!confirm(`Tem certeza que deseja apagar o material "${materialName}" desta turma?`)) {
        return;
    }
    try {
        await db.collection('materials').doc(materialId).delete();
        alert(`Material "${materialName}" apagado com sucesso.`);
        // Note: Deveria recarregar loadMaterialsOfClass(classId) mas por simplicidade de JS inline vamos manter o alert
    } catch (err) {
        console.error('Erro ao apagar material', err);
        alert('Erro ao apagar material: ' + (err.message || err));
    }
}


/* ---------------------------
   IMPORTAÇÃO DE MATERIAIS
   --------------------------- */
let parsedMaterialList = [];

/**
 * Função simples para tentar extrair quantidade e nome de uma linha de texto.
 * @param {string} text - Linha de texto (ex: "4 Lápis de cor jumbo")
 * @returns {{name: string, quantity: number}}
 */
function parseMaterialLine(text) {
    const trimmed = text.trim();
    if (!trimmed) return null;

    // Regex para encontrar um número no início, opcionalmente seguido por 'x'
    const match = trimmed.match(/^(\d+)\s*x?\s*(.*)/i);
    
    if (match) {
        const quantity = parseInt(match[1], 10);
        let name = match[2].trim();
        
        // Remove pontuações finais
        name = name.replace(/[,.]$/, '').trim(); 
        
        return { name: name || 'Item Sem Nome', quantity: quantity };
    }
    
    // Se não encontrou número, assume 1
    let name = trimmed.replace(/[,.]$/, '').trim();
    return { name: name, quantity: 1 };
}

$('btnParseText').addEventListener('click', ()=>{
  const text = $('materialText').value;
  const lines = text.split('\n');
  parsedMaterialList = [];
  
  lines.forEach(line => {
    const parsed = parseMaterialLine(line);
    if(parsed && parsed.name && parsed.name.toLowerCase() !== 'item sem nome'){
        // Evita duplicatas simples
        const existing = parsedMaterialList.find(m => m.name.toLowerCase() === parsed.name.toLowerCase());
        if (!existing) {
            parsedMaterialList.push(parsed);
        } else {
            existing.quantity += parsed.quantity; // Soma se for duplicado
        }
    }
  });

  renderParsedMaterials();
});

function renderParsedMaterials(){
  const container = $('parsedMaterials');
  if(parsedMaterialList.length === 0){
    container.innerHTML = '<div class="small">Nenhum material detectado. Tente formatar o texto em "Quantidade Nome" por linha.</div>';
    $('btnSaveMaterials').disabled = true;
    return;
  }
  
  const listHtml = parsedMaterialList.map(m => `
    <div class="material-item">
      <span>${m.name}</span>
      <strong style="color:var(--accent)">Qtd: ${m.quantity}</strong>
    </div>
  `).join('');
  
  container.innerHTML = `
    <div class="small" style="margin-bottom: 8px;">${parsedMaterialList.length} itens prontos para salvar:</div>
    <div class="list materials-list">${listHtml}</div>
  `;
  $('btnSaveMaterials').disabled = false;
}

$('btnClearParsed').addEventListener('click', ()=>{
  parsedMaterialList = [];
  $('materialText').value = '';
  renderParsedMaterials();
});

$('btnSaveMaterials').addEventListener('click', async function(){
  if(!db) return alert('Firestore não inicializado');
  const classId = $('targetClass').value;
  if(!classId) return alert('Selecione uma turma para salvar os materiais.');
  if(parsedMaterialList.length === 0) return alert('Nenhum material para salvar.');
  
  this.disabled = true;
  this.textContent = 'Salvando...';
  
  const materialsToSave = parsedMaterialList.map(m => ({
    ...m,
    classId: classId
  }));
  
  try{
    const batch = db.batch();
    
    materialsToSave.forEach(m => {
      // Para um sistema mais robusto, seria bom verificar se o (name + classId) já existe.
      const newMaterialRef = db.collection('materials').doc();
      batch.set(newMaterialRef, {
        name: m.name,
        quantity: m.quantity,
        classId: m.classId,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    
    await batch.commit();
    alert(`Sucesso! ${materialsToSave.length} materiais salvos na turma.`);
    
    // Limpa a interface
    $('materialText').value = '';
    $('parsedMaterials').innerHTML = '<div class="small">Materiais salvos! Limpe a lista para continuar.</div>';
    $('btnSaveMaterials').disabled = true;
    loadDashboardData(); // Atualiza contadores
    
  }catch(err){
    console.error('Erro ao salvar materiais', err);
    alert('Erro ao salvar materiais: ' + (err.message || err));
  }finally{
    this.disabled = false;
    this.textContent = 'Salvar materiais na turma';
  }
});


/* ---------------------------
   ALUNOS
   --------------------------- */
$('btnAddStudent').addEventListener('click', async function(){
  if(!db) return alert('Firestore não inicializado');
  const name = $('studentName').value.trim();
  const classId = $('studentClass').value;
  const studentId = $('studentIdInput').value.trim();

  if(!name || !classId || !studentId) return alert('Preencha o nome do aluno, a matrícula e selecione a turma.');

  this.disabled = true;
  this.textContent = 'Adicionando...';

  try{
    // Verifica se a matrícula já existe
    const existingSnap = await db.collection('students').where('studentId', '==', studentId).limit(1).get();
    if (!existingSnap.empty) {
        throw new Error(`Matrícula ${studentId} já está em uso pelo aluno(a) ${existingSnap.docs[0].data().name}.`);
    }

    await db.collection('students').add({
      name: name,
      studentId: studentId,
      classId: classId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    alert(`Aluno ${name} adicionado com sucesso!`);
    
    $('studentName').value = '';
    $('studentIdInput').value = '';
    // Manter a turma selecionada pode ser útil: $('studentClass').value = ''; 
    
    loadStudentsList($('studentsFilterClass').value); // Recarrega a lista
    loadDashboardData(); // Atualiza contadores
  }catch(err){
    console.error('Erro ao adicionar aluno', err);
    alert('Erro ao adicionar aluno: ' + (err.message || err));
  }finally{
    this.disabled = false;
    this.textContent = 'Adicionar';
  }
});

// Filtro de Alunos
if($('studentsFilterClass')) {
    $('studentsFilterClass').addEventListener('change', function() {
        loadStudentsList(this.value);
    });
}

/**
 * Carrega e renderiza a lista de alunos na aba de ação.
 * @param {string | null} filterClassId - O ID do documento da turma para filtrar, ou null para mostrar todos.
 */
async function loadStudentsList(filterClassId){
  if(!db) return;
  const list = $('studentsList');
  list.innerHTML = 'Carregando...';

  try {
    let query = db.collection('students').orderBy('name');
    
    // Aplica o filtro se um classId válido for fornecido
    if(filterClassId) {
        query = query.where('classId', '==', filterClassId);
    }

    const snap = await query.get();
    list.innerHTML = '';
    
    if(snap.empty){
      list.innerHTML = '<div class="small">Nenhum aluno encontrado. ' + (filterClassId ? 'Verifique a turma selecionada.' : '') + '</div>';
      return;
    }

    // Pré-carrega nomes das turmas para evitar múltiplas chamadas dentro do loop
    const classesMap = {};
    const classesSnap = await db.collection('classes').get();
    classesSnap.forEach(doc => classesMap[doc.id] = doc.data().name);

    snap.forEach(d => {
      const s = d.data();
      const classText = classesMap[s.classId] || 'Turma Desconhecida';
      const signatureStatus = s.signatureDataURL ? `<span style="color:var(--success); font-weight:600;">Assinado</span>` : `<span style="color:var(--danger); font-weight:600;">Pendente</span>`;

      const e = document.createElement('div');
      e.className = 'student-card';
      e.innerHTML = `
        <div>
          <strong>${s.name}</strong>
          <div class="small">Matrícula: ${s.studentId || 'N/A'} | Turma: ${classText}</div>
          <div class="small">Status Assinatura: ${signatureStatus}</div>
        </div>
        <div style="display:flex;gap:8px; align-items: center;">
          <button class="btn" style="padding: 6px 10px; font-size:12px; min-width: 80px;" onclick="openStudent('${d.id}')"> Checklist </button>
          <button class="btn secondary" style="padding: 6px 10px; font-size:12px; min-width: 80px;" onclick="generatePrintableChecklist('${d.id}')"> Imprimir Doc </button>
          <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteStudent('${d.id}', '${s.name.replace(/'/g, "\\'")}')"> Apagar </button>
        </div>
      `;
      list.appendChild(e);
    });
  } catch(err) {
    console.error('Erro loadStudentsList', err);
    list.innerHTML = `<div class="small" style="color:var(--danger)">Erro ao carregar alunos: ${err.message || err}</div>`;
  }
}

async function deleteStudent(studentId, studentName) {
    if (!confirm(`ATENÇÃO: Tem certeza que deseja APAGAR o aluno "${studentName}" e todos os seus registros de entrega (deliveries)?`)) {
        return;
    }
    
    try {
        // 1. Apagar Deliveries (Entregas)
        const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentId).get();
        const batch = db.batch();
        deliveriesSnap.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();

        // 2. Apagar o Aluno
        await db.collection('students').doc(studentId).delete();
        
        alert(`Aluno "${studentName}" e suas entregas foram apagados com sucesso.`);
        
        loadStudentsList($('studentsFilterClass').value); // Recarrega a lista
        loadDashboardData(); // Atualiza contadores
        
    } catch (err) {
        console.error('Erro ao apagar aluno', err);
        alert('Erro ao apagar aluno: ' + (err.message || err));
    }
}


/* ---------------------------
   DELIVERY (CHECKLIST) FUNCTIONS
   --------------------------- */

/**
 * Salva a quantidade de material entregue para um aluno.
 * Atualiza o documento 'deliveries' ou cria um novo.
 *
 * @param {string} studentDocId - ID do documento do aluno no Firestore.
 * @param {string} materialId - ID do documento do material no Firestore.
 * @param {number} requiredQty - Quantidade *necessária* deste material, conforme a turma.
 * @param {number} newQty - Quantidade *informada* como entregue pelo conferente.
 * @param {HTMLElement} [inputEl] - O elemento input (opcional, para feedback visual).
 * @param {HTMLElement} [remainingEl] - O elemento Span de "Faltam" (opcional, para feedback visual).
 * @param {boolean} [isMassUpdate=false] - Se é uma atualização em massa (para não mostrar alertas/feedback visual).
 * @returns {Promise<boolean>} Retorna true se a operação foi bem-sucedida.
 */
async function saveDelivery(studentDocId, materialId, requiredQty, newQty, inputEl, remainingEl, isMassUpdate = false) {
    if (!db) {
        if(!isMassUpdate) alert('Firestore não inicializado');
        return false;
    }

    // Validação da quantidade
    if (isNaN(newQty) || newQty < 0) {
        if (!isMassUpdate) alert("A quantidade deve ser um número não negativo.");
        if (inputEl) inputEl.value = inputEl.dataset.current; // Tenta reverter
        return false;
    }

    // Garante que a quantidade entregue não ultrapasse a necessária
    const quantityDelivered = Math.min(newQty, requiredQty);
    const currentClerkName = getCurrentClerkName();

    try {
        // 1. Tenta encontrar a entrega existente
        const deliverySnap = await db.collection('deliveries')
            .where('studentId', '==', studentDocId)
            .where('materialId', '==', materialId)
            .limit(1)
            .get();

        const deliveryData = {
            studentId: studentDocId,
            materialId: materialId,
            quantityDelivered: quantityDelivered,
            clerkName: currentClerkName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (deliverySnap.empty) {
            // 2. Não existe: cria um novo
            await db.collection('deliveries').add(deliveryData);
        } else {
            // 3. Existe: atualiza
            await db.collection('deliveries').doc(deliverySnap.docs[0].id).update(deliveryData);
        }

        // 4. Atualiza a interface (apenas se não for atualização em massa)
        if (inputEl) inputEl.dataset.current = quantityDelivered; // Atualiza o valor 'current'
        const remaining = requiredQty - quantityDelivered;
        if (remainingEl) {
            remainingEl.textContent = remaining;
            remainingEl.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)';
        }

        if (!isMassUpdate) {
            console.log('Entrega salva com sucesso.');
        }
        return true;

    } catch(err) {
        console.error('Erro ao salvar entrega', err);
        if (!isMassUpdate) alert('Erro ao salvar entrega: ' + (err.message || err));
        return false;
    }
}

/**
 * Salva a assinatura do responsável e o nome do conferente no documento do aluno (collection 'students').
 *
 * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 * @param {string} dataURL - A imagem da assinatura em Data URL (base64).
 * @param {string} signerName - O nome da pessoa que assinou (Responsável).
 * @param {string} clerkName - O nome do conferente (Administrador da Escola).
 * @returns {Promise<void>}
 */
async function saveSignature(studentDocId, dataURL, signerName, clerkName) {
    if (!db) throw new Error('Firestore não inicializado.');

    const data = {
        signatureDataURL: dataURL,
        signerName: signerName,
        clerkName: clerkName,
        signatureTimestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        // Atualiza o documento do aluno com os dados de assinatura e conferente
        await db.collection('students').doc(studentDocId).update(data);
    } catch(err) {
        console.error('Erro ao salvar assinatura', err);
        // Re-throw para que a função chamadora possa alertar o usuário
        throw new Error('Erro ao salvar assinatura e conferente: ' + (err.message || err));
    }
}

let signaturePadInstance = null; // Instância global do SignaturePad

/**
 * Abre o modal de checklist de materiais para um aluno específico.
 * Carrega a lista de materiais necessários, o status de entrega e a área de assinatura.
 *
 * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function openStudent(studentDocId){
    if(!db) return alert('Firestore não inicializado');

    // 1. Inicializa o modal (Se ainda não existir)
    let modal = $('checklist-modal');
    if(!modal){
        modal = document.createElement('div');
        modal.id = 'checklist-modal';
        document.body.appendChild(modal);
    }
    modal.innerHTML = `<div class="checklist-modal-box"></div>`; // Limpa o conteúdo e prepara a caixa
    
    try{
        // 2. Fetch Student Info
        const sdoc = await db.collection('students').doc(studentDocId).get();
        if(!sdoc.exists) return alert('Aluno não encontrado');
        const s = sdoc.data();
        
        // Fetch class name and store in modal dataset
        let className = 'Turma Desconhecida';
        if(s.classId){
            const classDoc = await db.collection('classes').doc(s.classId).get();
            if(classDoc.exists) className = classDoc.data().name;
        }

        // 3. Fetch Materials & Deliveries
        const matsnap = await db.collection('materials').where('classId','==',s.classId).get();
        const deliveriesSnap = await db.collection('deliveries').where('studentId','==',studentDocId).get();

        const materialsArray = [];
        matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
        materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome

        const deliveredQuantities = {}; // Mapeia {materialId: {quantity: N, by: clerkName, timestamp: T}}
        deliveriesSnap.forEach(d => {
            const data = d.data();
            deliveredQuantities[data.materialId] = { 
                quantity: data.quantityDelivered || 0, 
                by: data.clerkName || 'Desconhecido', 
                timestamp: data.timestamp 
            };
        });

        const box = modal.querySelector('.checklist-modal-box');
        
        // --- Header ---
        const header = document.createElement('div');
        header.style = 'padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;';
        header.innerHTML = `
            <div>
                <h3 class="section-title" style="margin: 0;">Checklist de Materiais</h3>
                <div class="small">Aluno: <strong>${s.name}</strong> (${s.studentId || 'N/A'}) - Turma: ${className}</div>
            </div>
            <button id="closeChecklist" class="btn secondary" style="padding: 6px 10px; font-size: 14px;">Fechar</button>
        `;
        box.appendChild(header);

        // --- List Area Header/Controls ---
        const listControls = document.createElement('div');
        listControls.style = 'padding: var(--pad); padding-bottom: 10px; border-bottom: 1px solid var(--border-color);';
        listControls.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 class="section-title" style="font-size: 16px; margin: 0;">Itens da Lista</h4>
                <button id="markCompleteBtn" class="btn secondary" style="padding: 6px 10px; font-size: 13px;">Marcar Todos como Entregues</button>
            </div>
        `;
        box.appendChild(listControls);

        // --- List Area ---
        const listArea = document.createElement('div');
        listArea.id = 'checklist-list-area';
        
        if (materialsArray.length === 0) {
            listArea.innerHTML = '<div class="small" style="padding: 16px;">Nenhum material cadastrado para esta turma.</div>';
        } else {
            materialsArray.forEach(m => {
                const id = m.id;
                const required = m.quantity || 1;
                const currentDelivery = deliveredQuantities[id];
                const currentQty = currentDelivery ? currentDelivery.quantity : 0;
                let remaining = required - currentQty;
                remaining = Math.max(0, remaining); // Garante que não é negativo
                
                const statusColor = remaining > 0 ? 'var(--danger)' : 'var(--success)';
                
                let detailsHtml = '';
                if(currentDelivery && currentDelivery.by) {
                    const timestamp = currentDelivery.timestamp ? new Date(currentDelivery.timestamp.toDate()).toLocaleDateString('pt-BR') : 'N/A';
                    detailsHtml = `<div class="small">Última conf.: ${currentDelivery.by} (${timestamp})</div>`;
                }
                
                const item = document.createElement('div');
                item.className = 'checklist-item';
                item.innerHTML = `
                    <div class="checklist-item-details">
                        <strong>${m.name}</strong> 
                        <div class="small">Requerido: ${required}</div>
                        ${detailsHtml}
                    </div>
                    <div class="checklist-item-controls">
                        <div class="row" style="gap: 5px; align-items:center;">
                             <div class="small">Entregue:</div>
                             <input type="number" min="0" max="${required}" 
                                    class="input delivery-input" value="${currentQty}" 
                                    data-current="${currentQty}" data-matid="${id}" data-required="${required}">
                        </div>
                        <div class="small" style="font-weight: 600; color: ${statusColor};">
                           Faltam: <span class="remaining-qty">${remaining}</span>
                        </div>
                        <button class="btn save-delivery-btn" style="padding: 6px 10px; font-size: 13px;">Salvar</button>
                    </div>
                `;
                listArea.appendChild(item);
            });
        }
        box.appendChild(listArea);

        // --- 4. Signature Area ---
        const hasExistingSignature = !!s.signatureDataURL;
        const currentClerkName = getCurrentClerkName();

        const signatureArea = document.createElement('div');
        signatureArea.id = 'signature-area';
        signatureArea.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                <h4 class="section-title" style="font-size: 16px; margin: 0;">Assinatura do Responsável</h4>
                <button id="toggleSignatureBtn" class="btn secondary" style="padding: 6px 10px; font-size: 13px;">
                    ${hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura'}
                </button>
            </div>
            
            <div id="signature-preview-container" style="display:${hasExistingSignature ? 'block' : 'none'}; margin-bottom: 10px;">
                <img id="signature-preview" src="${s.signatureDataURL || ''}" alt="Pré-visualização da Assinatura"/>
            </div>

            <div id="signature-content" style="display:${hasExistingSignature ? 'none' : 'block'};">
                <canvas id="signature-canvas"></canvas>
                <div class="row" style="margin-top: 5px;">
                    <input id="signerName" class="input" placeholder="Nome Completo do Responsável" value="${s.signerName || ''}" ${hasExistingSignature ? 'disabled' : ''}/>
                </div>
                <div class="row" style="margin-top: 8px;">
                    <button id="clearSignature" class="btn secondary" style="width: 100px;">Limpar</button>
                    <button id="saveSignature" class="btn" style="flex:1;">Salvar Assinatura & Conferente</button>
                </div>
            </div>
            <div class="small" style="margin-top: 10px;">Conferente atual: <strong>${currentClerkName}</strong></div>
        </div>
        `;
        box.appendChild(signatureArea);

        // --- 5. Exibe o modal ---
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden';

        // --- 6. Listeners do Modal ---
        $('closeChecklist').addEventListener('click', ()=>{
            modal.classList.remove('visible');
            document.body.style.overflow = '';
            loadStudentsList($('studentsFilterClass').value); // Recarrega a lista para atualizar o status de assinatura
        });

        // Toggle Assinatura
        const toggleBtn = $('toggleSignatureBtn');
        const signatureContent = $('signature-content');
        
        // Se houver assinatura prévia, já exibe por padrão
        if (hasExistingSignature) {
            signatureContent.style.display = 'none';
            document.getElementById('signature-preview-container').style.display = 'block';
        }

        toggleBtn.addEventListener('click', function() {
            const isVisible = signatureContent.style.display === 'block';
            signatureContent.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? (hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura') : (hasExistingSignature ? 'Ocultar Assinatura' : 'Ocultar');
            
            // Inicializa o SignaturePad apenas se for o primeiro acesso e a área estiver sendo aberta
            if(!hasExistingSignature && !signaturePadInstance && !isVisible) {
                 const canvas = $('signature-canvas');
                 signaturePadInstance = new SignaturePad(canvas, {
                     backgroundColor: 'rgb(255, 255, 255)', // Cor de fundo
                     penColor: 'rgb(0, 0, 0)' // Cor da caneta
                 });
                 // Redimensiona para garantir que a área de toque seja correta
                 function resizeCanvas() {
                    const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePadInstance.clear(); // Limpa ao redimensionar
                }
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
            }
            // Se já tem assinatura e o conteúdo está sendo exibido, mostra a preview
            document.getElementById('signature-preview-container').style.display = !isVisible && hasExistingSignature ? 'block' : 'none';
        });

        // Clear Signature
        $('clearSignature').addEventListener('click', ()=>{
            if(signaturePadInstance) signaturePadInstance.clear();
        });

        // Save Signature
        $('saveSignature').addEventListener('click', async function(){
            const signerName = $('signerName').value.trim();
            if(!signerName) return alert('Por favor, preencha o nome do Responsável que está assinando.');
            
            let dataURL = null;
            if(signaturePadInstance) {
                if (signaturePadInstance.isEmpty()) return alert('A área de assinatura está vazia. O responsável precisa assinar.');
                dataURL = signaturePadInstance.toDataURL();
            } else if (hasExistingSignature) {
                // Se já existia e não alterou, usa a URL existente
                dataURL = s.signatureDataURL;
            } else {
                 return alert('A área de assinatura está vazia. O responsável precisa assinar.');
            }

            this.disabled = true;
            this.textContent = 'Salvando...';

            try{
                await saveSignature(studentDocId, dataURL, signerName, currentClerkName);
                alert('Assinatura e Conferente salvos com sucesso!');
                this.textContent = 'Assinatura Salva';
                $('signerName').disabled = true;
                $('clearSignature').disabled = true;
                
                // Atualiza a preview
                document.getElementById('signature-preview').src = dataURL;
                document.getElementById('signature-preview-container').style.display = 'block';
                
            }catch(err){
                alert(err.message);
            }finally{
                // Se deu erro, reabilita o botão
                if(this.textContent !== 'Assinatura Salva') {
                    this.disabled = false;
                    this.textContent = 'Salvar Assinatura & Conferente';
                }
            }
        });


        // 7. Listeners para os itens de entrega
        listArea.querySelectorAll('.checklist-item').forEach(item => {
            const inputEl = item.querySelector('.delivery-input');
            const remainingEl = item.querySelector('.remaining-qty');
            const saveBtn = item.querySelector('.save-delivery-btn');
            const matId = inputEl.dataset.matid;
            const requiredQty = parseInt(inputEl.dataset.required, 10);

            // Listener para o input de mudança de valor
            inputEl.addEventListener('input', function() {
                const newQty = parseInt(this.value, 10);
                // Garante que a quantidade visualizada não ultrapasse o necessário
                const delivered = Math.min(newQty, requiredQty); 
                const remaining = requiredQty - delivered;
                
                remainingEl.textContent = remaining;
                remainingEl.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)';
            });

            // Listener para o botão Salvar
            saveBtn.addEventListener('click', async function(){
                this.disabled = true;
                this.textContent = '...';
                
                const newQty = parseInt(inputEl.value, 10);
                const success = await saveDelivery(studentDocId, matId, requiredQty, newQty, inputEl, remainingEl, false);
                
                this.disabled = false;
                this.textContent = 'Salvar';
                
                if (success) {
                    // Feedback visual temporário de sucesso
                    const originalBg = item.style.backgroundColor;
                    item.style.backgroundColor = 'var(--success-light)';
                    setTimeout(() => {
                        item.style.backgroundColor = originalBg;
                    }, 300);
                }
            });
        });

        // 8. Listener para o botão "Marcar Todos"
        $('markCompleteBtn').addEventListener('click', async function(){
            if(!confirm('Tem certeza que deseja marcar TODOS os materiais como ENTREGUES (Qtd. Entregue = Qtd. Necessária)?')) return;
            
            this.disabled = true;
            this.textContent = 'Marcando Todos...';

            const items = listArea.querySelectorAll('.checklist-item');
            const deliveryPromises = [];
            
            items.forEach(item => {
                const inputEl = item.querySelector('.delivery-input');
                const remainingEl = item.querySelector('.remaining-qty');
                const matId = inputEl.dataset.matid;
                const requiredQty = parseInt(inputEl.dataset.required, 10);
                
                // Força o valor do input para a quantidade requerida
                inputEl.value = requiredQty; 
                
                // Cria a promessa de atualização
                deliveryPromises.push(
                    saveDelivery(studentDocId, matId, requiredQty, requiredQty, inputEl, remainingEl, true)
                );
            });
            
            await Promise.all(deliveryPromises);
            
            this.disabled = false;
            this.textContent = 'Marcar Todos como Entregues';
            
            // Feedback visual no modal inteiro (temporário)
            const originalBg = box.style.backgroundColor;
            box.style.backgroundColor = 'var(--success-light)';
            setTimeout(() => {
                 box.style.backgroundColor = originalBg;
            }, 500);
            
            alert('Todos os materiais foram marcados como Entregues com sucesso!');
        });

    }catch(err){
        console.error('Erro openStudent', err);
        alert('Erro ao carregar checklist: ' + (err.message || err));
        modal.classList.remove('visible'); // Fecha o modal em caso de erro
        document.body.style.overflow = '';
    }
}

/* ---------------------------
   IMPRESSÃO DE DOCUMENTO (NOVA VERSÃO)
   --------------------------- */

/**
 * Gera um documento de checklist pronto para impressão em uma nova janela.
 * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function generatePrintableChecklist(studentDocId){
    if(!db) return alert('Firestore não inicializado');

    // 1. Fetch Student Info
    const sdoc = await db.collection('students').doc(studentDocId).get();
    if(!sdoc.exists) return alert('Aluno não encontrado');
    const s = sdoc.data();

    // 1.1. Fetch Class Name
    let className = s.classId || 'Turma Desconhecida (ID: N/A)';
    if(s.classId){
        try{
            const classDoc = await db.collection('classes').doc(s.classId).get();
            if(classDoc.exists) className = classDoc.data().name;
            else className = `Turma Desconhecida (ID: ${s.classId})`;
        }catch(e){
            console.error('Erro ao buscar nome da turma:', e);
            className = `Erro ao buscar Turma (ID: ${s.classId})`;
        }
    }


    // 2. Fetch Class Materials
    const matsnap = await db.collection('materials').where('classId','==',s.classId).get();
    
    // 3. Fetch Deliveries
    const deliveriesSnap = await db.collection('deliveries').where('studentId','==',studentDocId).get();
    const deliveredQuantities = {};
    deliveriesSnap.forEach(d=> deliveredQuantities[d.data().materialId] = d.data().quantityDelivered || 0);

    const materialsArray = [];
    matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
    materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome

    let checklistHtml = '';
    let totalMissing = 0;
    
    materialsArray.forEach(m => {
        const required = m.quantity || 1;
        const delivered = deliveredQuantities[m.id] || 0;
        const missing = required - delivered;
        if(missing > 0) totalMissing += missing;
        
        const status = missing === 0 ? 'COMPLETO' : (delivered > 0 ? 'INCOMPLETO' : 'PENDENTE');
        const statusColor = missing === 0 ? 'var(--success)' : 'var(--danger)';

        checklistHtml += `
            <div class="material-item-doc" style="font-size: 14px;">
                <div style="flex:1; width: 40%;">${m.name}</div>
                <div style="width: 15%; text-align: center;">${required}</div>
                <div style="width: 15%; text-align: center;">${delivered}</div>
                <div style="width: 15%; text-align: center; color: ${statusColor}; font-weight: 600;">${missing}</div>
                <div style="width: 15%; text-align: center;">${status}</div>
            </div>
        `;
    });

    // 4. Constrói o HTML da nova janela
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    const signatureImageHtml = s.signatureDataURL 
        ? `<img class="signature-image" src="${s.signatureDataURL}" alt="Assinatura Salva"/>`
        : `<div class="signature-image" style="display:flex; align-items:center; justify-content:center; font-size:12px; color:#888;">Área de Assinatura (Física)</div>`;
    
    const signatureInfo = s.signatureDataURL 
        ? `Entregue em: ${new Date(s.signatureTimestamp.toDate()).toLocaleDateString('pt-BR')}`
        : ``;

    const fullHtml = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Checklist - ${s.name}</title>
            <style>
                body { font-family: 'Inter', sans-serif; margin: 20px; }
                h1 { font-size: 20px; border-bottom: 2px solid #000; padding-bottom: 5px; }
                h2 { font-size: 16px; margin-bottom: 5px; }
                h3 { font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 25px; }
                .material-list { border: 1px solid #ccc; border-radius: 4px; margin-top: 10px; overflow: hidden; }
                .material-header-doc, .material-item-doc { display: flex; padding: 8px 10px; border-bottom: 1px solid #eee; align-items: center; }
                .material-header-doc { font-weight: bold; background: #eef4ff; color: #2b7cff; border-bottom: 2px solid #ccc; }
                .material-item-doc:last-child { border-bottom: none; }
                .material-item-doc > div { overflow: hidden; text-overflow: ellipsis; }
                .signature-area { display: flex; justify-content: space-between; margin-top: 50px; }
                .signature-block { display: inline-block; width: 48%; /* Aumentado um pouco para ocupar mais espaço */ vertical-align: top; text-align: center; }
                .signature-line { border-top: 1px solid #000; margin-top: 15px; /* Aumentado o espaço para a linha */ padding-top: 5px; font-weight: bold; }
                .signature-image { max-width: 100%; max-height: 100px; height: 100px; /* Altura fixa para o bloco da assinatura */ border: 1px solid #ccc; object-fit: contain; background: #f9f9f9; margin-bottom: 5px; }
                .footer-text { margin-top: 30px; text-align: center; font-size: 11px; color: #888; }
                /* Mídia de Impressão */ 
                @media print { 
                    body { font-size: 12px; margin: 10mm; /* Margens de impressão */ }
                    .signature-area { margin-top: 30px; }
                    .signature-line { margin-top: 10px; }
                    .material-item-doc, .material-header-doc { font-size: 11px; }
                }
            </style>
        </head>
        <body>
            <h1>Documento de Entrega de Material Escolar</h1>
            
            <h2>Aluno: ${s.name} (${s.studentId || 'N/A'})</h2>
            <h2>Turma: ${className}</h2>
            <div style="font-size: 14px; margin-top: 10px;">Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}</div>
            <div style="font-size: 14px; color: ${totalMissing === 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 700;">Status: ${totalMissing === 0 ? 'LISTA COMPLETA' : `FALTAM ${totalMissing} ITENS`}</div>

            <h3>Lista de Materiais</h3>
            <div class="material-list">
                <div class="material-header-doc">
                    <div style="flex:1; width: 40%;">Item</div>
                    <div style="width: 15%; text-align: center;">Requerido</div>
                    <div style="width: 15%; text-align: center;">Entregue</div>
                    <div style="width: 15%; text-align: center;">Falta</div>
                    <div style="width: 15%; text-align: center;">Status</div>
                </div>
                ${checklistHtml}
            </div>

            <div class="signature-area">
                <div class="signature-block">
                    ${signatureImageHtml}
                    <div class="signature-line">
                        RESPONSÁVEL (${s.signerName || 'Nome não Salvo'})
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: #888;">${signatureInfo}</div>
                </div>
                <div class="signature-block">
                    <div class="signature-image" style="border: 1px dashed #ccc;"></div>
                    <div class="signature-line">
                        CONFERENTE (Assinatura física)
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: #888;">Conferente Salvo: ${s.clerkName || 'N/A'}</div>
                </div>
            </div>

            <div class="footer-text">
                Este documento é uma via de conferência e entrega de material escolar. O responsável atesta o recebimento dos itens marcados como 'Entregues'.
            </div>
        </body>
        </html>
    `;

    printWindow.document.write(fullHtml);
    printWindow.document.close();
    printWindow.focus();
    
    // NOVO: Adiciona um listener para a nova janela forçar a impressão após o carregamento
    printWindow.onload = function() {
        printWindow.print();
        // Opcional: printWindow.close(); // Se quiser fechar a janela após a impressão/cancelamento
    };

}


/* --------------------------- DASHBOARD E RELATÓRIOS --------------------------- */

/**
 * Carrega a contagem total de entidades e o status resumido das turmas.
 */
async function loadDashboardData(){
    if(!db) return;

    try{
        // 1. Contadores
        const [cSnap, sSnap, mSnap] = await Promise.all([
            db.collection('classes').get(),
            db.collection('students').get(),
            db.collection('materials').get()
        ]);

        $('countClasses').textContent = cSnap.size;
        $('countStudents').textContent = sSnap.size;
        $('countMaterials').textContent = mSnap.size;

        const classes = {};
        cSnap.forEach(doc => {
            const data = doc.data();
            classes[doc.id] = { 
                name: data.name, 
                segment: data.segment, 
                totalStudents: 0, 
                completedStudents: 0 
            };
        });

        // 2. Materiais Requeridos (para o cálculo de status)
        const materials = {}; // { classId: { materialId: quantity, ... } }
        mSnap.forEach(doc => {
            const data = doc.data();
            if (!materials[data.classId]) {
                materials[data.classId] = {};
            }
            materials[data.classId][doc.id] = data.quantity || 1;
        });

        // 3. Status de Entrega por Aluno
        const deliveries = {}; // { studentId: { materialId: quantityDelivered, ... } }
        const dSnap = await db.collection('deliveries').get();
        dSnap.forEach(doc => {
            const data = doc.data();
            if (!deliveries[data.studentId]) {
                deliveries[data.studentId] = {};
            }
            deliveries[data.studentId][data.materialId] = data.quantityDelivered || 0;
        });

        // 4. Processamento de Status
        const students = sSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        students.forEach(student => {
            const classInfo = classes[student.classId];
            if (!classInfo) return; // Turma não existe

            classInfo.totalStudents += 1;
            
            let isComplete = true;
            const requiredMaterials = materials[student.classId] || {};
            const studentDeliveries = deliveries[student.id] || {};

            // Verifica se todos os materiais requeridos foram entregues
            for (const materialId in requiredMaterials) {
                const required = requiredMaterials[materialId];
                const delivered = studentDeliveries[materialId] || 0;
                
                if (delivered < required) {
                    isComplete = false;
                    break;
                }
            }

            if (isComplete) {
                classInfo.completedStudents += 1;
            }
        });

        // 5. Renderização do Dashboard (por segmento)
        const segments = {}; // { segment: { totalStudents: N, completedStudents: N, classes: [class1, class2] } }
        for (const classId in classes) {
            const c = classes[classId];
            if (!segments[c.segment]) {
                segments[c.segment] = { totalStudents: 0, completedStudents: 0, classes: [] };
            }
            segments[c.segment].totalStudents += c.totalStudents;
            segments[c.segment].completedStudents += c.completedStudents;
            segments[c.segment].classes.push(c.name);
        }

        const segmentOrder = ['infantil', 'fund1', 'fund2', 'medio', 'other'];
        const segmentNames = {
            'infantil': 'Ed. Infantil',
            'fund1': 'Fundamental I',
            'fund2': 'Fundamental II',
            'medio': 'Ensino Médio',
            'other': 'Outros'
        };

        const grid = $('classStatusGrid');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(auto-fit, minmax(220px, 1fr))`;

        segmentOrder.forEach(segmentKey => {
            const segmentData = segments[segmentKey];
            if (!segmentData || segmentData.totalStudents === 0) return;

            const percentage = segmentData.totalStudents > 0 
                ? Math.round((segmentData.completedStudents / segmentData.totalStudents) * 100) 
                : 0;

            const color = percentage === 100 ? 'var(--success)' : (percentage > 50 ? 'var(--warning)' : 'var(--danger)');
            const statusText = percentage === 100 ? 'Entrega Completa' : `${percentage}% Entregue`;

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="small" style="font-size: 14px;">${segmentNames[segmentKey]}</div>
                <div style="font-size:26px;font-weight:700;margin-top:4px; color:${color}">${segmentData.completedStudents}/${segmentData.totalStudents}</div>
                <div class="small" style="margin-top: 2px; font-weight: 600; color: ${color};">${statusText}</div>
                <div class="small" style="margin-top: 8px; color: var(--muted); font-style: italic;">Turmas: ${segmentData.classes.join(', ')}</div>
            `;
            grid.appendChild(card);
        });
        
    }catch(err){
        console.error('Erro loadDashboardData', err);
        $('classStatusGrid').innerHTML = `<div class="small" style="grid-column: 1 / -1; color:var(--danger)">Erro ao carregar dashboard: ${err.message || err}</div>`;
    }
}


/* --------------------------- QR CODES --------------------------- */

if($('btnGenerateQRs')) $('btnGenerateQRs').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');

    const classId = $('qrClassSelect').value;
    if(!classId) return alert('Selecione uma turma para gerar os QRs.');

    this.disabled = true;
    this.textContent = 'Gerando...';

    const gallery = $('qrGallery');
    gallery.innerHTML = '';

    try {
        const studentsSnap = await db.collection('students').where('classId', '==', classId).orderBy('name').get();

        if(studentsSnap.empty){
            gallery.innerHTML = '<div class="small" style="grid-column: 1 / -1;">Nenhum aluno encontrado nesta turma.</div>';
            return;
        }

        studentsSnap.forEach(d => {
            const s = d.data();
            const studentId = d.id;

            // Cria um contêiner para cada QR Code
            const qrContainer = document.createElement('div');
            qrContainer.style = 'border: 1px solid var(--border-color); padding: 10px; border-radius: var(--radius); text-align: center; background: var(--card);';
            qrContainer.innerHTML = `
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${s.name}</div>
                <div id="qr-${studentId}" style="width: 100%; height: 160px; margin: 0 auto; display: flex; align-items: center; justify-content: center;"></div>
                <div class="small" style="margin-top: 5px;">Matrícula: ${s.studentId || 'N/A'}</div>
                <a class="btn secondary" href="#" data-student-id="${studentId}" style="margin-top: 10px; padding: 6px 10px; font-size: 12px;">Download QR</a>
            `;
            gallery.appendChild(qrContainer);

            // Geração do QR Code. Usando 'print' para o código que vai na sacola.
            const url = getStudentQRUrl(studentId, 'print'); 
            const qrCodeDiv = document.getElementById(`qr-${studentId}`);
            
            // Adiciona o elemento img no div para que o download funcione
            const imgElement = document.createElement('img');
            qrCodeDiv.appendChild(imgElement);
            
            new QRCode(imgElement, {
                text: url,
                width: 160,
                height: 160,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // Listener para o botão de download
            qrContainer.querySelector('a').addEventListener('click', function(e) {
                e.preventDefault();
                const studentIdToDownload = this.getAttribute('data-student-id');
                const img = document.querySelector(`#qr-${studentIdToDownload} img`);
                if (img) {
                    const downloadLink = document.createElement('a');
                    downloadLink.href = img.src;
                    downloadLink.download = `QR_${s.studentId}_${s.name.replace(/\s/g, '_')}.png`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                }
            });
        });

    } catch(err) {
        console.error('Erro ao gerar QRs', err);
        gallery.innerHTML = `<div class="small" style="grid-column: 1 / -1; color:var(--danger)">Erro ao gerar QRs: ${err.message || err}</div>`;
    } finally {
        this.disabled = false;
        this.textContent = 'Gerar QRs';
    }
});


/* --------------------------- RELATÓRIOS --------------------------- */

async function isStudentComplete(studentDocId){
    if(!db) return { isComplete: false, classId: null };

    const sDoc = await db.collection('students').doc(studentDocId).get();
    if(!sDoc.exists) return { isComplete: false, classId: null };
    const s = sDoc.data();
    
    // 1. Fetch Materials
    const matSnap = await db.collection('materials').where('classId', '==', s.classId).get();
    
    // 2. Fetch Deliveries
    const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentDocId).get();
    const deliveredQuantities = {};
    deliveriesSnap.forEach(d => deliveredQuantities[d.data().materialId] = d.data().quantityDelivered || 0);

    let isComplete = true;
    
    matSnap.forEach(mDoc => {
        const material = mDoc.data();
        const required = material.quantity || 1;
        const delivered = deliveredQuantities[mDoc.id] || 0;
        
        if (delivered < required) {
            isComplete = false;
        }
    });

    return { isComplete: isComplete, classId: s.classId };
}

if($('btnRunReport')) $('btnRunReport').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');

    const classId = $('reportClass').value;
    if(!classId) return alert('Selecione uma turma para gerar o relatório.');

    this.disabled = true;
    this.textContent = 'Gerando...';

    try {
        // 1. Fetch Class Materials (para ter a lista de required)
        const matSnap = await db.collection('materials').where('classId', '==', classId).get();
        const materialsMap = {}; // { materialId: { name: 'Item', required: 4 } }
        matSnap.forEach(doc => {
            materialsMap[doc.id] = { 
                name: doc.data().name, 
                required: doc.data().quantity || 1 
            };
        });

        // 2. Fetch Students
        const studentsnap = await db.collection('students').where('classId', '==', classId).orderBy('name').get();
        
        // 3. Fetch Deliveries
        const dSnap = await db.collection('deliveries').get(); // Puxa todas as entregas (filtro depois)
        const deliveries = {}; // { studentId: { materialId: quantityDelivered, ... } }
        dSnap.forEach(doc => {
            const data = doc.data();
            if (!deliveries[data.studentId]) {
                deliveries[data.studentId] = {};
            }
            deliveries[data.studentId][data.materialId] = data.quantityDelivered || 0;
        });

        // 4. Calcular Totais Faltantes por Aluno
        const reportData = [];
        let totalMissingClass = 0;

        studentsnap.forEach(sDoc => {
            const student = sDoc.data();
            const studentId = sDoc.id;
            let missingCount = 0;
            let isComplete = true;

            for (const matId in materialsMap) {
                const required = materialsMap[matId].required;
                const delivered = (deliveries[studentId] && deliveries[studentId][matId]) || 0;
                const missing = required - delivered;
                
                if (missing > 0) {
                    missingCount += missing;
                    isComplete = false;
                }
            }
            
            totalMissingClass += missingCount;

            reportData.push({
                name: student.name,
                studentId: student.studentId,
                missingCount: missingCount,
                isComplete: isComplete,
                signatureStatus: student.signatureDataURL ? 'ASSINADO' : 'PENDENTE'
            });
        });


        // 5. Renderizar o Relatório (Tabela)
        const table = document.createElement('table');
        table.style = 'width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px;';
        table.innerHTML = `
            <thead>
                <tr style="background-color: var(--accent); color: white;">
                    <th style="padding: 10px; text-align: left;">Aluno</th>
                    <th style="padding: 10px; text-align: left;">Matrícula</th>
                    <th style="padding: 10px; text-align: center;">Faltam Itens (Unid.)</th>
                    <th style="padding: 10px; text-align: center;">Status Entrega</th>
                    <th style="padding: 10px; text-align: center;">Status Assinatura</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background-color: var(--accent-light); font-weight: 700;">
                    <td colspan="2" style="padding: 10px; border: 1px solid var(--border-color);">TOTAL GERAL DE ITENS FALTANTES NA TURMA:</td>
                    <td style="padding: 10px; border: 1px solid var(--border-color); text-align: center; color: var(--danger);">${totalMissingClass}</td>
                    <td colspan="2" style="padding: 10px; border: 1px solid var(--border-color); text-align: center;"></td>
                </tr>
                ${reportData.map(d => `
                    <tr style="background-color: ${d.isComplete ? 'var(--success-light)' : 'var(--danger-light)'};">
                        <td style="padding: 10px; border: 1px solid var(--border-color);">${d.name}</td>
                        <td style="padding: 10px; border: 1px solid var(--border-color);">${d.studentId}</td>
                        <td style="padding: 10px; border: 1px solid var(--border-color); text-align: center; color: ${d.isComplete ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${d.missingCount}</td>
                        <td style="padding: 10px; border: 1px solid var(--border-color); text-align: center; color: ${d.isComplete ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${d.isComplete ? 'COMPLETO' : 'INCOMPLETO'}</td>
                        <td style="padding: 10px; border: 1px solid var(--border-color); text-align: center; color: ${d.signatureStatus === 'ASSINADO' ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${d.signatureStatus}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;

        // 6. Insere o Relatório
        $('reportArea').innerHTML = ''; // Limpa a área
        
        if (studentsnap.empty) {
            $('reportArea').innerHTML = '<div class="small">Nenhum aluno encontrado nesta turma para gerar o relatório.</div>';
        } else {
            // Cria um contêiner para o botão e a tabela
            const contentWrapper = document.createElement('div');
            
            // Adiciona o botão de fechar no topo
            contentWrapper.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <button class="btn secondary" 
                            style="background-color: var(--muted); color: white;" 
                            onclick="document.getElementById('reportArea').innerHTML = ''">
                        &larr; Fechar Relatório
                    </button>
                </div>`;

            // Anexa a tabela de relatório ao contêiner
            contentWrapper.appendChild(table);
            
            // Insere o contêiner completo na área do relatório
            $('reportArea').appendChild(contentWrapper);
        }
        
    }catch(err){
        console.error('Erro Relatório',err);
        alert('Erro ao gerar relatório: ' + (err.message||err));
        this.disabled = false;
        this.textContent = 'Gerar relatório';
    }
});

/* --------------------------- END OF JS --------------------------- */
</script>
</html>
