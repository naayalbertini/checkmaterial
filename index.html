<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Material Escolar - Painel</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Cores */
      --bg:#f5f7fb;
      --card:#ffffff;
      --accent:#2b7cff;
      --accent-light: #eef4ff;
      --muted:#6b7280;
      --success:#16a34a;
      --success-light: #ecfdf5;
      --danger:#ef4444;
      --danger-light: #fef2f2;
      --warning: #f59e0b;
      --warning-light: #fffbeb;
      --glass: rgba(255,255,255,0.7);
      
      /* Geometria */
      --radius:10px;
      --pad:16px; 
      --border-color: #e6e9ef;
    }
    *{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    
    /* ATUALIZAÇÕES CRUCIAIS PARA O FOOTER FIXAR NO FINAL */
    body {
        margin: 0;
        background: var(--bg);
        min-height: 100vh; /* Garante altura mínima da tela */
        color: #111;
        padding-bottom: 0; 
        transition: overflow 0.3s;
        display: flex; /* NOVO: Habilita flexbox no body */
        flex-direction: column; /* NOVO: Organiza os filhos verticalmente */
    }
    
    /* Header (Cabeçalho) */
    header{display:flex;align-items:center;justify-content:space-between;padding:14px var(--pad);background:var(--card);box-shadow:0 1px 12px rgba(11,15,35,0.08);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;font-weight:700;}
    header .right{display:flex;gap:12px;align-items:center}
    
    /* Layout Principal */
    /* ATUALIZAÇÃO NO LAYOUT .container */
    .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 16px;
        flex-grow: 1; /* Faz o container principal crescer e empurrar o rodapé */
    }
    .grid{display:grid;grid-template-columns:300px 1fr;gap:20px} /* Desktop View */
    
    /* Cartões */
    .card{background:var(--card);padding:var(--pad);border-radius:var(--radius);box-shadow:0 4px 12px rgba(12,18,40,0.04);transition:transform 0.1s}
    .card:hover.clickable-card { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(12,18,40,0.08); } 
    .card.group-card { padding: 0; box-shadow: 0 4px 12px rgba(12,18,40,0.04); }
    
    /* Títulos e Texto */
    .section-title{font-weight:700;margin-bottom:12px;color:#0f172a;font-size:20px}
    .small{font-size:13px;color:var(--muted)}
    
    /* Navegação (Sidebar) - Desktop Default */
    nav {padding: 4px 0;}
    nav .nav-item{padding:10px;border-radius:8px;cursor:pointer;color:#111;display:flex;gap:10px;align-items:center;transition:background 0.2s, border 0.2s}
    nav .nav-item:hover{background:#f1f5f9;}
    nav .nav-item.active{background:var(--accent-light);color:var(--accent);font-weight:600;}
    
    /* Botões */
    .btn{display:inline-block;padding:10px 16px;border-radius:8px;background:var(--accent);color:white;text-decoration:none;border:none;cursor:pointer;transition:background 0.2s, opacity 0.2s;font-weight:500;font-size:14px;}
    .btn:hover:not(:disabled){filter:brightness(1.05); box-shadow: 0 2px 8px rgba(43,124,255,0.2);}
    .btn:disabled{opacity:0.6; cursor:not-allowed;}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid var(--border-color);padding:9px 15px;}
    .btn.secondary:hover:not(:disabled){background:#f8fafc; color:var(--accent); border-color:var(--accent-light); box-shadow: none;}

    /* Inputs/Formulários */
    .input, textarea, select{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--border-color);
      background:white;
      transition:border-color: 0.2s;
      font-size: 16px; /* MELHORIA MOBILE: Garante 16px para evitar zoom indesejado */
    }
    .input:focus, textarea:focus, select:focus {border-color: var(--accent); outline: none; box-shadow: 0 0 0 1px var(--accent-light);}
    
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center}
    .materials-list{max-height:300px;overflow:auto;padding-right:6px}
    
    /* Itens de Lista (Materiais/Alunos) */
    .material-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;background:#fcfdff;border:1px solid #eef2ff;transition:background 0.2s;}
    .material-item:hover{background:var(--accent-light); border-color:var(--accent);}
    
    .student-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:var(--radius);border:1px solid var(--border-color);background:var(--card);}
    .qr-img{width:120px;height:120px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center}
    
    /* Componentes Auxiliares */
    .hint{padding:10px;border-radius:8px;background:var(--accent-light);border:1px solid var(--accent);color:var(--accent);font-size:13px}
    .flex-col{display:flex;flex-direction:column;gap:10px}
    pre.rules{background:#0b1220;color:#f8fafc;padding:15px;border-radius:8px;overflow:auto;font-size:14px;line-height:1.4;}
    
    /* Overlay e Modal Checklist - NOVO/MELHORADO */
    #menuOverlay, #checklist-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        z-index: 15;
        display: none;
        transition: opacity 0.3s;
        opacity: 0;
    }
    #menuOverlay.visible, #checklist-modal.visible {
        opacity: 1;
        display: flex; 
        align-items: center;
        justify-content: center;
    }
    .checklist-modal-box {
        width: 650px; /* Largura maior para melhor visualização */
        max-width: 95vw;
        max-height: 90vh;
        overflow: hidden;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column; /* Essencial para que a lista cresça e empurre o rodapé */
    }
    #checklist-list-area {
        overflow-y: auto;
        padding: var(--pad);
        padding-top: 0;
        flex-grow: 1; /* Ocupa o espaço restante e permite a rolagem apenas nesta área */
    }
    .checklist-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 10px;
        border-bottom: 1px dashed var(--border-color);
    }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-item-details { flex-grow: 1; max-width: 60%; }
    .checklist-item-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    
    /* CORREÇÃO: Aumenta a largura para melhor visualização em todos os dispositivos */
    .delivery-input { 
        width: 60px !important; 
        padding: 4px; 
        border-radius: 4px; 
        border: 1px solid #ccc; 
        text-align: center; 
        font-size: 13px; /* Mantém 13px para não afetar o layout do modal */
    }

    /* Estilos para o Signature Pad */
    #signature-area {
        padding: var(--pad);
        background: #fcfdff;
        border-top: 1px solid var(--border-color); /* Mantido para separar do checklist */
    }
    #signature-canvas {
        border: 1px dashed var(--muted);
        border-radius: 4px;
        width: 100%;
        height: 150px;
        touch-action: none; /* Necessário para touch events e mouse */
    }
    #signature-preview {
        max-width: 100%;
        max-height: 150px;
        margin: 5px 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        object-fit: contain;
    }

    /* Estilos para o Documento de Impressão */
    .signature-block { display: inline-block; width: 45%; margin: 0 10px; vertical-align: top; }


    /* ------------------------------------- */
    /* ESTILOS DO RODAPÉ (FOOTER) - NOVO */
    /* ------------------------------------- */
    #main-footer {
        background-color: var(--card);
        color: var(--muted);
        padding: 20px var(--pad);
        text-align: center;
        font-size: 14px;
        margin-top: 40px; /* Espaço para separar do conteúdo principal */
        border-top: 1px solid var(--border-color); /* Linha sutil no topo */
        width: 100%;
        flex-shrink: 0; /* Impede que o footer encolha */
    }
    #main-footer .small-text {
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.8;
    }

    /* Mobile Responsiveness (Hamburguer Menu) */
    @media (max-width: 992px) {
      /* ... (Estilos Mobile Anteriores) ... */
      header .left-controls { display: flex; align-items: center; }
      #menuToggle { display: inline-block !important; margin-right: 10px; }

      .grid { grid-template-columns: 1fr; } /* Layout de coluna única */
      .container { padding: 0 12px; }
      
      /* Sidebar */
      #sidebar {
        position: fixed;
        top: 50px; /* Abaixo do header */
        left: 0;
        width: 250px; /* Largura do menu */
        height: calc(100vh - 50px);
        z-index: 20;
        padding: var(--pad);
        transform: translateX(-100%); /* Inicialmente oculto fora da tela */
        transition: transform 0.3s ease-in-out;
        box-shadow: 4px 0 12px rgba(0,0,0,0.3);
        background: var(--card); /* Fundo sólido */
        margin: 0; /* Remove margem */
        border-radius: 0; /* Remove cantos arredondados na lateral */
        overflow-y: auto; /* Scroll dentro do menu, se necessário */
      }
      #sidebar.active {
        transform: translateX(0);
      }
      #menu {
        display: block; 
        gap: 0;
        padding: 0;
      }
      nav .nav-item {
        flex: none;
        text-align: left;
        justify-content: flex-start;
        padding: 12px 10px;
        min-width: unset;
      }
      
      /* Dashboard counters em coluna */
      #dashboard .row { flex-direction: column; gap: 10px; }
      #dashboard .row .card { width: 100%; }

      /* Ajuste para botões e inputs em linhas */
      /* MELHORIA MOBILE: Força o empilhamento vertical para formulários em linha */
      .row:not(#dashboard .row) { 
        flex-direction: column; 
        flex-wrap: nowrap; /* Não quebra, apenas empilha */
        gap: 8px; /* Ajusta o espaçamento */
      }
      .row .input, .row select, .row button { 
        min-width: 100%; 
        flex-grow: 1; 
        width: 100% !important; /* Garante que os inputs ocupem a largura total */
      }
      /* FIM MELHORIA MOBILE */

      
      /* Turmas/Materiais em coluna */
      #materials .row { flex-direction: column; gap: 15px; }
      #materials .row > div { width: 100%; }

      /* QR Gallery ajuste */
      #qrGallery { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
      
      /* Alunos - botões em coluna */
      .student-card > div:last-child {
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      .student-card button { padding: 6px 10px; font-size: 12px; }

      /* Ajustes específicos para o modal de checklist em mobile */
      .checklist-modal-box {
          width: 95vw !important;
          max-height: 95vh !important; 
          padding: 0 !important; 
      }
      .checklist-item-details { max-width: 100%; }
      .checklist-item-controls { justify-content: space-between; gap: 8px; width: 100%; }
      .checklist-item { flex-direction: column; align-items: flex-start; gap: 8px; }
      #checklist-list-area { padding: 12px; flex-shrink: 1; } /* Garantindo o flex-shrink para que os outros elementos fixos possam aparecer */
      #signature-area { padding: 12px; flex-shrink: 0; }
    }
  </style>
</head>
<body>

<header>
  <div class="left-controls" style="display:flex; align-items:center;">
    <button id="menuToggle" class="btn secondary" style="display:none; padding: 6px 10px; font-size: 16px; margin-right: 10px;">
      ☰
    </button>
    <h1>Controle de Material Escolar</h1>
  </div>
  
  <div class="right">
    <div id="userEmail" class="small" style="font-weight: 500;"></div>
    <button id="btnLogout" class="btn secondary" style="display:none; padding: 6px 10px;">Sair</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card" id="sidebar">
      <div class="section-title" style="margin-bottom: 10px;">Menu de Navegação</div>
      <nav id="menu">
        <div class="nav-item active" data-tab="dashboard">Dashboard</div>
        <div class="nav-item" data-tab="import">Importar Lista</div>
        <div class="nav-item" data-tab="materials">Materiais</div>
        <div class="nav-item" data-tab="students">Alunos</div>
        <div class="nav-item" data-tab="qrs">Gerar QR</div>
        <div class="nav-item" data-tab="reports">Relatórios</div>
        <div class="nav-item" data-tab="help">Ajuda</div>
      </nav>
      <hr style="margin:16px 0 10px;border:none;border-top:1px solid #f1f5f9"/>
      <div class="small">Dica: faça login com uma conta administrativa antes de salvar dados.</div>
    </div>

    <div class="card" id="main" style="grid-column: 2 / -1;"> 
      <div id="loginPanel">
        <h2 class="section-title">Login administrativo</h2>
        <div class="small">Use Email / Senha (autenticação Firebase)</div>
        <div style="height:12px"></div>
        <input id="loginEmail" class="input" placeholder="email@escola.com"/>
        <div style="height:8px"></div>
        <input id="conferenteName" class="input" placeholder="Nome Completo do Conferente (Você)" value=""/>
        <div style="height:8px"></div>
        <input id="loginPass" class="input" type="password" placeholder="Senha"/>
        <div style="height:12px"></div>
        <div class="row">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnSignup" class="btn secondary">Criar conta (teste)</button>
        </div>
        <div style="height:12px"></div>
        <div id="loginMsg" class="small" style="color:var(--danger)"></div>
        <div style="height:12px"></div>
        <div id="libStatus" class="hint small">Verificando bibliotecas...</div>
      </div>

      <div id="appContent" style="display:none">
        <div id="dashboard" class="tab">
          <h2 class="section-title">Dashboard</h2>
          <div class="row" style="gap:14px; margin-bottom: 25px; flex-direction: row !important; flex-wrap: wrap;">
            <div style="flex:1" class="card">
              <div class="small">Turmas cadastradas</div>
              <div id="countClasses" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Alunos cadastrados</div>
              <div id="countStudents" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Materiais totais</div>
              <div id="countMaterials" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
          </div>

          <h3 class="section-title" style="border-top: 1px solid #eee; padding-top:15px; margin-top: 0;">Status de Entrega por Segmento</h3>
          <div id="classStatusGrid" style="display:grid; grid-template-columns: 1fr; gap:20px;">
            <div class="small" style="grid-column: 1 / -1;">Carregando status das turmas...</div>
          </div>
        </div>

        <div id="import" class="tab" style="display:none">
          <h2 class="section-title">Importar Lista de Materiais (Texto)</h2>
          <div class="small">Cole abaixo o texto da lista de materiais copiado diretamente do PDF. O sistema tentará extrair a quantidade e o nome do item.</div>
          <div style="height:12px"></div>
          <textarea id="materialText" class="input" rows="10" placeholder="Cole a lista de materiais aqui, uma linha por item (se possível) ou o texto bruto do PDF. Ex: 1 Caderno Universitário, 4 Lápis, etc."></textarea>
          <div style="height:12px"></div>
          <button id="btnParseText" class="btn">Processar Texto</button>
          <div style="height:20px"></div>
          
          <h3 class="section-title" style="font-size: 16px;">Salvar materiais na Turma</h3>
          <div class="row">
            <select id="targetClass" class="input">
              <option value="">Escolha uma turma (ou crie abaixo)</option>
            </select>
            <button id="btnNewClass" class="btn secondary">Nova Turma</button>
          </div>
          <div style="height:8px"></div>
          <div id="newClassRow" style="display:none" class="row">
            <input id="newClassName" class="input" placeholder="Nome da turma (ex: 2ª Série Ensino Médio)"/>
            <select id="newClassSegment" class="input" style="width:200px;">
                <option value="">Selecione o Segmento</option>
                <option value="infantil">Educação Infantil</option>
                <option value="fund1">Fundamental I</option>
                <option value="fund2">Fundamental II</option>
                <option value="medio">Ensino Médio</option>
                <option value="other">Outros</option>
            </select>
            <button id="saveNewClass" class="btn">Criar</button>
          </div>

          <div style="height:16px"></div>
          <div class="card materials-list" id="parsedMaterials">
            <div class="small">Cole o texto acima e clique em "Processar Texto".</div>
          </div>
          <div style="height:12px"></div>
          <div class="row" style="justify-content: flex-end;">
            <button id="btnClearParsed" class="btn secondary">Limpar Lista</button>
            <button id="btnSaveMaterials" class="btn">Salvar materiais na turma</button>
          </div>
        </div>

        <div id="materials" class="tab" style="display:none">
          <h2 class="section-title">Materiais & Turmas</h2>
          <div class="row" style="gap:20px; align-items: flex-start;">
            <div style="flex:1" class="card">
              <div class="section-title" style="font-size: 16px;">Turmas Cadastradas</div>
              <div id="classesList" style="margin-top:8px"></div>
            </div>
            <div style="flex:2" class="card">
              <div class="section-title" style="font-size: 16px;">Materiais da Turma Selecionada</div>
              <div id="materialsOfClass" style="margin-top:8px">
                <div class="small">Clique em "Abrir" em uma turma ao lado.</div>
              </div>
            </div>
          </div>
        </div>

        <div id="students" class="tab" style="display:none">
          <h2 class="section-title">Alunos</h2>
          <div class="small">Use o filtro abaixo para visualizar alunos por turma ou adicione um novo aluno.</div>
          <div style="height:12px"></div>

          <div class="row" style="margin-bottom: 12px;">
            <select id="studentsFilterClass" class="input" style="flex:1;">
              <option value="">Mostrar Todos os Alunos (Filtro)</option>
            </select>
          </div>

          <div class="row" style="align-items: flex-end;">
            <input id="studentName" class="input" placeholder="Nome do aluno"/>
            <select id="studentClass" class="input" style="width:220px; min-width: 150px;">
              <option value="">Escolha a turma (Novo Aluno)</option>
            </select>
            <input id="studentIdInput" class="input" placeholder="Matricula / Nº" style="width:140px; min-width: 100px;"/>
            <button id="btnAddStudent" class="btn" style="min-width: 100px;">Adicionar</button>
          </div>
          <div style="height:16px"></div>
          <div id="studentsList" class="flex-col"></div>
        </div>

        <div id="qrs" class="tab" style="display:none">
          <h2 class="section-title">Gerar QR para sacolas</h2>
          <div class="small">Selecione uma turma e gere QR para cada aluno (downloadable). Este QR abre o **Documento Simplificado** (para conferência) diretamente ao ser escaneado.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="qrClassSelect" class="input"></select>
            <button id="btnGenerateQRs" class="btn" style="min-width: 120px;">Gerar QRs</button>
          </div>
          <div style="height:20px"></div>
          <div id="qrGallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px"></div>
        </div>

        <div id="reports" class="tab" style="display:none">
          <h2 class="section-title">Relatórios</h2>
          <div class="small">Relatório rápido: contagem total de itens que faltam por aluno na turma selecionada.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="reportClass" class="input"></select>
            <button id="btnRunReport" class="btn" style="min-width: 120px;">Gerar relatório</button>
          </div>
          <div id="reportArea" style="margin-top:20px" class="flex-col"></div>
        </div>

        <div id="help" class="tab" style="display:none">
          <h2 class="section-title">Ajuda e Regras do Firebase</h2>
          <div class="small">Se o console exibir "Missing or insufficient permissions", veja abaixo as regras mínimas para testes (apenas para ambiente de desenvolvimento).</div>
          <div style="height:10px"></div>
          <div class="hint small">Cole este snippet nas Regras do Firestore (Console Firebase → Firestore → Regras) para testes locais:</div>
          <pre class="rules">
// Regras de exemplo PARA DESENVOLVIMENTO (NÃO USAR EM PRODUÇÃO sem ajuste)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null; // permite a usuários autenticados
    }
  }
}
          </pre>
          <div style="height:8px"></div>
          <div class="small">Se você quiser acesso público apenas para leitura (temporário), substitua a linha por: <code>if true</code> — mas isso torna seus dados públicos.</div>
        </div>

      </div>
    </div>
  </div>
</div> <footer id="main-footer">
    <div class="footer-content">
        <p>&copy; Todos os direitos reservados.</p>
        <p class="small-text">Desenvolvido por Nay Cordeiro - Escola Traços & Letras 2026.</p>
    </div>
</footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<script>
/* ============================
   CONFIGURAÇÃO DO FIREBASE
   Substitua com sua config.
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDNpnxlyLEu6OqP_fN3SRtWpSRvZFkuAXI",
  authDomain: "materialescolar-126da.firebaseapp.com",
  projectId: "materialescolar-126da",
  storageBucket: "materialescolar-126da.firebasestorage.app",
  messagingSenderId: "498322809036",
  appId: "1:498322809036:web:ee71b80840ee8dc2676269"
};

/* ---------------------------
   Verificações de biblioteca
   --------------------------- */
function setLibStatus(msg,isError){
  const el = document.getElementById('libStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
  el.style.background = isError ? 'var(--danger-light)' : 'var(--accent-light)';
  el.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
}

(function checkLibs(){
  const missing = [];
  if(typeof firebase === 'undefined') missing.push('Firebase');
  if(typeof QRCode === 'undefined') missing.push('QRCode');
  if(typeof SignaturePad === 'undefined') missing.push('SignaturePad');
  
  if(missing.length){
    setLibStatus('Atenção: bibliotecas faltando: ' + missing.join(', ') + '. Verifique conexão com CDNs.', true);
  } else {
    setLibStatus('Bibliotecas carregadas corretamente.');
  }
})();

/* ---------------------------
   Inicialização Firebase (apenas se carregou)
   --------------------------- */
let auth = null, db = null, storage = null;
try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
} catch(e){
  console.error('Erro inicializar Firebase:', e);
  setLibStatus('Erro ao inicializar Firebase. Veja console.', true);
}

/* ---------------------------
   Util / UI helpers
   --------------------------- */
function $(id){ return document.getElementById(id); }

/* Lógica do Menu Hambúrguer */
const sidebar = $('sidebar');
const menuToggle = $('menuToggle');
const menuOverlay = $('menuOverlay') || (function() {
    const el = document.createElement('div');
    el.id = 'menuOverlay';
    document.body.appendChild(el);
    return el;
})();

/**
 * Alterna a visibilidade do menu lateral (sidebar) e do overlay.
 * @param {boolean | null} force - Força o estado (true para abrir, false para fechar).
 */
function toggleMenu(force = null) {
    // Detecta se estamos em modo mobile (media query de 992px)
    const isMobileView = window.innerWidth <= 992;
    if (!isMobileView && force === null) return; // Não faz nada se for desktop e não for forçado
    
    const isVisible = force !== null ? force : !sidebar.classList.contains('active');
    
    if (isVisible) {
        sidebar.classList.add('active');
        menuOverlay.classList.add('visible');
        document.body.style.overflow = 'hidden'; // Evita scroll do conteúdo principal
    } else {
        sidebar.classList.remove('active');
        menuOverlay.classList.remove('visible');
        document.body.style.overflow = '';
    }
}

// Adiciona listeners para o toggle e para o overlay
if(menuToggle) menuToggle.addEventListener('click', () => toggleMenu());
if(menuOverlay) menuOverlay.addEventListener('click', () => toggleMenu(false));


function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.querySelectorAll('#menu .nav-item').forEach(i=>i.classList.remove('active'));
  $('loginPanel').style.display = auth && auth.currentUser ? 'none' : '';
  if(!auth || !auth.currentUser){
    $('appContent').style.display='none';
    return;
  }
  $('appContent').style.display='';
  const tab = $(name);
  if(tab) tab.style.display='';
  const menuItem = document.querySelector('#menu .nav-item[data-tab="'+name+'"]');
  if(menuItem) menuItem.classList.add('active');

  // FECHA o menu hambúrguer após a navegação em mobile
  if(window.innerWidth <= 992) {
      toggleMenu(false);
  }
}
document.querySelectorAll('#menu .nav-item').forEach(it=>{
  it.addEventListener('click', ()=> showTab(it.dataset.tab));
});

/* ---------------------------
   GERADOR DE URL QR CODE PARA CHECKLIST/IMPRESSÃO
   --------------------------- */
/**
 * Constrói a URL para escanear o QR Code de um aluno, definindo o modo de visualização.
 * O modo 'print' abre o documento simplificado (para impressão/visualização rápida), 
 * 'checklist' abre o modal completo (padrão para conferência).
 * * @param {string} studentId - O ID do documento do aluno no Firestore.
 * @param {'checklist' | 'print'} [mode='checklist'] - O modo de abertura do documento.
 * @returns {string} A URL completa com parâmetros.
 */
function getStudentQRUrl(studentId, mode = 'checklist') { 
    // Usando window.location.origin e pathname garante que funcione em diferentes ambientes (local ou hospedado)
    return window.location.origin + window.location.pathname + '?studentId=' + studentId + '&mode=' + mode;
}

/* ---------------------------
   AUTH (Email/Password) & INITIAL LOAD
   --------------------------- */

// NOVIDADE: Função helper para obter o nome do conferente atual
function getCurrentClerkName() {
    // 1. Tenta pegar do input/localStorage
    const inputName = $('conferenteName') ? $('conferenteName').value.trim() : null;
    let name = inputName || localStorage.getItem('conferenteName');
    
    // 2. Fallback: Se estiver logado e não houver nome, usa a parte do email antes do '@' (melhor que nada)
    if (!name && auth && auth.currentUser && auth.currentUser.email) {
        name = auth.currentUser.email.split('@')[0];
    }
    
    // 3. Fallback final
    return name || 'Conferente Desconhecido';
}

// NOVIDADE: Puxa o nome do localStorage ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
    const conferenteNameInput = $('conferenteName');
    if (conferenteNameInput) {
        const storedName = localStorage.getItem('conferenteName');
        if (storedName) {
            conferenteNameInput.value = storedName;
        }
    }
});


async function completeLoginAndLoad(){
    try {
        // Carrega dados em paralelo para agilizar
        await Promise.all([
            loadDashboardData(),
            loadClassesSelects(),
            // Usa o valor atual do filtro se já foi definido, senão carrega todos
            loadStudentsList($('studentsFilterClass') ? $('studentsFilterClass').value : null) 
        ]);
    } catch(e) {
        console.warn('Erro durante o carregamento inicial de dados após login:', e);
    }
    
    // --- FLUXO PARA SCANNER/CÂMERA ---
    const params = new URLSearchParams(window.location.search);
    const scannedStudentId = params.get('studentId');
    const scannedMode = params.get('mode');

    if (scannedStudentId) {
        // 1. Abre o documento para impressão (se for modo 'print') ou o modal de conferência (padrão/fallback).
        if (scannedMode === 'print') {
            generatePrintableChecklist(scannedStudentId);
        } else {
            openStudent(scannedStudentId);
        }
        // 2. Remove o parâmetro da barra de URL após a ação (evita loops)
        if (typeof history.replaceState === 'function') {
            history.replaceState(null, '', window.location.pathname); 
        }
    }
    
    showTab('dashboard');
}

if(auth){
  $('btnLogin').addEventListener('click', async ()=>{
    const e = $('loginEmail').value.trim();
    const p = $('loginPass').value;
    const n = $('conferenteName').value.trim(); // Pega o nome do conferente
    
    if (!n) {
        $('loginMsg').textContent = 'Erro: Preencha o Nome Completo do Conferente.';
        return;
    }
    localStorage.setItem('conferenteName', n); // Salva o nome no local storage

    try{
      await auth.signInWithEmailAndPassword(e,p);
      $('loginMsg').textContent='';
    }catch(err){
      $('loginMsg').textContent = err.message || 'Erro ao logar';
    }
  });
  
  $('btnSignup').addEventListener('click', async ()=>{
    const e = $('loginEmail').value.trim();
    const p = $('loginPass').value;
    const n = $('conferenteName').value.trim(); // Pega o nome do conferente
    
    if (!n) {
        $('loginMsg').textContent = 'Erro: Preencha o Nome Completo do Conferente.';
        return;
    }
    localStorage.setItem('conferenteName', n); // Salva o nome no local storage

    try{
      await auth.createUserWithEmailAndPassword(e,p);
      $('loginMsg').textContent='Conta criada com sucesso! Faça login.';
    }catch(err){
      $('loginMsg').textContent = err.message || 'Erro ao criar conta';
    }
  });
  
  $('btnLogout').addEventListener('click', async ()=>{
    try{
      await auth.signOut();
      $('userEmail').textContent='';
      $('btnLogout').style.display='none';
      showTab('loginPanel');
    }catch(err){
      console.error('Erro ao sair:', err);
      alert('Erro ao sair: ' + (err.message || err));
    }
  });

  auth.onAuthStateChanged(user => {
    if (user) {
      $('userEmail').textContent = user.email;
      $('btnLogout').style.display='inline-block';
      completeLoginAndLoad();
    } else {
      $('userEmail').textContent = 'Não logado';
      $('btnLogout').style.display='none';
      // Se não houver studentId na URL, mostra o painel de login
      const params = new URLSearchParams(window.location.search);
      if(!params.get('studentId')) {
        showTab('loginPanel');
      }
    }
  });
} else {
  // Se o Firebase não inicializou, garante que o login apareça.
  showTab('loginPanel');
  $('libStatus').textContent = 'Firebase não carregado. Funcionalidades de DB não estão ativas.';
  $('libStatus').style.color = 'var(--danger)';
}

/* ---------------------------
   DASHBOARD
   --------------------------- */

const SEGMENTS_MAP = {
    'infantil': 'Educação Infantil',
    'fund1': 'Fundamental I',
    'fund2': 'Fundamental II',
    'medio': 'Ensino Médio',
    'other': 'Outros'
};

async function loadDashboardData() {
    if (!db) return;
    try {
        // 1. Contadores
        const [classesSnap, studentsSnap, materialsSnap] = await Promise.all([
            db.collection('classes').get(),
            db.collection('students').get(),
            db.collection('materials').get()
        ]);

        const classesCount = classesSnap.size;
        const studentsCount = studentsSnap.size;
        const materialsCount = materialsSnap.size;

        $('countClasses').textContent = classesCount;
        $('countStudents').textContent = studentsCount;
        $('countMaterials').textContent = materialsCount;

        // 2. Status de Entrega por Segmento/Turma
        const classesData = {};
        classesSnap.forEach(doc => {
            classesData[doc.id] = { ...doc.data(), id: doc.id, totalStudents: 0, fullDeliveryStudents: 0 };
        });

        const studentPromises = [];
        studentsSnap.forEach(sDoc => {
            const s = sDoc.data();
            if (s.classId && classesData[s.classId]) {
                classesData[s.classId].totalStudents++;
                // Promessa para calcular se o aluno está completo
                studentPromises.push(checkStudentFullDelivery(sDoc.id));
            }
        });

        const studentDeliveryStatus = await Promise.all(studentPromises);
        studentDeliveryStatus.forEach(status => {
            if (status.isComplete && classesData[status.classId]) {
                classesData[status.classId].fullDeliveryStudents++;
            }
        });

        // 3. Agrupamento por Segmento
        const segmentsStatus = {};
        Object.values(classesData).forEach(c => {
            const segment = c.segment || 'other';
            if (!segmentsStatus[segment]) {
                segmentsStatus[segment] = {
                    name: SEGMENTS_MAP[segment] || 'Outros',
                    totalStudents: 0,
                    fullDeliveryStudents: 0,
                    classes: []
                };
            }
            segmentsStatus[segment].totalStudents += c.totalStudents;
            segmentsStatus[segment].fullDeliveryStudents += c.fullDeliveryStudents;
            segmentsStatus[segment].classes.push(c);
        });

        const grid = $('classStatusGrid');
        grid.innerHTML = '';
        const sortedSegments = Object.values(segmentsStatus).sort((a, b) => (a.name).localeCompare(b.name));

        sortedSegments.forEach(seg => {
            const segmentPercentage = seg.totalStudents > 0 
                ? Math.round((seg.fullDeliveryStudents / seg.totalStudents) * 100) : 0;
            const segmentColor = segmentPercentage === 100 ? 'var(--success)' : 'var(--danger)';
            
            let segmentHtml = `
            <div class="card group-card">
                <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 16px; background: var(--accent-light); border-radius: var(--radius) var(--radius) 0 0;">
                    <div style="font-weight:700; color:var(--accent); font-size: 15px;">${seg.name}</div>
                    <div style="font-size:20px; font-weight:700; color:${segmentColor}">${segmentPercentage}%</div>
                </div>
                <div style="padding: 10px 16px;">
            `;

            seg.classes.sort((a,b)=>(a.name).localeCompare(b.name)).forEach(c => {
                const percentage = c.totalStudents > 0 ? Math.round((c.fullDeliveryStudents / c.totalStudents) * 100) : 0;
                const statusColor = percentage === 100 ? 'var(--success)' : 'var(--warning)';
                
                segmentHtml += `
                <div class="material-item" style="border: none; background: transparent; padding: 8px 0; border-bottom: 1px dashed #f0f0f0;">
                    <div>
                        <strong>${c.name}</strong>
                        <div class="small" style="font-size:11px;">${c.fullDeliveryStudents} de ${c.totalStudents} alunos completos</div>
                    </div>
                    <div style="font-size:20px; font-weight:700; color:${statusColor}">${percentage}%</div>
                </div>
                `;
            });
            segmentHtml += `</div></div>`;
            grid.innerHTML += segmentHtml;
        });

        if (sortedSegments.length === 0) {
            grid.innerHTML = '<div class="small" style="grid-column: 1 / -1;">Nenhuma turma cadastrada.</div>';
        }

    } catch(err) {
        console.error('Erro loadDashboardData:', err);
        $('classStatusGrid').innerHTML = `<div class="hint small" style="color: var(--danger);">Erro ao carregar dados: ${err.message || 'Verifique sua conexão e regras do Firebase.'}</div>`;
    }
}

/* Função para filtrar alunos na aba students */
function filterStudentsByClass(classId) {
    $('studentsFilterClass').value = classId;
    loadStudentsList(classId);
    showTab('students');
}

/* --------------------------- IMPORT & MATERIALS --------------------------- */

function parseMaterialText() {
    const text = $('materialText').value;
    const lines = text.split('\n').filter(line => line.trim() !== '');
    const materials = [];
    const materialRegex = /^(\d+)\s*x?\s*([^\d].*)/i; // Ex: 10 Lápis | 10x Lápis
    
    lines.forEach(line => {
        const match = line.match(materialRegex);
        if (match) {
            let quantity = parseInt(match[1].trim(), 10);
            let name = match[2].trim().replace(/[,.:]$/, ''); // Remove pontuação no final
            if(name.length > 5 && quantity > 0) { // Filtro mínimo
                 materials.push({ name, quantity });
            }
        } else {
            // Tenta o caso onde a quantidade está no final (menos comum)
            const reverseRegex = /^(.*)\s+x?\s*(\d+)$/i;
            const reverseMatch = line.match(reverseRegex);
            if (reverseMatch) {
                let quantity = parseInt(reverseMatch[2].trim(), 10);
                let name = reverseMatch[1].trim().replace(/[,.:]$/, '');
                if(name.length > 5 && quantity > 0) {
                    materials.push({ name, quantity });
                }
            } else {
                 // Caso 3: apenas nome, assume 1
                const cleanedLine = line.trim().replace(/[,.:]$/, '');
                if(cleanedLine.length > 5) {
                    materials.push({ name: cleanedLine, quantity: 1 });
                }
            }
        }
    });

    // Filtra duplicatas e consolida quantidades
    const consolidated = materials.reduce((acc, item) => {
        const existing = acc.find(a => a.name.toLowerCase() === item.name.toLowerCase());
        if (existing) {
            existing.quantity += item.quantity;
        } else {
            acc.push(item);
        }
        return acc;
    }, []);
    
    // Renderiza
    const list = $('parsedMaterials');
    if(consolidated.length === 0) {
        list.innerHTML = '<div class="small" style="color:var(--danger)">Não foi possível extrair materiais. Tente formatar a lista com "Quantidade Nome" (ex: 2 Caderno).</div>';
        $('btnSaveMaterials').disabled = true;
        return;
    }
    
    list.innerHTML = '';
    consolidated.forEach(m => {
        const div = document.createElement('div');
        div.className = 'material-item';
        div.innerHTML = `
            <div>
                <strong>${m.name}</strong>
                <div class="small">Qtd. Detectada: ${m.quantity}</div>
            </div>
            <div style="color:var(--success); font-weight:600;">OK</div>
        `;
        list.appendChild(div);
    });
    
    $('btnSaveMaterials').disabled = false;
}

if($('btnParseText')) $('btnParseText').addEventListener('click', parseMaterialText);
if($('btnClearParsed')) $('btnClearParsed').addEventListener('click', ()=>{
    $('parsedMaterials').innerHTML = '<div class="small">Cole o texto acima e clique em "Processar Texto".</div>';
    $('materialText').value = '';
    $('btnSaveMaterials').disabled = true;
});

if($('btnSaveMaterials')) $('btnSaveMaterials').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');
    
    const classId = $('targetClass').value;
    if(!classId) return alert('Por favor, selecione uma turma antes de salvar.');
    
    const materials = [];
    const list = $('parsedMaterials');
    list.querySelectorAll('.material-item').forEach(item => {
        const name = item.querySelector('strong').textContent;
        const quantityText = item.querySelector('.small').textContent;
        const quantityMatch = quantityText.match(/Qtd\. Detectada: (\d+)/);
        if (quantityMatch) {
            materials.push({ name, quantity: parseInt(quantityMatch[1], 10), classId });
        }
    });
    
    if(materials.length === 0) return alert('Nenhum material válido para salvar.');
    
    this.disabled = true;
    this.textContent = 'Salvando...';
    
    try{
        const batch = db.batch();
        materials.forEach(m => {
            // Tenta buscar material existente para evitar duplicatas, mas simplificando vamos apenas adicionar.
            // Para um sistema mais robusto, seria bom verificar se o (name + classId) já existe.
            const newMaterialRef = db.collection('materials').doc();
            batch.set(newMaterialRef, {
                name: m.name,
                quantity: m.quantity,
                classId: m.classId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        await batch.commit();
        alert(`Sucesso! ${materials.length} materiais salvos na turma.`);
        
        // Limpa a interface
        $('materialText').value = '';
        $('parsedMaterials').innerHTML = '<div class="small">Materiais salvos! Limpe a lista para continuar.</div>';
        $('btnSaveMaterials').disabled = true;
        loadDashboardData(); // Atualiza contadores
        
    }catch(err){
        console.error('Erro ao salvar materiais', err);
        alert('Erro ao salvar materiais: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Salvar materiais na turma';
    }
});

async function loadClassesSelects(){
    if(!db) return;
    const selects = [$('targetClass'), $('studentClass'), $('studentsFilterClass'), $('qrClassSelect'), $('reportClass')];
    
    try{
        const snap = await db.collection('classes').orderBy('name').get();
        const optionsHtml = ['<option value="">Escolha a turma</option>'];
        
        snap.forEach(d => {
            const c = d.data();
            optionsHtml.push(`<option value="${d.id}">${c.name} (${SEGMENTS_MAP[c.segment] || 'Outros'})</option>`);
        });
        
        selects.forEach(sel => {
            if(sel){
                const currentValue = sel.value;
                sel.innerHTML = optionsHtml.join('');
                // Para o filtro de alunos, a primeira opção é "Mostrar Todos"
                if(sel.id === 'studentsFilterClass') {
                    sel.innerHTML = '<option value="">Mostrar Todos os Alunos (Filtro)</option>' + optionsHtml.slice(1).join('');
                }
                // Tenta manter o valor selecionado
                if (currentValue && sel.querySelector(`option[value="${currentValue}"]`)) {
                    sel.value = currentValue;
                }
            }
        });
    }catch(err){
        console.error('Erro loadClassesSelects', err);
    }
}

if($('btnNewClass')) $('btnNewClass').addEventListener('click', ()=>{
    const row = $('newClassRow');
    row.style.display = row.style.display === 'none' ? 'flex' : 'none';
});

if($('saveNewClass')) $('saveNewClass').addEventListener('click', async function(){
    const name = $('newClassName').value.trim();
    const segment = $('newClassSegment').value;
    
    if(!name || !segment) return alert('Preencha o nome e selecione o segmento da turma.');
    
    this.disabled = true;
    this.textContent = 'Criando...';
    try{
        await db.collection('classes').add({
            name: name,
            segment: segment,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        $('newClassName').value = '';
        $('newClassSegment').value = '';
        $('newClassRow').style.display = 'none';
        loadClassesSelects(); // Atualiza todos os selects
        loadClassesList(); // Recarrega a lista de turmas na aba materials
        loadDashboardData(); // Atualiza contadores
        alert('Turma criada com sucesso!');
    }catch(err){
        console.error('Erro ao criar turma', err);
        alert('Erro ao criar turma: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Criar';
    }
});

/**
 * Carrega e renderiza a lista de turmas na aba "Materiais & Turmas", 
 * incluindo os botões para abrir os materiais e apagar a turma.
 */
async function loadClassesList(){
    if(!db) return;
    const list = $('classesList');
    list.innerHTML = 'Carregando...';
    try {
        const snap = await db.collection('classes').orderBy('name').get();
        list.innerHTML = '';
        if(snap.empty){
            list.innerHTML = '<div class="small">Nenhuma turma cadastrada.</div>';
            return;
        }
        snap.forEach(d => {
            const c = d.data();
            const e = document.createElement('div');
            e.className = 'material-item'; // Reutilizando o estilo do item
            e.innerHTML = `
                <div>
                    <strong>${c.name}</strong>
                    <div class="small">${SEGMENTS_MAP[c.segment] || 'Segmento Desconhecido'}</div>
                </div>
                <div style="display:flex;gap:6px">
                    <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="loadMaterialsOfClass('${d.id}')">Abrir</button>
                    <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteClass('${d.id}', '${c.name.replace(/'/g, "\\'")}')">Apagar</button>
                </div>
            `;
            list.appendChild(e);
        });
    } catch(err) {
        console.error('Erro loadClassesList', err);
        list.innerHTML = '<div class="small" style="color:var(--danger)">Erro ao carregar turmas.</div>';
    }
}

async function deleteClass(classId, className) {
    if (!confirm(`Tem certeza que deseja apagar a turma "${className}" e TODOS os materiais/alunos/entregas vinculados a ela? Esta ação é irreversível!`)) {
        return;
    }

    try {
        // 1. Apagar Materiais
        const materialsSnap = await db.collection('materials').where('classId', '==', classId).get();
        const materialBatch = db.batch();
        materialsSnap.forEach(doc => materialBatch.delete(doc.ref));
        await materialBatch.commit();

        // 2. Apagar Alunos
        const studentsSnap = await db.collection('students').where('classId', '==', classId).get();
        const studentBatch = db.batch();
        studentsSnap.forEach(doc => studentBatch.delete(doc.ref));
        await studentBatch.commit();
        
        // 3. Apagar Entregas
        const deliveriesSnap = await db.collection('deliveries').where('classId', '==', classId).get();
        const deliveryBatch = db.batch();
        deliveriesSnap.forEach(doc => deliveryBatch.delete(doc.ref));
        await deliveryBatch.commit();
        
        // 4. Apagar a Turma
        await db.collection('classes').doc(classId).delete();

        alert(`Turma "${className}" e todos os dados associados foram apagados com sucesso.`);
        loadClassesList();
        loadClassesSelects();
        loadDashboardData();
        $('materialsOfClass').innerHTML = '<div class="small">Clique em "Abrir" em uma turma ao lado.</div>';

    } catch (err) {
        console.error('Erro ao apagar turma e dados relacionados', err);
        alert('Erro ao apagar turma: ' + (err.message || err));
    }
}

/**
 * Carrega e renderiza a lista de materiais pertencentes a uma turma específica 
 * na aba "Materiais & Turmas", exibindo o nome da turma.
 * @param {string} classId - O ID do documento da turma no Firestore.
 */
async function loadMaterialsOfClass(classId) {
    if(!db) return;
    const container = $('materialsOfClass');
    container.innerHTML = 'Carregando materiais...';
    try{
        // 1. Fetch Class Name
        const classDoc = await db.collection('classes').doc(classId).get();
        const className = classDoc.exists ? classDoc.data().name : 'Turma Desconhecida';

        // 2. Fetch Materials
        const snap = await db.collection('materials').where('classId','==',classId).get();
        
        container.innerHTML = `<h3 class="section-title" style="font-size: 16px; margin-top: 0;">Materiais: ${className}</h3>`;
        
        if(snap.empty){
            container.innerHTML += '<div class="small">Nenhum material cadastrado para esta turma. Use a aba "Importar Lista".</div>';
            return;
        }

        const listHtml = snap.docs.map(d => {
            const m = d.data();
            return `
                <div class="material-item">
                    <div>
                        <strong>${m.name}</strong>
                        <div class="small">Qtd. Requerida: ${m.quantity}</div>
                    </div>
                    <div class="row" style="gap: 5px;">
                        <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="editMaterial('${d.id}', ${m.quantity})">Editar Qtd</button>
                        <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteMaterial('${d.id}', '${m.name.replace(/'/g, "\\'")}')">Apagar</button>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML += `<div class="list">${listHtml}</div>`;
        
    }catch(err){
        console.error('Erro loadMaterialsOfClass', err);
        container.innerHTML = `<div class="small" style="color:var(--danger)">Erro ao carregar materiais: ${err.message || err}</div>`;
    }
}

async function editMaterial(materialId, currentQuantity) {
    const newQty = prompt(`Editar Quantidade Requerida (Atual: ${currentQuantity}):`);
    if (newQty === null || isNaN(parseInt(newQty, 10)) || parseInt(newQty, 10) < 1) {
        if (newQty !== null) alert('Quantidade inválida.');
        return;
    }
    const quantity = parseInt(newQty, 10);
    try {
        await db.collection('materials').doc(materialId).update({ quantity });
        alert('Quantidade atualizada com sucesso. Recarregue a lista de materiais para conferir.');
        // Força recarregar a lista se possível, mas aqui vamos focar no reload do tab para simplicidade
        // loadMaterialsOfClass(classId_currently_viewed)
    } catch (err) {
        console.error('Erro ao editar material', err);
        alert('Erro ao editar material: ' + (err.message || err));
    }
}

async function deleteMaterial(materialId, materialName) {
    if (!confirm(`Tem certeza que deseja apagar o material "${materialName}" desta turma?`)) {
        return;
    }
    try {
        await db.collection('materials').doc(materialId).delete();
        alert(`Material "${materialName}" apagado com sucesso.`);
        // Note: Deveria recarregar loadMaterialsOfClass(classId) mas por simplicidade de JS inline vamos manter o alert
    } catch (err) {
        console.error('Erro ao apagar material', err);
        alert('Erro ao apagar material: ' + (err.message || err));
    }
}

/* --------------------------- STUDENTS --------------------------- */

if($('btnAddStudent')) $('btnAddStudent').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');
    
    const name = $('studentName').value.trim();
    const classId = $('studentClass').value;
    const studentId = $('studentIdInput').value.trim();
    
    if(!name || !classId) return alert('Preencha o Nome e selecione a Turma do aluno.');
    
    this.disabled = true;
    this.textContent = 'Adicionando...';
    
    try{
        await db.collection('students').add({
            name: name,
            classId: classId,
            studentId: studentId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            signatureDataURL: null, // Campo para armazenar a assinatura
            signerName: null,      // Campo para armazenar o nome do responsável
            clerkName: null        // Campo para armazenar o nome do conferente que finalizou
        });
        
        $('studentName').value = '';
        $('studentIdInput').value = '';
        loadStudentsList($('studentsFilterClass').value); // Recarrega com o filtro atual
        loadDashboardData(); // Atualiza contadores
        alert('Aluno adicionado com sucesso!');
    }catch(err){
        console.error('Erro ao adicionar aluno', err);
        alert('Erro ao adicionar aluno: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Adicionar';
    }
});

$('studentsFilterClass').addEventListener('change', function(){
    loadStudentsList(this.value);
});

/**
 * Carrega e renderiza a lista de alunos na aba "Alunos",
 * permitindo a filtragem por turma. Exibe o status da assinatura e botões de ação.
 * @param {string | null} filterClassId - O ID do documento da turma para filtrar, ou null para mostrar todos.
 */
async function loadStudentsList(filterClassId){
    if(!db) return;
    const list = $('studentsList');
    list.innerHTML = 'Carregando...';
    try {
        let query = db.collection('students').orderBy('name');
        
        // Aplica o filtro se um classId válido for fornecido
        if(filterClassId) {
            query = query.where('classId', '==', filterClassId);
        }
        
        const snap = await query.get();
        list.innerHTML = '';
        
        if(snap.empty){
            list.innerHTML = '<div class="small">Nenhum aluno encontrado. ' + (filterClassId ? 'Verifique a turma selecionada.' : '') + '</div>';
            return;
        }

        // Pré-carrega nomes das turmas para evitar múltiplas chamadas dentro do loop
        const classesMap = {};
        const classesSnap = await db.collection('classes').get();
        classesSnap.forEach(doc => classesMap[doc.id] = doc.data().name);

        snap.forEach(d => {
            const s = d.data();
            const classText = classesMap[s.classId] || 'Turma Desconhecida';
            
            const signatureStatus = s.signatureDataURL 
                ? `<span style="color:var(--success); font-weight:600;">Assinado</span>` 
                : `<span style="color:var(--danger); font-weight:600;">Pendente</span>`;

            const e = document.createElement('div');
            e.className = 'student-card';
            e.innerHTML = `
                <div>
                    <strong>${s.name}</strong>
                    <div class="small">Matrícula: ${s.studentId || 'N/A'} | Turma: ${classText}</div>
                    <div class="small">Status Assinatura: ${signatureStatus}</div>
                </div>
                <div style="display:flex;gap:8px; align-items: center;">
                    <button class="btn" style="padding: 6px 10px; font-size:12px; min-width: 80px;" onclick="openStudent('${d.id}')">
                        Checklist
                    </button>
                    <button class="btn secondary" style="padding: 6px 10px; font-size:12px; min-width: 80px;" onclick="generatePrintableChecklist('${d.id}')">
                        Imprimir Doc
                    </button>
                    <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteStudent('${d.id}', '${s.name.replace(/'/g, "\\'")}', '${s.classId}')">
                        Apagar
                    </button>
                </div>
            `;
            list.appendChild(e);
        });

    } catch(err) {
        console.error('Erro loadStudentsList', err);
        list.innerHTML = `<div class="small" style="color:var(--danger)">Erro ao carregar alunos: ${err.message || err}</div>`;
    }
}

async function deleteStudent(studentDocId, studentName, classId) {
    if (!confirm(`Tem certeza que deseja apagar o aluno "${studentName}" e todos os dados de entrega vinculados a ele? Esta ação é irreversível!`)) {
        return;
    }
    try {
        // 1. Apagar Entregas
        const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentDocId).get();
        const deliveryBatch = db.batch();
        deliveriesSnap.forEach(doc => deliveryBatch.delete(doc.ref));
        await deliveryBatch.commit();
        
        // 2. Apagar Aluno
        await db.collection('students').doc(studentDocId).delete();

        alert(`Aluno "${studentName}" e dados de entrega apagados com sucesso.`);
        loadStudentsList($('studentsFilterClass').value); // Recarrega a lista
        loadDashboardData(); // Atualiza contadores

    } catch (err) {
        console.error('Erro ao apagar aluno e dados relacionados', err);
        alert('Erro ao apagar aluno: ' + (err.message || err));
    }
}

/* --------------------------- CHECKLIST MODAL & DELIVERIES --------------------------- */

/**
 * Persiste a quantidade de um material entregue para um aluno no Firestore (collection 'deliveries').
 * Registra a quantidade entregue, a quantidade requerida, e o nome do conferente.
 * * @param {string} studentDocId - ID do documento do aluno no Firestore.
 * @param {string} materialId - ID do documento do material no Firestore.
 * @param {number} requiredQty - Quantidade *necessária* deste material, conforme a turma.
 * @param {number} newQty - Quantidade *informada* como entregue pelo conferente.
 * @param {HTMLElement} [inputEl] - O elemento input (opcional, para feedback visual).
 * @param {HTMLElement} [remainingEl] - O elemento Span de "Faltam" (opcional, para feedback visual).
 * @param {boolean} [isMassUpdate=false] - Se é uma atualização em massa (para não mostrar alertas/feedback visual).
 * @returns {Promise<boolean>} Retorna true se a operação foi bem-sucedida.
 */
async function saveDelivery(studentDocId, materialId, requiredQty, newQty, inputEl, remainingEl, isMassUpdate = false) {
    if (!db) {
        if(!isMassUpdate) alert('Firestore não inicializado');
        return false;
    }

    // Validação da quantidade
    if (isNaN(newQty) || newQty < 0) {
        if (!isMassUpdate) alert("A quantidade deve ser um número não negativo.");
        if (inputEl) inputEl.value = inputEl.dataset.current; // Tenta reverter
        return false;
    }
    
    // Garante que a quantidade entregue não ultrapasse a necessária
    const quantityDelivered = Math.min(newQty, requiredQty);
    const currentClerkName = getCurrentClerkName();

    try {
        // 1. Tenta encontrar a entrega existente
        const deliverySnap = await db.collection('deliveries')
            .where('studentId', '==', studentDocId)
            .where('materialId', '==', materialId)
            .limit(1)
            .get();
            
        const deliveryData = {
            studentId: studentDocId,
            materialId: materialId,
            quantityDelivered: quantityDelivered,
            clerkName: currentClerkName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            classId: document.getElementById('checklist-modal').dataset.classId // Armazena classId para facilitar relatórios/deletes
        };
        
        if (deliverySnap.empty) {
            // Cria novo documento
            await db.collection('deliveries').add(deliveryData);
        } else {
            // Atualiza documento existente
            const docRef = deliverySnap.docs[0].ref;
            await docRef.update(deliveryData);
        }

        // 2. Feedback visual (se os elementos foram passados)
        if (inputEl && remainingEl) {
            const remaining = requiredQty - quantityDelivered;
            inputEl.value = quantityDelivered;
            inputEl.dataset.current = quantityDelivered; // Atualiza o valor atual no dataset
            remainingEl.textContent = remaining;
            remainingEl.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)';
        }

        if (!isMassUpdate) {
             // Atualiza o nome do conferente no item (se ele existe)
            const itemDiv = inputEl.closest('.checklist-item');
            if(itemDiv){
                let clerkText = itemDiv.querySelector('.clerk-name-text');
                if(!clerkText){
                    clerkText = document.createElement('div');
                    clerkText.className = 'small clerk-name-text';
                    clerkText.style = "font-size:11px; margin-top: 2px;";
                    itemDiv.querySelector('.checklist-item-details').appendChild(clerkText);
                }
                clerkText.textContent = `Última entrega por: ${currentClerkName}`;
            }
        }
        
        return true;

    } catch(err) {
        console.error('Erro ao salvar entrega', err);
        if (!isMassUpdate) alert('Erro ao salvar entrega: ' + (err.message || err));
        return false;
    }
}


/**
 * Salva a assinatura do responsável e o nome do conferente no documento do aluno (collection 'students').
 * * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 * @param {string} dataURL - A imagem da assinatura em Data URL (base64).
 * @param {string} signerName - O nome da pessoa que assinou (Responsável).
 * @param {string} clerkName - O nome do conferente (Administrador da Escola).
 * @returns {Promise<void>}
 */
async function saveSignature(studentDocId, dataURL, signerName, clerkName) {
    if (!db) throw new Error('Firestore não inicializado.');
    
    const data = {
        signatureDataURL: dataURL,
        signerName: signerName,
        clerkName: clerkName,
        signatureTimestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        // Atualiza o documento do aluno com os dados de assinatura e conferente
        await db.collection('students').doc(studentDocId).update(data);
    } catch(err) {
        console.error('Erro ao salvar assinatura', err);
        // Re-throw para que a função chamadora possa alertar o usuário
        throw new Error('Erro ao salvar assinatura e conferente: ' + (err.message || err));
    }
}

let signaturePadInstance = null; // Instância global do SignaturePad

/**
 * Abre o modal de checklist de materiais para um aluno específico.
 * Carrega a lista de materiais necessários, o status de entrega e a área de assinatura.
 * * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function openStudent(studentDocId){
    if(!db) return alert('Firestore não inicializado');

    // 1. Inicializa o modal (Se ainda não existir)
    let modal = $('checklist-modal');
    if(!modal){
        modal = document.createElement('div');
        modal.id = 'checklist-modal';
        document.body.appendChild(modal);
    }
    modal.innerHTML = `<div class="checklist-modal-box"></div>`; // Limpa o conteúdo e prepara a caixa

    try{
        // 2. Fetch Student Info
        const sdoc = await db.collection('students').doc(studentDocId).get();
        if(!sdoc.exists) return alert('Aluno não encontrado');
        const s = sdoc.data();

        // Fetch class name and store in modal dataset
        let className = 'Turma Desconhecida';
        let classId = s.classId;
        if(classId){
            const classDoc = await db.collection('classes').doc(classId).get();
            if(classDoc.exists) className = classDoc.data().name;
        }
        modal.dataset.classId = classId; // Guarda o ID da turma para uso no saveDelivery

        // --- Variáveis de Conferência ---
        const hasExistingSignature = !!s.signatureDataURL;
        const currentClerkName = getCurrentClerkName();

        // 3. Fetch Class Materials
        const matsnap = await db.collection('materials').where('classId','==',s.classId).get();
        const materialsArray = [];
        matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
        materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome

        // 4. Fetch Deliveries
        const deliveriesSnap = await db.collection('deliveries').where('studentId','==',studentDocId).get();
        const deliveredQuantities = {}; // Mapeia {materialId: {quantity: N, by: clerkName, timestamp: T}}
        deliveriesSnap.forEach(d => {
            const data = d.data();
            deliveredQuantities[data.materialId] = { 
                quantity: data.quantityDelivered || 0, 
                by: data.clerkName || 'Desconhecido',
                timestamp: data.timestamp
            };
        });


        const box = modal.querySelector('.checklist-modal-box');
        
        // --- Header ---
        const header = document.createElement('div');
        header.style = 'padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;';
        header.innerHTML = `
            <div>
                <h3 class="section-title" style="margin: 0;">Checklist de Materiais</h3>
                <div class="small">Aluno: <strong>${s.name}</strong> (${s.studentId || 'N/A'}) - Turma: ${className}</div>
            </div>
            <button id="closeChecklist" class="btn secondary" style="padding: 6px 10px; font-size: 14px;">Fechar</button>
        `;
        box.appendChild(header);

        // --- List Area Header/Controls ---
        const listControls = document.createElement('div');
        listControls.style = 'padding: var(--pad); padding-bottom: 10px; border-bottom: 1px solid var(--border-color);';
        listControls.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 class="section-title" style="font-size: 16px; margin: 0;">Itens da Lista</h4>
                <button id="markCompleteBtn" class="btn secondary" style="padding: 6px 10px; font-size: 13px;">Marcar Todos como Entregues</button>
            </div>
        `;
        box.appendChild(listControls);
        
        // --- List Area ---
        const listArea = document.createElement('div');
        listArea.id = 'checklist-list-area';
        if (materialsArray.length === 0) {
            listArea.innerHTML = '<div class="small" style="padding: 16px;">Nenhum material cadastrado para esta turma.</div>';
        } else {
            materialsArray.forEach(m => {
                const id = m.id;
                const required = m.quantity || 1;
                const currentDelivery = deliveredQuantities[id];
                const currentQty = currentDelivery ? currentDelivery.quantity : 0;
                let remaining = required - currentQty;
                
                const div = document.createElement('div');
                div.className='checklist-item';
                div.innerHTML = `
                    <div class="checklist-item-details">
                        <strong>${m.name}</strong>
                        <div class="small">Qtd. Necessária: ${required}</div>
                        ${currentDelivery ? `<div class="small clerk-name-text" style="font-size:11px; margin-top: 2px;">Última entrega por: ${currentDelivery.by}</div>` : ''}
                    </div>
                    <div class="checklist-item-controls">
                        <label class="small">Entregue: 
                            <input type="number" min="0" value="${currentQty}" data-matid="${id}" class="delivery-input" data-required="${required}" data-current="${currentQty}" />
                        </label>
                        <span class="small" style="font-weight: 500;">Faltam: 
                            <span class="remaining-qty" style="font-weight:700; color:${remaining > 0 ? 'var(--danger)' : 'var(--success)'}">${remaining}</span>
                        </span>
                        <button class="btn secondary save-delivery-btn" data-matid="${id}" data-required="${required}" style="padding: 6px 10px; font-size: 12px; min-width: 60px;">Salvar</button>
                    </div>
                `;
                listArea.appendChild(div);
            });
        }
        box.appendChild(listArea);

        // --- Signature Area (Alterado para ser Ocultável) ---
        const signatureArea = document.createElement('div');
        signatureArea.id = 'signature-area';
        signatureArea.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 class="section-title" style="font-size: 16px; margin: 0;">Assinatura do Responsável</h4>
                <button id="toggleSignatureBtn" class="btn secondary" style="padding: 6px 10px; font-size: 13px;">
                    ${hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura'}
                </button>
            </div>
            <div id="signature-content" style="display: none; padding-top: 10px;">
                <div id="signature-preview-container" style="display: ${hasExistingSignature ? 'block' : 'none'}; text-align: center;">
                    <img id="signature-preview" src="${s.signatureDataURL || ''}" alt="Assinatura Salva" />
                </div>
                
                <div id="canvas-controls-group" style="display: ${hasExistingSignature ? 'none' : 'block'};">
                    <canvas id="signature-canvas"></canvas>
                    <div class="row" style="margin-top: 5px;">
                        <input id="signerName" class="input" placeholder="Nome Completo do Responsável" value="${s.signerName || ''}" ${hasExistingSignature ? 'disabled' : ''}/>
                    </div>
                    <div class="row" style="margin-top: 8px;">
                        <button id="clearSignature" class="btn secondary" style="width: 100px;">Limpar</button>
                        <button id="saveSignature" class="btn" style="flex:1;">Salvar Assinatura & Conferente</button>
                    </div>
                </div>
                
                <div class="small" style="margin-top: 10px;">Conferente atual: <strong>${currentClerkName}</strong></div>
            </div>
        `;
        box.appendChild(signatureArea);

        // --- 5. Exibe o modal ---
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden';

        // --- 6. Listeners do Modal ---
        $('closeChecklist').addEventListener('click', ()=>{
            modal.classList.remove('visible');
            document.body.style.overflow = '';
            loadStudentsList($('studentsFilterClass').value); // Recarrega a lista para atualizar o status de assinatura
        });

        // Toggle Assinatura
        const toggleBtn = $('toggleSignatureBtn');
        const signatureContent = $('signature-content');
        
        // Se houver assinatura prévia, já exibe por padrão
        if (hasExistingSignature) {
            signatureContent.style.display = 'block';
            document.getElementById('signature-preview-container').style.display = 'block';
        }

        toggleBtn.addEventListener('click', function() {
            const isVisible = signatureContent.style.display === 'block';
            signatureContent.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? 
                (hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura') : 
                (hasExistingSignature ? 'Ocultar Assinatura' : 'Ocultar');

            // Inicializa o SignaturePad apenas se for o primeiro acesso e a área estiver sendo aberta
            if(!hasExistingSignature && !signaturePadInstance && !isVisible) {
                const canvas = $('signature-canvas');
                signaturePadInstance = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)',
                    penColor: 'rgb(0, 0, 0)'
                });
                
                // Garante que o canvas seja redimensionado corretamente ao ser aberto
                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePadInstance.clear();
                }
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas); // Adiciona listener de resize global

                document.getElementById('clearSignature').addEventListener('click', () => signaturePadInstance.clear());
                
                document.getElementById('saveSignature').addEventListener('click', async function(){
                    if (signaturePadInstance.isEmpty()) {
                        return alert("Por favor, peça ao responsável para assinar.");
                    }
                    const signerName = document.getElementById('signerName').value.trim();
                    if(!signerName) {
                        return alert("Por favor, preencha o nome do responsável.");
                    }
                    const dataURL = signaturePadInstance.toDataURL();

                    this.disabled = true;
                    this.textContent = 'Salvando...';

                    try {
                        await saveSignature(studentDocId, dataURL, signerName, currentClerkName);
                        alert('Assinatura e conferente salvos com sucesso!');
                        
                        // Atualiza a UI para modo de visualização
                        document.getElementById('signature-preview').src = dataURL;
                        document.getElementById('signature-preview-container').style.display = 'block';
                        document.getElementById('canvas-controls-group').style.display = 'none';
                        document.getElementById('signerName').value = signerName; // Garante que o nome esteja lá
                        document.getElementById('signerName').disabled = true;
                        this.textContent = 'Assinatura Salva';
                        this.disabled = true;
                        
                        // Recarrega o modal (ou oculta a área)
                        toggleBtn.click(); // Oculta a área após salvar
                        await openStudent(studentDocId); // Recarrega para mostrar status

                    } catch(err) {
                        alert(err.message);
                    } finally {
                         // Se deu erro, reabilita o botão
                        if(this.textContent !== 'Assinatura Salva') {
                            this.disabled = false;
                            this.textContent = 'Salvar Assinatura & Conferente';
                        }
                    }
                });
            }
        });

        // 7. Listeners para os itens de entrega
        listArea.querySelectorAll('.checklist-item').forEach(item => {
            const inputEl = item.querySelector('.delivery-input');
            const remainingEl = item.querySelector('.remaining-qty');
            const saveBtn = item.querySelector('.save-delivery-btn');
            
            const matId = inputEl.dataset.matid;
            const requiredQty = parseInt(inputEl.dataset.required, 10);
            
            // Listener para o input de mudança de valor
            inputEl.addEventListener('input', function() {
                const newQty = parseInt(this.value, 10);
                const delivered = Math.min(newQty, requiredQty);
                const remaining = requiredQty - delivered;
                remainingEl.textContent = remaining;
                remainingEl.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)';
            });
            
            // Listener para o botão Salvar
            saveBtn.addEventListener('click', async function(){
                this.disabled = true;
                this.textContent = '...';
                const newQty = parseInt(inputEl.value, 10);
                const success = await saveDelivery(studentDocId, matId, requiredQty, newQty, inputEl, remainingEl, false);
                this.disabled = false;
                this.textContent = 'Salvar';
                if (success) {
                    // Feedback visual temporário de sucesso
                    const originalBg = item.style.backgroundColor;
                    item.style.backgroundColor = 'var(--success-light)';
                    setTimeout(() => {
                        item.style.backgroundColor = originalBg;
                    }, 300);
                }
            });
        });

        // 8. Listener para o botão "Marcar Todos"
        $('markCompleteBtn').addEventListener('click', async function(){
            if(!confirm('Tem certeza que deseja marcar TODOS os materiais como ENTREGUES (Qtd. Entregue = Qtd. Necessária)?')) return;
            
            this.disabled = true;
            this.textContent = 'Marcando Todos...';
            
            const items = listArea.querySelectorAll('.checklist-item');
            const deliveryPromises = [];

            items.forEach(item => {
                const inputEl = item.querySelector('.delivery-input');
                const remainingEl = item.querySelector('.remaining-qty');
                
                const matId = inputEl.dataset.matid;
                const requiredQty = parseInt(inputEl.dataset.required, 10);
                const newQty = requiredQty; // Força a entrega completa
                
                // Dispara a promessa de salvamento
                deliveryPromises.push(saveDelivery(studentDocId, matId, requiredQty, newQty, inputEl, remainingEl, true));
            });

            const results = await Promise.all(deliveryPromises);
            const successCount = results.filter(r => r).length;
            
            alert(`${successCount} de ${items.length} itens atualizados para 'Entregue'.`);
            
            // Força o recarregamento do modal para garantir que todos os estados estejam consistentes
            // await openStudent(studentDocId); // Chamada recursiva para recarregar
            
            this.disabled = false;
            this.textContent = 'Marcar Todos como Entregues';
        });


    }catch(err){
        modal.classList.remove('visible');
        document.body.style.overflow = '';
        console.error('Erro openStudent:', err);
        alert('Erro ao carregar checklist do aluno: ' + (err.message || err));
    }
}

/* --------------------------- QR & PRINT --------------------------- */

/**
 * Gera e abre uma janela de impressão contendo o Documento Simplificado de Conferência
 * para um aluno específico. Inclui o status de entrega dos materiais, 
 * campos de assinatura e o QR Code.
 * * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function generatePrintableChecklist(studentDocId){
    if(!db) return alert('Firestore não inicializado');
    
    // 1. Fetch Student Info
    const sdoc = await db.collection('students').doc(studentDocId).get();
    if(!sdoc.exists) return alert('Aluno não encontrado');
    const s = sdoc.data();

    // NOVIDADE: 1.1. Fetch Class Name
    let className = s.classId || 'Turma Desconhecida (ID: N/A)';
    if(s.classId){
        try{
            const classDoc = await db.collection('classes').doc(s.classId).get();
            if(classDoc.exists) className = classDoc.data().name;
            else className = `Turma Desconhecida (ID: ${s.classId})`;
        }catch(e){
            console.error('Erro ao buscar nome da turma:', e);
            className = `Erro ao buscar Turma (ID: ${s.classId})`;
        }
    }


    // 2. Fetch Class Materials
    const matsnap = await db.collection('materials').where('classId','==',s.classId).get();
    
    // 3. Fetch Deliveries
    const deliveriesSnap = await db.collection('deliveries').where('studentId','==',studentDocId).get();
    const deliveredQuantities = {};
    deliveriesSnap.forEach(d=> deliveredQuantities[d.data().materialId] = d.data().quantityDelivered || 0);

    const materialsArray = [];
    matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
    materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome
    
    let checklistHtml = '';
    let totalMissing = 0;
    materialsArray.forEach(m => {
        const required = m.quantity || 1;
        const delivered = deliveredQuantities[m.id] || 0;
        const missing = required - delivered;
        if(missing > 0) totalMissing += missing;
        
        const status = missing === 0 ? 'COMPLETO' : `Faltam ${missing}`;
        const statusColor = missing === 0 ? 'color:#16a34a;' : 'color:#ef4444; font-weight: 600;';
        
        checklistHtml += `
            <div class="material-item-doc">
                <div style="width: 45%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${m.name}</div>
                <div style="width: 15%; text-align: center;">${required}</div>
                <div style="width: 20%; text-align: center;">${delivered}</div>
                <div style="width: 20%; text-align: right; ${statusColor}">${status}</div>
            </div>
        `;
    });

    if (materialsArray.length === 0) {
        checklistHtml = '<div style="padding: 10px; text-align: center; color: #888;">Não há materiais cadastrados para esta turma.</div>';
    }

    // 4. Constrói o HTML do documento de impressão
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <title>Documento de Conferência - ${s.name}</title>
            <style>
                body { 
                    font-family: 'Inter', Arial, sans-serif; 
                    margin: 20px; 
                    font-size: 13px; /* Tamanho da fonte menor para impressão */
                    color: #333; 
                }
                .document-header { 
                    text-align: center; 
                    border-bottom: 3px solid #000; 
                    margin-bottom: 20px;
                }
                h1 { 
                    font-size: 24px; 
                    margin: 0 0 5px; 
                    color: #2b7cff; 
                }
                h2 { 
                    font-size: 14px; 
                    font-weight: 400; 
                    margin-top: 0; 
                    color: #666;
                }
                .student-info { 
                    margin-bottom: 20px; 
                    border: 1px solid #ccc; 
                    padding: 15px; 
                    border-radius: 6px;
                    background: #f9f9f9;
                    display: flex;
                    justify-content: space-between;
                }
                .info-left, .info-right { line-height: 1.6; }
                .info-right { text-align: right; font-weight: 600; }

                .material-section h3 {
                    font-size: 16px;
                    border-bottom: 1px solid #ddd;
                    padding-bottom: 5px;
                    margin-top: 25px;
                }
                .material-list { 
                    border: 1px solid #ccc; 
                    border-radius: 4px; 
                    margin-top: 10px; 
                    overflow: hidden; 
                }
                .material-header-doc, .material-item-doc { 
                    display: flex; 
                    padding: 8px 10px; 
                    border-bottom: 1px solid #eee; 
                    align-items: center;
                }
                .material-header-doc {
                    font-weight: bold; 
                    background: #eef4ff; 
                    color: #2b7cff;
                    border-bottom: 2px solid #ccc;
                }
                .material-item-doc:last-child { border-bottom: none; }
                .material-item-doc > div { overflow: hidden; text-overflow: ellipsis; }

                .signature-area { 
                    display: flex; 
                    justify-content: space-between; 
                    margin-top: 50px; 
                }
                .signature-block { 
                    display: inline-block; 
                    width: 48%; /* Aumentado um pouco para ocupar mais espaço */
                    vertical-align: top; 
                    text-align: center; 
                }
                .signature-line { 
                    border-top: 1px solid #000; 
                    margin-top: 15px; /* Aumentado o espaço para a linha */
                    padding-top: 5px; 
                    font-weight: bold; 
                }
                .signature-image {
                    max-width: 100%; 
                    max-height: 100px; 
                    height: 100px; /* Altura fixa para o bloco da assinatura */
                    border: 1px solid #ccc; 
                    object-fit: contain; 
                    background: #f9f9f9;
                    margin-bottom: 5px;
                }
                .footer-text { margin-top: 30px; text-align: center; font-size: 11px; color: #888; }
                
                /* Mídia de Impressão */
                @media print {
                    body { 
                        font-size: 12px; 
                        margin: 10mm; /* Margens de impressão */
                    }
                    .document-header { border-bottom-color: #999; }
                    .material-item-doc { page-break-inside: avoid; }
                    .signature-area { page-break-before: auto; margin-top: 40px; }
                }
            </style>
        </head>
        <body>
            <div class="document-header">
                <h1>DOCUMENTO DE CONFERÊNCIA DE MATERIAL</h1>
                <h2>Controle de Material Escolar - ${className}</h2>
            </div>
            
            <div class="student-info">
                <div class="info-left">
                    <strong>Aluno(a):</strong> ${s.name}<br>
                    <strong>Matrícula:</strong> ${s.studentId || 'N/A'}<br>
                </div>
                <div class="info-right">
                    <strong style="font-size: 15px; color: ${totalMissing > 0 ? '#ef4444' : '#16a34a'};">
                        ${totalMissing === 0 ? 'LISTA COMPLETA' : `FALTAM ${totalMissing} ITENS`}
                    </strong>
                </div>
            </div>

            <div class="material-section">
                <h3>Detalhe dos Materiais</h3>
                <div class="material-list">
                    <div class="material-header-doc">
                        <div style="width: 45%;">Material</div>
                        <div style="width: 15%; text-align: center;">Requerido</div>
                        <div style="width: 20%; text-align: center;">Entregue</div>
                        <div style="width: 20%; text-align: right;">Status</div>
                    </div>
                    ${checklistHtml}
                </div>
            </div>

            <div class="signature-area">
                <div class="signature-block">
                    <img src="${s.signatureDataURL || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" 
                         class="signature-image"
                         alt="Assinatura" />
                    <div class="signature-line">
                        ${s.signerName || 'Nome do Responsável (Assinar Acima)'}
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: #666;">Responsável (Pai/Mãe)</div>
                </div>
                <div class="signature-block">
                    <div class="signature-image" style="background: transparent; border: none;"></div> 
                    <div class="signature-line">
                        ${s.clerkName || 'Nome do Conferente'}
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: #666;">Conferente da Escola</div>
                </div>
            </div>
            
            <div class="footer-text">
                Documento gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}
            </div>

        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus();
}

if($('btnGenerateQRs')) $('btnGenerateQRs').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');
    
    const classId = $('qrClassSelect').value;
    if(!classId) return alert('Selecione uma turma para gerar os QRs.');

    this.disabled = true;
    this.textContent = 'Gerando...';

    const gallery = $('qrGallery');
    gallery.innerHTML = '';
    
    try {
        const studentsSnap = await db.collection('students').where('classId', '==', classId).orderBy('name').get();
        if(studentsSnap.empty){
            gallery.innerHTML = '<div class="small" style="grid-column: 1 / -1;">Nenhum aluno encontrado nesta turma.</div>';
            return;
        }

        studentsSnap.forEach(d => {
            const s = d.data();
            const studentId = d.id;
            
            // Cria um contêiner para cada QR Code
            const qrContainer = document.createElement('div');
            qrContainer.style = 'border: 1px solid var(--border-color); padding: 10px; border-radius: var(--radius); text-align: center; background: var(--card);';
            qrContainer.innerHTML = `
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${s.name}</div>
                <div id="qr-${studentId}" style="width: 100%; height: 160px; margin: 0 auto; display: flex; align-items: center; justify-content: center;"></div>
                <div class="small" style="margin-top: 5px;">Matrícula: ${s.studentId || 'N/A'}</div>
                <a class="btn secondary" href="#" data-student-id="${studentId}" style="margin-top: 10px; padding: 6px 10px; font-size: 12px;">Download QR</a>
            `;
            gallery.appendChild(qrContainer);

            // Geração do QR Code. Usando 'print' para o código que vai na sacola.
            const url = getStudentQRUrl(studentId, 'print'); 
            const qrCodeDiv = document.getElementById(`qr-${studentId}`);
            new QRCode(qrCodeDiv, {
                text: url,
                width: 160,
                height: 160,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // Configura o link de download
            qrContainer.querySelector('a').addEventListener('click', function(e) {
                e.preventDefault();
                const canvas = qrCodeDiv.querySelector('canvas');
                if (canvas) {
                    const imgUrl = canvas.toDataURL("image/png");
                    const downloadLink = document.createElement('a');
                    downloadLink.href = imgUrl;
                    downloadLink.download = `QR_MESA_${s.name.replace(/ /g, '_')}.png`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                } else {
                    alert('Erro ao gerar imagem para download.');
                }
            });
        });

    } catch(err) {
        console.error('Erro ao gerar QRs', err);
        gallery.innerHTML = `<div class="small" style="color:var(--danger); grid-column: 1 / -1;">Erro ao gerar QRs: ${err.message || err}</div>`;
    } finally {
        this.disabled = false;
        this.textContent = 'Gerar QRs';
    }
});


/* --------------------------- REPORTS --------------------------- */

/**
 * Checa se um aluno tem todos os materiais entregues.
 * @param {string} studentDocId - ID do aluno.
 * @returns {Promise<{isComplete: boolean, classId: string}>}
 */
async function checkStudentFullDelivery(studentDocId) {
    if (!db) return { isComplete: false, classId: null };

    const sDoc = await db.collection('students').doc(studentDocId).get();
    if (!sDoc.exists) return { isComplete: false, classId: null };
    const s = sDoc.data();

    // 1. Materiais da turma
    const matSnap = await db.collection('materials').where('classId', '==', s.classId).get();
    if (matSnap.empty) return { isComplete: true, classId: s.classId }; // Sem materiais = completo

    // 2. Entregas do aluno
    const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentDocId).get();
    const deliveredQuantities = {};
    deliveriesSnap.forEach(d => deliveredQuantities[d.data().materialId] = d.data().quantityDelivered || 0);

    let isComplete = true;
    matSnap.forEach(mDoc => {
        const material = mDoc.data();
        const required = material.quantity || 1;
        const delivered = deliveredQuantities[mDoc.id] || 0;
        if (delivered < required) {
            isComplete = false;
        }
    });

    return { isComplete: isComplete, classId: s.classId };
}


if($('btnRunReport')) $('btnRunReport').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');
    
    const classId = $('reportClass').value;
    if(!classId) return alert('Selecione uma turma para gerar o relatório.');

    this.disabled = true;
    this.textContent = 'Gerando...';

    try {
        // 1. Fetch Class Materials (para ter a lista de required)
        const matSnap = await db.collection('materials').where('classId', '==', classId).get();
        const requiredQuantities = {};
        matSnap.forEach(d => requiredQuantities[d.id] = d.data().quantity || 1);
        const materialIds = Object.keys(requiredQuantities);

        if (materialIds.length === 0) {
            $('reportArea').innerHTML = '<div class="small">Esta turma não tem materiais cadastrados.</div>';
            return;
        }

        // 2. Fetch Students
        const studentsnap = await db.collection('students').where('classId', '==', classId).orderBy('name').get();
        const reportData = [];

        for (const sDoc of studentsnap.docs) {
            const s = sDoc.data();
            const studentDocId = sDoc.id;
            let totalMissing = 0;

            // 3. Fetch Deliveries for the current student
            const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentDocId).get();
            const deliveredQuantities = {};
            deliveriesSnap.forEach(d => deliveredQuantities[d.data().materialId] = d.data().quantityDelivered || 0);

            // 4. Calculate missing items
            for (const matId of materialIds) {
                const required = requiredQuantities[matId];
                const delivered = deliveredQuantities[matId] || 0;
                totalMissing += Math.max(0, required - delivered);
            }

            // Verifica se o aluno tem assinatura
            const hasSignature = !!s.signatureDataURL;
            
            reportData.push({
                name: s.name,
                studentId: s.studentId || 'N/A',
                totalMissing: totalMissing,
                hasSignature: hasSignature
            });
        }

        // 5. Render Report
        // Cria a tabela
        const table = document.createElement('table');
        table.style = 'width: 100%; border-collapse: collapse; font-size: 14px;';
        table.innerHTML = `
            <thead>
                <tr style="background-color: var(--accent); color: white;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #fff;">Aluno</th>
                    <th style="padding: 10px; border: 1px solid #fff;">Matrícula / Nº</th>
                    <th style="padding: 10px; border: 1px solid #fff;">Itens Faltando</th>
                    <th style="padding: 10px; border: 1px solid #fff;">Assinatura</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');
        reportData.forEach(item => {
            const missingColor = item.totalMissing > 0 ? 'var(--danger)' : 'var(--success)';
            const signatureText = item.hasSignature ? 
                '<span style="color:var(--success); font-weight: 600;">SIM</span>' : 
                '<span style="color:var(--danger); font-weight: 600;">NÃO</span>';

            const row = document.createElement('tr');
            row.style = 'border-bottom: 1px solid var(--border-color);';
            row.innerHTML = `
                <td style="padding: 10px; text-align: left;">${item.name}</td>
                <td style="padding: 10px; text-align: center;">${item.studentId}</td>
                <td style="padding: 10px; text-align: center; color: ${missingColor}; font-weight: 600;">${item.totalMissing}</td>
                <td style="padding: 10px; text-align: center;">${signatureText}</td>
            `;
            tbody.appendChild(row);
        });
        
        this.disabled = false;
        this.textContent = 'Gerar relatório';
        $('reportArea').innerHTML = ''; // Limpa a área
        
        if (studentsnap.empty) {
            $('reportArea').innerHTML = '<div class="small">Nenhum aluno encontrado nesta turma para gerar o relatório.</div>';
        } else {
            // Cria um contêiner para o botão e a tabela
            const contentWrapper = document.createElement('div');
            
            // Adiciona o botão de fechar no topo
            contentWrapper.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <button class="btn secondary" 
                            style="background-color: var(--muted); color: white;" 
                            onclick="document.getElementById('reportArea').innerHTML = ''">
                        &larr; Fechar Relatório
                    </button>
                </div>`;

            // Anexa a tabela de relatório ao contêiner
            contentWrapper.appendChild(table);
            
            // Insere o contêiner completo na área do relatório
            $('reportArea').appendChild(contentWrapper);
        }
        
    }catch(err){
        console.error('Erro Relatório',err);
        alert('Erro ao gerar relatório: ' + (err.message||err));
        this.disabled = false;
        this.textContent = 'Gerar relatório';
    }
});

/* --------------------------- END OF JS --------------------------- */
</script>
</html>
