<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Material Escolar - Painel</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Cores */
      --bg:#f5f7fb;
      --card:#ffffff;
      --accent:#2b7cff;
      --accent-light: #eef4ff;
      --muted:#6b7280;
      --success:#16a34a;
      --success-light: #ecfdf5;
      --danger:#ef4444;
      --danger-light: #fef2f2;
      --warning: #f59e0b;
      --warning-light: #fffbeb;
      --glass: rgba(255,255,255,0.7);
      
      /* Geometria */
      --radius:10px;
      --pad:16px; 
      --border-color: #e6e9ef;
    }
    *{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    
    /* ATUALIZAÇÕES CRUCIAIS PARA O FOOTER FIXAR NO FINAL */
    body {
        margin: 0;
        background: var(--bg);
        min-height: 100vh; /* Garante altura mínima da tela */
        color: #111;
        padding-bottom: 0; 
        transition: overflow 0.3s;
        display: flex; /* NOVO: Habilita flexbox no body */
        flex-direction: column; /* NOVO: Organiza os filhos verticalmente */
    }
    
    /* Header (Cabeçalho) */
    header{display:flex;align-items:center;justify-content:space-between;padding:14px var(--pad);background:var(--card);box-shadow:0 1px 12px rgba(11,15,35,0.08);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;font-weight:700;}
    header .right{display:flex;gap:12px;align-items:center}
    
    /* Layout Principal */
    /* ATUALIZAÇÃO NO LAYOUT .container */
    .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 16px;
        flex-grow: 1; /* Faz o container principal crescer e empurrar o rodapé */
    }
    .grid{display:grid;grid-template-columns:300px 1fr;gap:20px} /* Desktop View */
    
    /* Cartões */
    .card{background:var(--card);padding:var(--pad);border-radius:var(--radius);box-shadow:0 4px 12px rgba(12,18,40,0.04);transition:transform 0.1s}
    .card:hover.clickable-card { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(12,18,40,0.08); } 
    .card.group-card { padding: 0; box-shadow: 0 4px 12px rgba(12,18,40,0.04); }
    
    /* Títulos e Texto */
    .section-title{font-weight:700;margin-bottom:12px;color:#0f172a;font-size:20px}
    .small{font-size:13px;color:var(--muted)}
    
    /* Navegação (Sidebar) - Desktop Default */
    nav {padding: 4px 0;}
    nav .nav-item{padding:10px;border-radius:8px;cursor:pointer;color:#111;display:flex;gap:10px;align-items:center;transition:background 0.2s, border 0.2s}
    nav .nav-item:hover{background:#f1f5f9;}
    nav .nav-item.active{background:var(--accent-light);color:var(--accent);font-weight:600;}
    
    /* Botões */
    .btn{display:inline-block;padding:10px 16px;border-radius:8px;background:var(--accent);color:white;text-decoration:none;border:none;cursor:pointer;transition:background 0.2s, opacity 0.2s;font-weight:500;font-size:14px;}
    .btn:hover:not(:disabled){filter:brightness(1.05); box-shadow: 0 2px 8px rgba(43,124,255,0.2);}
    .btn:disabled{opacity:0.6; cursor:not-allowed;}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid var(--border-color);padding:9px 15px;}
    .btn.secondary:hover:not(:disabled){background:#f8fafc; color:var(--accent); border-color:var(--accent-light); box-shadow: none;}

    /* Inputs/Formulários */
    .input, textarea, select{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--border-color);
      background:white;
      transition:border-color: 0.2s;
      font-size: 16px; /* MELHORIA MOBILE: Garante 16px para evitar zoom indesejado */
    }
    .input:focus, textarea:focus, select:focus {border-color: var(--accent); outline: none; box-shadow: 0 0 0 1px var(--accent-light);}
    
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center}
    .materials-list{max-height:300px;overflow:auto;padding-right:6px}
    
    /* Itens de Lista (Materiais/Alunos) */
    .material-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;background:#fcfdff;border:1px solid #eef2ff;transition:background 0.2s;}
    .material-item:hover{background:var(--accent-light); border-color:var(--accent);}
    
    .student-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:var(--radius);border:1px solid var(--border-color);background:var(--card);}
    .qr-img{width:120px;height:120px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center}
    
    /* Componentes Auxiliares */
    .hint{padding:10px;border-radius:8px;background:var(--accent-light);border:1px solid var(--accent);color:var(--accent);font-size:13px}
    .flex-col{display:flex;flex-direction:column;gap:10px}
    pre.rules{background:#0b1220;color:#f8fafc;padding:15px;border-radius:8px;overflow:auto;font-size:14px;line-height:1.4;}
    
    /* Overlay e Modal Checklist - NOVO/MELHORADO */
    #menuOverlay, #checklist-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        z-index: 15;
        display: none;
        transition: opacity 0.3s;
        opacity: 0;
    }
    #menuOverlay.visible, #checklist-modal.visible {
        opacity: 1;
        display: flex; 
        align-items: center;
        justify-content: center;
    }
    .checklist-modal-box {
        width: 650px; /* Largura maior para melhor visualização */
        max-width: 95vw;
        max-height: 90vh;
        overflow: hidden;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column; /* Essencial para que a lista cresça e empurre o rodapé */
    }
    #checklist-list-area {
        overflow-y: auto;
        padding: var(--pad);
        padding-top: 0;
        flex-grow: 1; /* Ocupa o espaço restante e permite a rolagem apenas nesta área */
    }
    .checklist-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 10px;
        border-bottom: 1px dashed var(--border-color);
    }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-item-details { flex-grow: 1; max-width: 60%; }
    .checklist-item-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    
    /* CORREÇÃO: Aumenta a largura para melhor visualização em todos os dispositivos */
    .delivery-input { 
        width: 60px !important; 
        padding: 4px; 
        border-radius: 4px; 
        border: 1px solid #ccc; 
        text-align: center; 
        font-size: 13px; /* Mantém 13px para não afetar o layout do modal */
    }

    /* Estilos para o Signature Pad */
    #signature-area {
        padding: var(--pad);
        background: #fcfdff;
        border-top: 1px solid var(--border-color); /* Mantido para separar do checklist */
    }
    #signature-canvas {
        border: 1px dashed var(--muted);
        border-radius: 4px;
        width: 100%;
        height: 150px;
        touch-action: none; /* Necessário para touch events e mouse */
    }
    #signature-preview {
        max-width: 100%;
        max-height: 150px;
        margin: 5px 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        object-fit: contain;
    }

    /* Estilos para o Documento de Impressão */
    .signature-block { display: inline-block; width: 45%; margin: 0 10px; vertical-align: top; }


    /* ------------------------------------- */
    /* ESTILOS DO RODAPÉ (FOOTER) - NOVO */
    /* ------------------------------------- */
    #main-footer {
        background-color: var(--card);
        color: var(--muted);
        padding: 20px var(--pad);
        text-align: center;
        font-size: 14px;
        margin-top: 40px; /* Espaço para separar do conteúdo principal */
        border-top: 1px solid var(--border-color); /* Linha sutil no topo */
        width: 100%;
        flex-shrink: 0; /* Impede que o footer encolha */
    }
    #main-footer .small-text {
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.8;
    }

/* Mobile Responsiveness (Hamburguer Menu) */
@media (max-width: 992px) {
    
  /* ------------------------------------------- */
  /* NOVO: AUMENTO GERAL PARA MOBILE USABILITY  */
  /* ------------------------------------------- */
  /* Torna os botões muito maiores e mais fáceis de tocar */
  .btn, .btn.secondary {
    padding: 14px 18px !important; /* Aumenta o padding */
    font-size: 16px !important;     /* Aumenta a fonte */
    min-height: 44px;               /* Garante o tamanho mínimo para toque (Padrão de usabilidade) */
  }

  /* Torna os inputs e selects mais altos */
  .input, textarea, select {
    padding: 14px !important; /* Aumenta o padding */
    min-height: 44px;         /* Garante o tamanho mínimo para toque (Padrão de usabilidade) */
    font-size: 16px;          /* Mantido em 16px para evitar zoom */
  }

  /* Aumenta o espaçamento dos itens de lista */
  .material-item, .student-card {
      padding: 16px 12px; /* Aumenta o padding vertical */
  }

  /* Aumenta o tamanho dos itens do menu */
  nav .nav-item {
      padding: 15px 10px; 
      font-size: 16px;
  }
  
  /* ------------------------------------------- */
  /* Estilos Mobile Anteriores (Mantidos e Ajustados) */
  /* ------------------------------------------- */
  header .left-controls { display: flex; align-items: center; }
  #menuToggle { display: inline-block !important; margin-right: 10px; }
  #menuToggle.btn.secondary { /* Força o botão de menu a seguir o novo estilo */
    padding: 10px 14px !important; /* Um pouco menor, mas ainda bom para ícone */
    min-height: 44px;
    font-size: 18px !important;
  }

  .grid { grid-template-columns: 1fr; } /* Layout de coluna única */
  .container { padding: 0 12px; }
  
  /* Sidebar */
  #sidebar {
    position: fixed;
    top: 50px; 
    left: 0;
    width: 250px;
    height: calc(100vh - 50px);
    z-index: 20;
    padding: var(--pad);
    transform: translateX(-100%);
    transition: transform 0.3s ease-in-out;
    box-shadow: 4px 0 12px rgba(0,0,0,0.3);
    background: var(--card);
    margin: 0;
    border-radius: 0;
    overflow-y: auto;
  }
  #sidebar.active {
    transform: translateX(0);
  }
  #menu {
    display: block; 
    gap: 0;
    padding: 0;
  }
  nav .nav-item {
    flex: none;
    text-align: left;
    justify-content: flex-start;
    min-width: unset;
  }
  
  /* Dashboard counters em coluna */
  #dashboard .row { flex-direction: column; gap: 10px; }
  #dashboard .row .card { width: 100%; }

  /* Ajuste para inputs em linhas (empilhamento vertical) */
  .row:not(#dashboard .row) { 
    flex-direction: column; 
    flex-wrap: nowrap;
    gap: 8px;
  }
  .row .input, .row select, .row button { 
    min-width: 100%; 
    flex-grow: 1; 
    width: 100% !important;
  }

  /* Turmas/Materiais em coluna */
  #materials .row { flex-direction: column; gap: 15px; }
  #materials .row > div { width: 100%; }

  /* QR Gallery ajuste */
  #qrGallery { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
  
  /* Alunos - botões em coluna */
  .student-card > div:last-child {
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }
  /* Botões menores no card do aluno */
  .student-card button { 
      padding: 10px 14px; 
      font-size: 14px; 
      min-height: 40px; 
  }

  /* Ajustes específicos para o modal de checklist em mobile */
  .checklist-modal-box {
      width: 95vw !important;
      max-height: 95vh !important; 
      padding: 0 !important; 
  }
  .checklist-item-details { max-width: 100%; }
  .checklist-item-controls { justify-content: space-between; gap: 8px; width: 100%; }
  .checklist-item { flex-direction: column; align-items: flex-start; gap: 8px; }
  #checklist-list-area { padding: 12px; flex-shrink: 1; }
  #signature-area { padding: 12px; flex-shrink: 0; }
}
  </style>
</head>
<body>

<header>
  <div class="left-controls" style="display:flex; align-items:center;">
    <button id="menuToggle" class="btn secondary" style="display:none; padding: 6px 10px; font-size: 16px; margin-right: 10px;">
      ☰
    </button>
    <h1>Controle de Material Escolar</h1>
  </div>
  
  <div class="right">
    <div id="userEmail" class="small" style="font-weight: 500;"></div>
    <button id="btnLogout" class="btn secondary" style="display:none; padding: 6px 10px;">Sair</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card" id="sidebar">
      <div class="section-title" style="margin-bottom: 10px;">Menu de Navegação</div>
      <nav id="menu">
        <div class="nav-item active" data-tab="dashboard">Dashboard</div>
        <div class="nav-item" data-tab="import">Importar Lista</div>
        <div class="nav-item" data-tab="materials">Materiais</div>
        <div class="nav-item" data-tab="students">Alunos</div>
        <div class="nav-item" data-tab="qrs">Gerar QR</div>
        <div class="nav-item" data-tab="reports">Relatórios</div>
        <div class="nav-item" data-tab="help">Ajuda</div>
      </nav>
      <hr style="margin:16px 0 10px;border:none;border-top:1px solid #f1f5f9"/>
      <div class="small">Dica: faça login com uma conta administrativa antes de salvar dados.</div>
    </div>

    <div class="card" id="main" style="grid-column: 2 / -1;"> 
      <div id="loginPanel">
        <h2 class="section-title">Login administrativo</h2>
        <div class="small">Use Email / Senha (autenticação Firebase)</div>
        <div style="height:12px"></div>
        <input id="loginEmail" class="input" placeholder="email@escola.com"/>
        <div style="height:8px"></div>
        <input id="conferenteName" class="input" placeholder="Nome Completo do Conferente (Você)" value=""/>
        <div style="height:8px"></div>
        <input id="loginPass" class="input" type="password" placeholder="Senha"/>
        <div style="height:12px"></div>
        <div class="row">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnSignup" class="btn secondary">Criar conta (teste)</button>
        </div>
        <div style="height:12px"></div>
        <div id="loginMsg" class="small" style="color:var(--danger)"></div>
        <div style="height:12px"></div>
        <div id="libStatus" class="hint small">Verificando bibliotecas...</div>
      </div>

      <div id="appContent" style="display:none">
        <div id="dashboard" class="tab">
          <h2 class="section-title">Dashboard</h2>
          <div class="row" style="gap:14px; margin-bottom: 25px; flex-direction: row !important; flex-wrap: wrap;">
            <div style="flex:1" class="card">
              <div class="small">Turmas cadastradas</div>
              <div id="countClasses" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Alunos cadastrados</div>
              <div id="countStudents" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
            <div style="flex:1" class="card">
              <div class="small">Materiais totais</div>
              <div id="countMaterials" style="font-size:26px;font-weight:700;margin-top:4px; color:var(--accent)">0</div>
            </div>
          </div>

          <h3 class="section-title" style="border-top: 1px solid #eee; padding-top:15px; margin-top: 0;">Status de Entrega por Segmento</h3>
          <div id="classStatusGrid" style="display:grid; grid-template-columns: 1fr; gap:20px;">
            <div class="small" style="grid-column: 1 / -1;">Carregando status das turmas...</div>
          </div>
        </div>

        <div id="import" class="tab" style="display:none">
          <h2 class="section-title">Importar Lista de Materiais (Texto)</h2>
          <div class="small">Cole abaixo o texto da lista de materiais copiado diretamente do PDF. O sistema tentará extrair a quantidade e o nome do item.</div>
          <div style="height:12px"></div>
          <textarea id="materialText" class="input" rows="10" placeholder="Cole a lista de materiais aqui, uma linha por item (se possível) ou o texto bruto do PDF. Ex: 1 Caderno Universitário, 4 Lápis, etc."></textarea>
          <div style="height:12px"></div>
          <button id="btnParseText" class="btn">Processar Texto</button>
          <div style="height:20px"></div>
          
          <h3 class="section-title" style="font-size: 16px;">Salvar materiais na Turma</h3>
          <div class="row">
            <select id="targetClass" class="input">
              <option value="">Escolha uma turma (ou crie abaixo)</option>
            </select>
            <button id="btnNewClass" class="btn secondary">Nova Turma</button>
          </div>
          <div style="height:8px"></div>
          <div id="newClassRow" style="display:none" class="row">
            <input id="newClassName" class="input" placeholder="Nome da turma (ex: 2ª Série Ensino Médio)"/>
            <select id="newClassSegment" class="input" style="width:200px;">
                <option value="">Selecione o Segmento</option>
                <option value="infantil">Educação Infantil</option>
                <option value="fund1">Fundamental I</option>
                <option value="fund2">Fundamental II</option>
                <option value="medio">Ensino Médio</option>
                <option value="other">Outros</option>
            </select>
            <button id="saveNewClass" class="btn">Criar</button>
          </div>

          <div style="height:16px"></div>
          <div class="card materials-list" id="parsedMaterials">
            <div class="small">Cole o texto acima e clique em "Processar Texto".</div>
          </div>
          <div style="height:12px"></div>
          <div class="row" style="justify-content: flex-end;">
            <button id="btnClearParsed" class="btn secondary">Limpar Lista</button>
            <button id="btnSaveMaterials" class="btn">Salvar materiais na turma</button>
          </div>
        </div>

        <div id="materials" class="tab" style="display:none">
          <h2 class="section-title">Materiais & Turmas</h2>
          <div class="row" style="gap:20px; align-items: flex-start;">
            <div style="flex:1" class="card">
              <div class="section-title" style="font-size: 16px;">Turmas Cadastradas</div>
              <div id="classesList" style="margin-top:8px"></div>
            </div>
            <div style="flex:2" class="card">
              <div class="section-title" style="font-size: 16px;">Materiais da Turma Selecionada</div>
              <div id="materialsOfClass" style="margin-top:8px">
                <div class="small">Clique em "Abrir" em uma turma ao lado.</div>
              </div>
            </div>
          </div>
        </div>

        <div id="students" class="tab" style="display:none">
          <h2 class="section-title">Alunos</h2>
          <div class="small">Use o filtro abaixo para visualizar alunos por turma ou adicione um novo aluno.</div>
          <div style="height:12px"></div>

          <div class="row" style="margin-bottom: 12px;">
            <select id="studentsFilterClass" class="input" style="flex:1;">
              <option value="">Mostrar Todos os Alunos (Filtro)</option>
            </select>
          </div>

          <div class="row" style="align-items: flex-end;">
            <input id="studentName" class="input" placeholder="Nome do aluno"/>
            <select id="studentClass" class="input" style="width:220px; min-width: 150px;">
              <option value="">Escolha a turma (Novo Aluno)</option>
            </select>
            <input id="studentIdInput" class="input" placeholder="Matricula / Nº" style="width:140px; min-width: 100px;"/>
            <button id="btnAddStudent" class="btn" style="min-width: 100px;">Adicionar</button>
          </div>
          <div style="height:16px"></div>
          <div id="studentsList" class="flex-col"></div>
        </div>

        <div id="qrs" class="tab" style="display:none">
          <h2 class="section-title">Gerar QR para sacolas</h2>
          <div class="small">Selecione uma turma e gere QR para cada aluno (downloadable). Este QR abre o **Documento Simplificado** (para conferência) diretamente ao ser escaneado.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="qrClassSelect" class="input"></select>
            <button id="btnGenerateQRs" class="btn" style="min-width: 120px;">Gerar QRs</button>
          </div>
          <div style="height:20px"></div>
          <div id="qrGallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px"></div>
        </div>

        <div id="reports" class="tab" style="display:none">
          <h2 class="section-title">Relatórios</h2>
          <div class="small">Relatório rápido: contagem total de itens que faltam por aluno na turma selecionada.</div>
          <div style="height:12px"></div>
          <div class="row">
            <select id="reportClass" class="input"></select>
            <button id="btnRunReport" class="btn" style="min-width: 120px;">Gerar relatório</button>
          </div>
          <div id="reportArea" style="margin-top:20px" class="flex-col"></div>
        </div>

        <div id="help" class="tab" style="display:none">
          <h2 class="section-title">Ajuda e Regras do Firebase</h2>
          <div class="small">Se o console exibir "Missing or insufficient permissions", veja abaixo as regras mínimas para testes (apenas para ambiente de desenvolvimento).</div>
          <div style="height:10px"></div>
          <div class="hint small">Cole este snippet nas Regras do Firestore (Console Firebase → Firestore → Regras) para testes locais:</div>
          <pre class="rules">
// Regras de exemplo PARA DESENVOLVIMENTO (NÃO USAR EM PRODUÇÃO sem ajuste)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null; // permite a usuários autenticados
    }
  }
}
          </pre>
          <div style="height:8px"></div>
          <div class="small">Se você quiser acesso público apenas para leitura (temporário), substitua a linha por: <code>if true</code> — mas isso torna seus dados públicos.</div>
        </div>

      </div>
    </div>
  </div>
</div> <footer id="main-footer">
    <div class="footer-content">
        <p>&copy; Todos os direitos reservados.</p>
        <p class="small-text">Desenvolvido por Nay Cordeiro - Escola Traços & Letras 2026.</p>
    </div>
</footer>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<script>
/* ============================
   CONFIGURAÇÃO DO FIREBASE
   Substitua com sua config.
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDNpnxlyLEu6OqP_fN3SRtWpSRvZFkuAXI",
  authDomain: "materialescolar-126da.firebaseapp.com",
  projectId: "materialescolar-126da",
  storageBucket: "materialescolar-126da.firebasestorage.app",
  messagingSenderId: "498322809036",
  appId: "1:498322809036:web:ee71b80840ee8dc2676269"
};

/* ---------------------------
   Verificações de biblioteca
   --------------------------- */
function setLibStatus(msg,isError){
  const el = document.getElementById('libStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
  el.style.background = isError ? 'var(--danger-light)' : 'var(--accent-light)';
  el.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
}

(function checkLibs(){
  const missing = [];
  if(typeof firebase === 'undefined') missing.push('Firebase');
  if(typeof QRCode === 'undefined') missing.push('QRCode');
  if(typeof SignaturePad === 'undefined') missing.push('SignaturePad');
  
  if(missing.length){
    setLibStatus('Atenção: bibliotecas faltando: ' + missing.join(', ') + '. Verifique conexão com CDNs.', true);
  } else {
    setLibStatus('Bibliotecas carregadas corretamente.');
  }
})();

/* ---------------------------
   Inicialização Firebase (apenas se carregou)
   --------------------------- */
let auth = null, db = null, storage = null;
try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
} catch(e){
  console.error('Erro inicializar Firebase:', e);
  setLibStatus('Erro ao inicializar Firebase. Veja console.', true);
}

/* ---------------------------
   Util / UI helpers
   --------------------------- */
function $(id){ return document.getElementById(id); }

/* Lógica do Menu Hambúrguer */
const sidebar = $('sidebar');
const menuToggle = $('menuToggle');
const menuOverlay = $('menuOverlay') || (function() {
    const el = document.createElement('div');
    el.id = 'menuOverlay';
    document.body.appendChild(el);
    return el;
})();

/**
 * Alterna a visibilidade do menu lateral (sidebar) e do overlay.
 * @param {boolean | null} force - Força o estado (true para abrir, false para fechar).
 */
function toggleMenu(force = null) {
    // Detecta se estamos em modo mobile (media query de 992px)
    const isMobileView = window.innerWidth <= 992;
    if (!isMobileView && force === null) return; // Não faz nada se for desktop e não for forçado
    
    const isVisible = force !== null ? force : !sidebar.classList.contains('active');
    
    if (isVisible) {
        sidebar.classList.add('active');
        menuOverlay.classList.add('visible');
        document.body.style.overflow = 'hidden'; // Evita scroll do conteúdo principal
    } else {
        sidebar.classList.remove('active');
        menuOverlay.classList.remove('visible');
        document.body.style.overflow = '';
    }
}

// Adiciona listeners para o toggle e para o overlay
if(menuToggle) menuToggle.addEventListener('click', () => toggleMenu());
if(menuOverlay) menuOverlay.addEventListener('click', () => toggleMenu(false));


function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.querySelectorAll('#menu .nav-item').forEach(i=>i.classList.remove('active'));
  $('loginPanel').style.display = auth && auth.currentUser ? 'none' : '';
  if(!auth || !auth.currentUser){
    $('appContent').style.display='none';
    return;
  }
  $('appContent').style.display='';
  const tab = $(name);
  if(tab) tab.style.display='';
  const menuItem = document.querySelector('#menu .nav-item[data-tab="'+name+'"]');
  if(menuItem) menuItem.classList.add('active');

  // FECHA o menu hambúrguer após a navegação em mobile
  if(window.innerWidth <= 992) {
      toggleMenu(false);
  }
}
document.querySelectorAll('#menu .nav-item').forEach(it=>{
  it.addEventListener('click', ()=> showTab(it.dataset.tab));
});

/* ---------------------------
   GERADOR DE URL QR CODE PARA CHECKLIST/IMPRESSÃO
   --------------------------- */
/**
 * Constrói a URL para escanear o QR Code de um aluno, definindo o modo de visualização.
 * O modo 'print' abre o documento simplificado (para impressão/visualização rápida), 
 * 'checklist' abre o modal completo (padrão para conferência).
 * * @param {string} studentId - O ID do documento do aluno no Firestore.
 * @param {'checklist' | 'print'} [mode='checklist'] - O modo de abertura do documento.
 * @returns {string} A URL completa com parâmetros.
 */
function getStudentQRUrl(studentId, mode = 'checklist') { 
    // Usando window.location.origin e pathname garante que funcione em diferentes ambientes (local ou hospedado)
    return window.location.origin + window.location.pathname + '?studentId=' + studentId + '&mode=' + mode;
}

/* ---------------------------
   AUTH (Email/Password) & INITIAL LOAD
   --------------------------- */

// NOVIDADE: Função helper para obter o nome do conferente atual
function getCurrentClerkName() {
    // 1. Tenta pegar do input/localStorage
    const inputName = $('conferenteName') ? $('conferenteName').value.trim() : null;
    let name = inputName || localStorage.getItem('conferenteName');
    
    // 2. Fallback: Se estiver logado e não houver nome, usa a parte do email antes do '@' (melhor que nada)
    if (!name && auth && auth.currentUser && auth.currentUser.email) {
        name = auth.currentUser.email.split('@')[0];
    }
    
    // 3. Fallback final
    return name || 'Conferente Desconhecido';
}

// NOVIDADE: Puxa o nome do localStorage ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
    const conferenteNameInput = $('conferenteName');
    if (conferenteNameInput) {
        const storedName = localStorage.getItem('conferenteName');
        if (storedName) {
            conferenteNameInput.value = storedName;
        }
    }
});

// Segmentos/Categorias
const SEGMENTS_MAP = {
    'infantil': 'Ed. Infantil',
    'fund1': 'Fund. I',
    'fund2': 'Fund. II',
    'medio': 'Ens. Médio',
    'other': 'Outros'
};

/* ---------------------------
   AUTH (Login / Logout)
   --------------------------- */

// Listener de estado de autenticação
if(auth){
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // Logado
            $('userEmail').textContent = user.email;
            $('btnLogout').style.display = 'inline-block';
            $('loginPanel').style.display = 'none';
            
            const conferenteName = getCurrentClerkName(); // Pega do input/localStorage
            if(conferenteName !== 'Conferente Desconhecido') {
                localStorage.setItem('conferenteName', conferenteName); // Salva o nome após login
            }
            
            try {
                // Carrega dados iniciais em paralelo para melhor performance
                await Promise.all([
                    loadClassesSelects(), 
                    loadDashboardData(),
                    // Tenta carregar a lista de alunos para pré-preencher
                    loadStudentsList($('studentsFilterClass') ? $('studentsFilterClass').value : null) 
                ]);
            } catch(e) {
                console.warn('Erro durante o carregamento inicial de dados após login:', e);
            }

            // --- FLUXO PARA SCANNER/CÂMERA ---
            const params = new URLSearchParams(window.location.search);
            const scannedStudentId = params.get('studentId');
            const scannedMode = params.get('mode');
            
            if (scannedStudentId) {
                // 1. Abre o documento para impressão (se for modo 'print') ou o modal de conferência (padrão/fallback).
                if (scannedMode === 'print') {
                    generatePrintableChecklist(scannedStudentId);
                } else {
                    openStudent(scannedStudentId);
                }
                
                // 2. Remove o parâmetro da barra de URL após a ação (evita loops)
                if (typeof history.replaceState === 'function') {
                    history.replaceState(null, '', window.location.pathname);
                }
            }
            
            showTab('dashboard');

        } else {
            // Deslogado
            $('userEmail').textContent = 'Visitante';
            $('btnLogout').style.display = 'none';
            $('loginPanel').style.display = '';
            $('appContent').style.display = 'none';
            showTab('loginPanel');
        }
    });
}

if(auth){
    $('btnLogin').addEventListener('click', async ()=>{
        const e = $('loginEmail').value.trim();
        const p = $('loginPass').value;
        const n = $('conferenteName').value.trim();
        
        if(!e || !p || !n){
            $('loginMsg').textContent = 'Preencha Email, Senha e Nome do Conferente.';
            return;
        }

        $('btnLogin').disabled = true;
        $('btnLogin').textContent = 'Entrando...';
        $('loginMsg').textContent = '';
        
        try{
            // Tenta o login
            await auth.signInWithEmailAndPassword(e, p); 
            
            // Se o login for bem-sucedido, salva o nome do conferente
            localStorage.setItem('conferenteName', n);

            // A chamada onAuthStateChanged (acima) cuidará do resto da interface.
        }catch(err){
            $('loginMsg').textContent = 'Erro de login: ' + (err.message || err);
            $('btnLogin').disabled = false;
            $('btnLogin').textContent = 'Entrar';
        }
    });

    $('btnSignup').addEventListener('click', async function(){
        const e = $('loginEmail').value.trim();
        const p = $('loginPass').value;
        const n = $('conferenteName').value.trim();
        
        if(!e || !p || !n){
            $('loginMsg').textContent = 'Preencha Email, Senha e Nome do Conferente para criar a conta de teste.';
            return;
        }

        this.disabled = true;
        this.textContent = 'Criando...';
        $('loginMsg').textContent = '';

        try{
            await auth.createUserWithEmailAndPassword(e, p);
            localStorage.setItem('conferenteName', n);
            alert('Conta criada com sucesso e login realizado! Lembre-se de ajustar as regras do Firestore (aba "Ajuda").');
        }catch(err){
            $('loginMsg').textContent = 'Erro ao criar conta: ' + (err.message || err);
        }finally{
            this.disabled = false;
            this.textContent = 'Criar conta (teste)';
        }
    });

    $('btnLogout').addEventListener('click', async ()=>{
        if(auth.currentUser){
            await auth.signOut();
        }
    });
}

/* ---------------------------
   DASHBOARD
   --------------------------- */

async function loadDashboardData(){
    if(!db) return;
    try{
        const [classesSnap, studentsSnap, materialsSnap] = await Promise.all([
            db.collection('classes').get(),
            db.collection('students').get(),
            db.collection('materials').get()
        ]);

        $('countClasses').textContent = classesSnap.size;
        $('countStudents').textContent = studentsSnap.size;
        $('countMaterials').textContent = materialsSnap.size;
        
        // --- Status por Segmento ---
        const classStats = {}; // { classId: { name, segment, totalStudents, deliveredCount } }
        classesSnap.forEach(d => {
            const data = d.data();
            classStats[d.id] = { name: data.name, segment: data.segment, totalStudents: 0, deliveredCount: 0 };
        });

        studentsSnap.forEach(d => {
            const s = d.data();
            if (s.classId && classStats[s.classId]) {
                classStats[s.classId].totalStudents++;
                // Verifica se o aluno tem pelo menos uma assinatura para contar como 'Entregue'
                if (s.signatureDataURL) {
                    classStats[s.classId].deliveredCount++;
                }
            }
        });

        // Agrupar por Segmento
        const segmentStats = {}; // { segment: { totalClasses, totalStudents, totalDelivered } }
        Object.values(classStats).forEach(c => {
            const segment = c.segment || 'other';
            if (!segmentStats[segment]) {
                segmentStats[segment] = { totalClasses: 0, totalStudents: 0, totalDelivered: 0 };
            }
            segmentStats[segment].totalClasses++;
            segmentStats[segment].totalStudents += c.totalStudents;
            segmentStats[segment].totalDelivered += c.deliveredCount;
        });
        
        const grid = $('classStatusGrid');
        grid.style.gridTemplateColumns = `repeat(auto-fit, minmax(280px, 1fr))`;
        let html = '';
        
        // Ordenar os segmentos (Infantil, Fund I, Fund II, Médio, Outros)
        const orderedSegments = ['infantil', 'fund1', 'fund2', 'medio', 'other'];
        
        orderedSegments.forEach(key => {
            const stats = segmentStats[key];
            if (stats && stats.totalStudents > 0) {
                const percentage = stats.totalDelivered / stats.totalStudents * 100 || 0;
                const statusColor = percentage === 100 ? 'var(--success)' : (percentage > 50 ? 'var(--warning)' : 'var(--danger)');
                const segmentName = SEGMENTS_MAP[key] || 'Outros';

                html += `
                    <div class="card" style="border-left: 5px solid ${statusColor};">
                        <div class="small" style="font-weight: 600;">${segmentName} (${stats.totalClasses} Turmas)</div>
                        <div style="font-size: 20px; font-weight: 700; margin-top: 4px;">
                            ${stats.totalDelivered} / ${stats.totalStudents} Entregues
                        </div>
                        <div style="height: 6px; background: var(--bg); border-radius: 4px; margin-top: 8px;">
                            <div style="width: ${percentage.toFixed(0)}%; height: 6px; background: ${statusColor}; border-radius: 4px;"></div>
                        </div>
                        <div class="small" style="text-align: right; margin-top: 4px; font-weight: 500; color: ${statusColor};">
                            ${percentage.toFixed(0)}% de Conclusão
                        </div>
                    </div>
                `;
            }
        });
        
        if (html === '') {
            grid.innerHTML = '<div class="small" style="grid-column: 1 / -1;">Nenhuma turma ou aluno encontrado.</div>';
        } else {
            grid.innerHTML = html;
        }

    }catch(err){
        console.error('Erro dashboard', err);
    }
}


/* ---------------------------
   IMPORT MATERIALS (TAB)
   --------------------------- */
function parseMaterialText(){
    const text = $('materialText').value;
    const lines = text.split('\n').filter(line => line.trim() !== '');

    const materials = [];
    const materialRegex = /^(\d+)\s*x?\s*([^\d].*)/i; // Ex: 10 Lápis | 10x Lápis

    lines.forEach(line => {
        const match = line.match(materialRegex);
        if (match) {
            let quantity = parseInt(match[1].trim(), 10);
            let name = match[2].trim().replace(/[,.:]$/, ''); // Remove pontuação no final
            
            if(name.length > 5 && quantity > 0) { // Filtro mínimo
                materials.push({ name, quantity });
            }
        } else {
            // Tenta o caso onde a quantidade está no final (menos comum)
            const reverseRegex = /^(.*)\s+x?\s*(\d+)$/i;
            const reverseMatch = line.match(reverseRegex);
            
            if (reverseMatch) {
                let quantity = parseInt(reverseMatch[2].trim(), 10);
                let name = reverseMatch[1].trim().replace(/[,.:]$/, '');
                
                if(name.length > 5 && quantity > 0) {
                    materials.push({ name, quantity });
                }
            } else {
                // Caso 3: apenas nome, assume 1
                const cleanedLine = line.trim().replace(/[,.:]$/, '');
                if(cleanedLine.length > 5) {
                    materials.push({ name: cleanedLine, quantity: 1 });
                }
            }
        }
    });
    
    // Filtra duplicatas e consolida quantidades
    const consolidated = materials.reduce((acc, item) => {
        const existing = acc.find(a => a.name.toLowerCase() === item.name.toLowerCase());
        if (existing) {
            existing.quantity += item.quantity;
        } else {
            acc.push(item);
        }
        return acc;
    }, []);

    // Renderiza
    const list = $('parsedMaterials');
    if(consolidated.length === 0) {
        list.innerHTML = '<div class="small" style="color:var(--danger)">Não foi possível extrair materiais. Tente formatar a lista com "Quantidade Nome" (ex: 2 Caderno).</div>';
        $('btnSaveMaterials').disabled = true;
        return;
    }
    
    list.innerHTML = '';
    
    let html = consolidated.map(m => `
        <div class="material-item">
            <div>
                <input type="number" value="${m.quantity}" class="input" style="width:60px; text-align:center; padding: 4px; height: auto;" min="1" onchange="updateParsedMaterial(this, '${m.name.replace(/'/g, "\\'")}')"/>
                <span style="font-weight:600; margin-left: 10px;">${m.name}</span>
            </div>
            <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="removeParsedMaterial(this)">Remover</button>
        </div>
    `).join('');
    
    list.innerHTML = `<div class="list">${html}</div>`;
    $('btnSaveMaterials').disabled = false;
}
$('btnParseText').addEventListener('click', parseMaterialText);
$('btnClearParsed').addEventListener('click', ()=>{
    $('materialText').value = '';
    $('parsedMaterials').innerHTML = '<div class="small">Lista limpa.</div>';
    $('btnSaveMaterials').disabled = true;
});

function updateParsedMaterial(input, materialName){
    if(parseInt(input.value) <= 0) {
        if(confirm(`Tem certeza que deseja remover o item "${materialName}" da lista?`)) {
            removeParsedMaterial(input.closest('.material-item'));
        } else {
            input.value = 1; // Volta para 1
        }
    }
}
function removeParsedMaterial(item){
    item.remove();
    // Verifica se a lista ficou vazia
    if ($('parsedMaterials').querySelector('.material-item') === null) {
        $('parsedMaterials').innerHTML = '<div class="small">Lista limpa.</div>';
        $('btnSaveMaterials').disabled = true;
    }
}

// Criar Nova Turma
if($('btnNewClass')) $('btnNewClass').addEventListener('click', ()=>{
    const row = $('newClassRow');
    const isVisible = row.style.display !== 'none';
    row.style.display = isVisible ? 'none' : 'flex';
});

if($('saveNewClass')) $('saveNewClass').addEventListener('click', async function(){
    const name = $('newClassName').value.trim();
    const segment = $('newClassSegment').value;

    if(!name || !segment){
        alert('Preencha o nome da turma e selecione o segmento.');
        return;
    }

    this.disabled = true;
    this.textContent = 'Salvando...';

    try{
        await db.collection('classes').add({
            name,
            segment,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('Turma criada com sucesso!');
        $('newClassName').value = '';
        $('newClassSegment').value = '';
        $('newClassRow').style.display = 'none'; // Fecha o input
        await loadClassesSelects(); // Recarrega os selects
        loadDashboardData(); // Atualiza dashboard
    }catch(err){
        console.error('Erro ao criar turma', err);
        alert('Erro ao criar turma: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Criar';
    }
});


// Salvar Materiais
$('btnSaveMaterials').addEventListener('click', async function(){
    const classId = $('targetClass').value;
    const parsedItems = $('parsedMaterials').querySelectorAll('.material-item');
    
    if(!classId) {
        alert('Selecione uma turma para salvar os materiais.');
        return;
    }
    if(parsedItems.length === 0) {
        alert('A lista de materiais processada está vazia.');
        return;
    }
    
    if(!confirm(`Confirma salvar ${parsedItems.length} materiais na turma selecionada?`)) return;

    this.disabled = true;
    this.textContent = 'Salvando...';

    try{
        const materials = [];
        parsedItems.forEach(item => {
            const input = item.querySelector('input[type="number"]');
            const name = item.querySelector('span').textContent.trim();
            const quantity = parseInt(input.value, 10);
            
            if(name && quantity > 0) {
                materials.push({ name, quantity, classId });
            }
        });

        if(materials.length === 0){
            throw new Error('Nenhum material válido para salvar.');
        }

        const batch = db.batch();
        materials.forEach(m => {
            // Para um sistema mais robusto, seria bom verificar se o (name + classId) já existe.
            const newMaterialRef = db.collection('materials').doc();
            batch.set(newMaterialRef, {
                name: m.name,
                quantity: m.quantity,
                classId: m.classId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        await batch.commit();

        alert(`Sucesso! ${materials.length} materiais salvos na turma.`);
        
        // Limpa a interface
        $('materialText').value = '';
        $('parsedMaterials').innerHTML = '<div class="small">Materiais salvos! Limpe a lista para continuar.</div>';
        $('btnSaveMaterials').disabled = true;
        loadDashboardData(); // Atualiza contadores

    }catch(err){
        console.error('Erro ao salvar materiais', err);
        alert('Erro ao salvar materiais: ' + (err.message || err));
    }finally{
        this.disabled = false;
        this.textContent = 'Salvar materiais na turma';
    }
});

// Carrega Turmas para os <select>
async function loadClassesSelects(){
    if(!db) return;
    const selects = [$('targetClass'), $('studentClass'), $('studentsFilterClass'), $('qrClassSelect'), $('reportClass')];
    try{
        const snap = await db.collection('classes').orderBy('name').get();
        const optionsHtml = ['<option value="">Escolha a turma</option>'];
        snap.forEach(d => {
            const c = d.data();
            optionsHtml.push(`<option value="${d.id}">${c.name} (${SEGMENTS_MAP[c.segment] || 'Outros'})</option>`);
        });

        selects.forEach(sel => {
            if(sel){
                const currentValue = sel.value;
                sel.innerHTML = optionsHtml.join('');

                // Para o filtro de alunos, a primeira opção é "Mostrar Todos"
                if(sel.id === 'studentsFilterClass') {
                    sel.innerHTML = '<option value="">Mostrar Todos os Alunos (Filtro)</option>' + optionsHtml.slice(1).join('');
                }
                
                // Tenta manter o valor selecionado
                if (currentValue && sel.querySelector(`option[value="${currentValue}"]`)) {
                    sel.value = currentValue;
                }
            }
        });
    }catch(err){
        console.error('Erro loadClassesSelects', err);
    }
}


/* ---------------------------
   MATERIALS & CLASSES (TAB)
   --------------------------- */

async function loadClassesList(){
    if(!db) return;
    const list = $('classesList');
    list.innerHTML = '<div class="small">Carregando turmas...</div>';
    
    try {
        const snap = await db.collection('classes').orderBy('name').get();
        if(snap.empty) {
            list.innerHTML = '<div class="small">Nenhuma turma cadastrada.</div>';
            return;
        }

        snap.forEach(d => {
            const c = d.data();
            const e = document.createElement('div');
            e.className = 'material-item'; // Reutilizando o estilo do item
            e.innerHTML = `
                <div>
                    <strong>${c.name}</strong>
                    <div class="small">${SEGMENTS_MAP[c.segment] || 'Segmento Desconhecido'}</div>
                </div>
                <div style="display:flex;gap:6px">
                    <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="loadMaterialsOfClass('${d.id}')">Abrir</button>
                    <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteClass('${d.id}', '${c.name.replace(/'/g, "\\'")}')">Apagar</button>
                </div>
            `;
            list.appendChild(e);
        });
    } catch(err) {
        console.error('Erro loadClassesList', err);
        list.innerHTML = '<div class="small" style="color:var(--danger)">Erro ao carregar turmas.</div>';
    }
}

async function deleteClass(classId, className) {
    if (!confirm(`Tem certeza que deseja apagar a turma "${className}" e TODOS os materiais/alunos/entregas vinculados a ela? Esta ação é irreversível!`)) {
        return;
    }
    try {
        // 1. Apagar Materiais
        const materialsSnap = await db.collection('materials').where('classId', '==', classId).get();
        const materialBatch = db.batch();
        materialsSnap.forEach(doc => materialBatch.delete(doc.ref));
        await materialBatch.commit();
        
        // 2. Apagar Alunos
        const studentsSnap = await db.collection('students').where('classId', '==', classId).get();
        const studentBatch = db.batch();
        studentsSnap.forEach(doc => studentBatch.delete(doc.ref));
        await studentBatch.commit();

        // 3. Apagar Entregas
        // Isso é mais complexo e pode ser pulado se o volume de dados for grande, mas para o modelo, faremos a limpeza:
        const deliveriesSnap = await db.collection('deliveries').where('classId', '==', classId).get();
        const deliveryBatch = db.batch();
        deliveriesSnap.forEach(doc => deliveryBatch.delete(doc.ref));
        await deliveryBatch.commit();

        // 4. Apagar a Turma
        await db.collection('classes').doc(classId).delete();
        
        alert(`Turma "${className}" e todos os dados relacionados apagados com sucesso.`);
        // Recarregar listas e dashboard
        loadClassesList();
        loadClassesSelects();
        loadDashboardData();

    } catch(err) {
        console.error('Erro ao apagar turma', err);
        alert('Erro ao apagar turma: ' + (err.message || err));
    }
}

async function loadMaterialsOfClass(classId){
    if(!db) return;
    const container = $('materialsOfClass');
    container.innerHTML = '<div class="small">Carregando materiais...</div>';

    // Desativa a aba atual e marca a nova
    document.querySelectorAll('#classesList .material-item').forEach(e => e.classList.remove('active'));
    document.querySelector(`#classesList .material-item button[onclick*="${classId}"]`).closest('.material-item').classList.add('active');


    try{
        const classDoc = await db.collection('classes').doc(classId).get();
        const className = classDoc.exists ? classDoc.data().name : 'Turma Desconhecida';
        
        const matsnap = await db.collection('materials').where('classId','==',classId).orderBy('name').get();
        const materialsArray = [];
        matsnap.forEach(d => materialsArray.push({id: d.id, ...d.data()}));
        
        container.innerHTML = `<h4 class="section-title" style="font-size: 18px; margin-top: 0;">Materiais para: ${className}</h4>`;

        if(materialsArray.length === 0){
            container.innerHTML += '<div class="small">Nenhum material cadastrado para esta turma. Use a aba "Importar Lista" para adicionar.</div>';
            return;
        }

        const listHtml = materialsArray.map(m => {
            const qty = m.quantity || 1;
            return `
                <div class="material-item">
                    <div>
                        <strong style="font-size:15px;">${qty}x</strong> 
                        <span style="margin-left: 10px;">${m.name}</span>
                    </div>
                    <div style="display:flex;gap:6px">
                        <button class="btn secondary" style="padding: 6px 10px; font-size:12px;" onclick="editMaterial('${m.id}', ${qty})">Editar Qtd</button>
                        <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:12px;" onclick="deleteMaterial('${m.id}', '${m.name.replace(/'/g, "\\'")}')">Apagar</button>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML += `<div class="list">${listHtml}</div>`;

    }catch(err){
        console.error('Erro loadMaterialsOfClass', err);
        container.innerHTML = `<div class="small" style="color:var(--danger)">Erro ao carregar materiais: ${err.message || err}</div>`;
    }
}

async function editMaterial(materialId, currentQuantity) {
    const newQty = prompt(`Editar Quantidade Requerida (Atual: ${currentQuantity}):`);
    
    if (newQty === null || isNaN(parseInt(newQty, 10)) || parseInt(newQty, 10) < 1) {
        if (newQty !== null && newQty.trim() !== "") {
            alert('A quantidade deve ser um número inteiro positivo.');
        }
        return; 
    }
    
    const quantity = parseInt(newQty, 10);

    try {
        await db.collection('materials').doc(materialId).update({ quantity });
        
        // Recarrega a lista para refletir a mudança (necessário saber a classId, mas vamos assumir que foi chamada a partir do loadMaterialsOfClass)
        const activeClass = document.querySelector('#classesList .material-item.active');
        if(activeClass) {
            const button = activeClass.querySelector('button[onclick*="loadMaterialsOfClass"]');
            if (button) {
                const classId = button.getAttribute('onclick').match(/'([^']+)'/)[1];
                loadMaterialsOfClass(classId); 
            }
        }
        loadDashboardData(); // Atualiza contadores
        alert('Quantidade atualizada com sucesso!');
    } catch (err) {
        console.error('Erro ao editar material', err);
        alert('Erro ao editar material: ' + (err.message || err));
    }
}

async function deleteMaterial(materialId, materialName) {
    if (!confirm(`Tem certeza que deseja apagar o material "${materialName}"? Isso não removerá entregas antigas.`)) {
        return;
    }
    try {
        await db.collection('materials').doc(materialId).delete();
        
        // Recarrega a lista
        const activeClass = document.querySelector('#classesList .material-item.active');
        if(activeClass) {
            const button = activeClass.querySelector('button[onclick*="loadMaterialsOfClass"]');
            if (button) {
                const classId = button.getAttribute('onclick').match(/'([^']+)'/)[1];
                loadMaterialsOfClass(classId); 
            }
        }
        loadDashboardData();
        alert('Material apagado com sucesso.');

    } catch (err) {
        console.error('Erro ao apagar material', err);
        alert('Erro ao apagar material: ' + (err.message || err));
    }
}


/* ---------------------------
   STUDENTS (TAB)
   --------------------------- */

async function addStudent(){
    const name = $('studentName').value.trim();
    const classId = $('studentClass').value;
    const studentId = $('studentIdInput').value.trim();

    if(!name || !classId){
        alert('Preencha o nome do aluno e selecione a turma.');
        return;
    }

    $('btnAddStudent').disabled = true;
    $('btnAddStudent').textContent = 'Adicionando...';

    try{
        await db.collection('students').add({
            name,
            classId,
            studentId, // Matrícula ou número
            signatureDataURL: null, // Campo para assinatura
            signerName: null,       // Nome do responsável
            clerkName: null,        // Nome do conferente
            signatureTimestamp: null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        $('studentName').value = '';
        $('studentIdInput').value = '';
        loadStudentsList($('studentsFilterClass').value); // Recarrega a lista filtrada
        loadDashboardData(); // Atualiza contadores
        alert('Aluno adicionado com sucesso!');
        
    }catch(err){
        console.error('Erro ao adicionar aluno', err);
        alert('Erro ao adicionar aluno: ' + (err.message || err));
    }finally{
        $('btnAddStudent').disabled = false;
        $('btnAddStudent').textContent = 'Adicionar';
    }
}
$('btnAddStudent').addEventListener('click', addStudent);

// Filtro de Alunos
if ($('studentsFilterClass')) {
    $('studentsFilterClass').addEventListener('change', (e) => {
        loadStudentsList(e.target.value);
    });
}

async function loadStudentsList(filterClassId = null){
    if(!db) return;
    const list = $('studentsList');
    list.innerHTML = '<div class="small">Carregando alunos...</div>';
    
    try {
        let query = db.collection('students').orderBy('name');
        
        if(filterClassId && filterClassId !== 'all'){
            query = query.where('classId', '==', filterClassId);
        }

        const snap = await query.get();
        const classesMap = await getClassesMap(); // Busca o nome das turmas
        
        if(snap.empty) {
            list.innerHTML = '<div class="small">Nenhum aluno encontrado.</div>';
            return;
        }

        list.innerHTML = '';
        snap.forEach(d => {
            const s = d.data();
            const studentId = d.id;
            const className = classesMap[s.classId] || 'Turma Desconhecida';
            const hasSignature = !!s.signatureDataURL;
            const statusText = hasSignature ? `Entregue em ${new Date(s.signatureTimestamp.toDate()).toLocaleDateString('pt-BR')}` : 'Pendente';
            const statusColor = hasSignature ? 'var(--success)' : 'var(--danger)';

            const e = document.createElement('div');
            e.className = 'student-card'; 
            e.innerHTML = `
                <div style="flex:1; min-width: 50%;">
                    <strong style="font-size: 15px;">${s.name}</strong> 
                    <div class="small">
                        Turma: ${className} | Matrícula: ${s.studentId || 'N/A'}
                    </div>
                    <div class="small" style="font-weight: 500; color:${statusColor}; margin-top: 4px;">
                        Status: ${statusText}
                    </div>
                </div>
                <div style="display:flex;gap:8px; align-items:center; min-width: 40%;">
                    <button class="btn secondary" style="padding: 6px 10px; font-size:14px;" onclick="openStudent('${studentId}')">Checklist</button>
                    <button class="btn" style="padding: 6px 10px; font-size:14px;" onclick="generatePrintableChecklist('${studentId}')">Imprimir Doc</button>
                    <button class="btn secondary" style="background:var(--danger);color:white; padding: 6px 10px; font-size:14px;" onclick="deleteStudent('${studentId}', '${s.name.replace(/'/g, "\\'")}')">Apagar</button>
                </div>
            `;
            list.appendChild(e);
        });
    } catch(err) {
        console.error('Erro loadStudentsList', err);
        list.innerHTML = '<div class="small" style="color:var(--danger)">Erro ao carregar alunos.</div>';
    }
}

let classesMapCache = null;
async function getClassesMap(){
    if(classesMapCache) return classesMapCache;
    if(!db) return {};

    try {
        const snap = await db.collection('classes').get();
        const map = {};
        snap.forEach(d => {
            map[d.id] = d.data().name;
        });
        classesMapCache = map;
        return map;
    } catch(e) {
        console.error('Erro getClassesMap', e);
        return {};
    }
}

async function deleteStudent(studentId, studentName) {
    if (!confirm(`Tem certeza que deseja apagar o aluno "${studentName}" e todos os registros de entrega vinculados?`)) {
        return;
    }
    try {
        // Apagar Entregas (deliveries)
        const deliveriesSnap = await db.collection('deliveries').where('studentId', '==', studentId).get();
        const batch = db.batch();
        deliveriesSnap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        // Apagar Aluno
        await db.collection('students').doc(studentId).delete();
        
        loadStudentsList($('studentsFilterClass').value); // Recarrega lista
        loadDashboardData(); // Atualiza contadores
        alert(`Aluno "${studentName}" apagado com sucesso.`);

    } catch(err) {
        console.error('Erro ao apagar aluno', err);
        alert('Erro ao apagar aluno: ' + (err.message || err));
    }
}


/* ---------------------------
   CHECKLIST (MODAL) E ENTREGA
   --------------------------- */

/**
 * Salva a entrega de um item.
 * @param {string} studentId 
 * @param {string} materialId 
 * @param {number} requiredQty 
 * @param {number} newQty - Nova quantidade entregue (pode ser maior que a necessária)
 * @param {HTMLElement} inputEl - Elemento de input (para feedback visual)
 * @param {HTMLElement} remainingEl - Elemento de restante (para feedback visual)
 * @param {boolean} isBatch - Indica se a chamada faz parte de uma operação de lote (mark all complete)
 * @returns {Promise<boolean>}
 */
async function saveDelivery(studentId, materialId, requiredQty, newQty, inputEl, remainingEl, isBatch = false){
    if(!db || !auth.currentUser) {
        if(!isBatch) alert('Você precisa estar logado para salvar entregas.');
        return false;
    }

    const qtyToSave = Math.min(newQty, requiredQty);
    const remaining = requiredQty - qtyToSave;
    const clerkName = getCurrentClerkName();
    
    // 1. Busca um documento de entrega existente
    const existingDeliverySnap = await db.collection('deliveries')
        .where('studentId', '==', studentId)
        .where('materialId', '==', materialId)
        .limit(1).get();

    try{
        if(existingDeliverySnap.empty){
            // 2. Não existe, cria um novo
            await db.collection('deliveries').add({
                studentId,
                materialId,
                classId: $('studentClassIdCache').value, // classId em cache no modal
                quantityDelivered: qtyToSave,
                requiredQuantity: requiredQty, // Guarda a quantidade requerida no momento
                clerkName: clerkName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            // 3. Existe, atualiza
            const docRef = existingDeliverySnap.docs[0].ref;
            await docRef.update({
                quantityDelivered: qtyToSave,
                clerkName: clerkName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Atualiza UI (apenas se não for lote)
        if(!isBatch){
            inputEl.value = qtyToSave; // Corrige o valor para o máximo permitido (o que foi salvo)
            remainingEl.textContent = remaining;
            remainingEl.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)';
            // Nenhuma notificação de sucesso se for lote, para não travar
        }

        return true;
    }catch(err){
        console.error('Erro ao salvar entrega', err);
        if(!isBatch) alert('Erro ao salvar entrega: ' + (err.message || err));
        return false;
    }
}

/**
 * Salva a assinatura do responsável e o nome do conferente no documento do aluno (collection 'students').
 * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 * @param {string} dataURL - A imagem da assinatura em Data URL (base64).
 * @param {string} signerName - O nome da pessoa que assinou (Responsável).
 * @param {string} clerkName - O nome do conferente (Administrador da Escola).
 * @returns {Promise<void>}
 */
async function saveSignature(studentDocId, dataURL, signerName, clerkName) {
    if (!db) throw new Error('Firestore não inicializado.');

    const data = {
        signatureDataURL: dataURL,
        signerName: signerName,
        clerkName: clerkName,
        signatureTimestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        // Atualiza o documento do aluno com os dados de assinatura e conferente
        await db.collection('students').doc(studentDocId).update(data);
    } catch(err) {
        console.error('Erro ao salvar assinatura', err);
        // Re-throw para que a função chamadora possa alertar o usuário
        throw new Error('Erro ao salvar assinatura e conferente: ' + (err.message || err));
    }
}

let signaturePadInstance = null; // Instância global do SignaturePad

/**
 * Abre o modal de checklist de materiais para um aluno específico.
 * Carrega a lista de materiais necessários, o status de entrega e a área de assinatura.
 * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function openStudent(studentDocId){
    if(!db) return alert('Firestore não inicializado');

    // 1. Inicializa o modal (Se ainda não existir)
    let modal = $('checklist-modal');
    if(!modal){
        modal = document.createElement('div');
        modal.id = 'checklist-modal';
        document.body.appendChild(modal);
    }
    modal.innerHTML = `<div class="checklist-modal-box"></div>`; // Limpa o conteúdo e prepara a caixa

    try{
        // 2. Fetch Student Info
        const sdoc = await db.collection('students').doc(studentDocId).get();
        if(!sdoc.exists) return alert('Aluno não encontrado');
        const s = sdoc.data();
        
        // Cache da Class ID para uso no saveDelivery
        if (!$('studentClassIdCache')) {
            const cache = document.createElement('input');
            cache.type = 'hidden';
            cache.id = 'studentClassIdCache';
            document.body.appendChild(cache);
        }
        $('studentClassIdCache').value = s.classId;

        // 3. Fetch Class Name e Materials
        let className = s.classId || 'Turma Desconhecida';
        let materialsArray = [];
        if(s.classId){
            try{
                const [classDoc, matsnap] = await Promise.all([
                    db.collection('classes').doc(s.classId).get(),
                    db.collection('materials').where('classId','==',s.classId).get()
                ]);
                if(classDoc.exists) className = classDoc.data().name;
                matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
                materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome
            }catch(e){
                console.error('Erro ao buscar turma/materiais:', e);
                className = 'Erro ao buscar Turma';
            }
        } else {
            // Sem turma, não tem lista
            materialsArray = [];
        }

        // 4. Fetch Entregas (Deliveries)
        const deliveriesSnap = await db.collection('deliveries').where('studentId','==',studentDocId).get();
        let deliveredQuantities = {}; // Mapeia {materialId: {quantity: N, by: clerkName, timestamp: T}}
        deliveriesSnap.forEach(d => {
            const data = d.data();
            deliveredQuantities[data.materialId] = { 
                quantity: data.quantityDelivered || 0,
                by: data.clerkName || 'Desconhecido',
                timestamp: data.timestamp 
            };
        });


        const box = modal.querySelector('.checklist-modal-box');
        
        // --- Header ---
        const header = document.createElement('div');
        header.style = 'padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;';
        header.innerHTML = `
            <div>
                <h3 class="section-title" style="margin: 0;">Checklist de Materiais</h3>
                <div class="small">Aluno: <strong>${s.name}</strong> (${s.studentId || 'N/A'}) - Turma: ${className}</div>
            </div>
            <button id="closeChecklist" class="btn secondary" style="padding: 10px 14px; font-size: 14px;">Fechar</button>
        `;
        box.appendChild(header);

        // --- List Area Header/Controls ---
        const listControls = document.createElement('div');
        listControls.style = 'padding: var(--pad); padding-bottom: 10px; border-bottom: 1px solid var(--border-color);';
        listControls.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 class="section-title" style="font-size: 16px; margin: 0;">Itens da Lista</h4>
                <button id="markCompleteBtn" class="btn secondary" style="padding: 10px 14px; font-size: 14px;">Marcar Todos como Entregues</button>
            </div>
        `;
        box.appendChild(listControls);

        // --- List Area ---
        const listArea = document.createElement('div');
        listArea.id = 'checklist-list-area';
        
        if (materialsArray.length === 0) {
            listArea.innerHTML = '<div class="small" style="padding: 16px;">Nenhum material cadastrado para esta turma.</div>';
        } else {
            materialsArray.forEach(m => {
                const id = m.id;
                const required = m.quantity || 1;
                const deliveredInfo = deliveredQuantities[id] || { quantity: 0 };
                const delivered = deliveredInfo.quantity;
                const remaining = required - delivered;
                const remainingColor = remaining > 0 ? 'var(--danger)' : 'var(--success)';
                const deliveredBy = deliveredInfo.by || 'N/A';
                const deliveredDate = deliveredInfo.timestamp ? new Date(deliveredInfo.timestamp.toDate()).toLocaleDateString('pt-BR') : 'N/A';
                
                // Item de checklist
                listArea.innerHTML += `
                    <div class="checklist-item">
                        <div class="checklist-item-details">
                            <strong style="font-size: 15px;">${required}x ${m.name}</strong>
                            <div class="small" style="margin-top: 4px;">
                                <span style="font-weight: 600; color: ${remainingColor};">Falta: <span class="remaining-qty">${remaining}</span></span>
                                | Última Conf.: ${deliveredDate} por ${deliveredBy}
                            </div>
                        </div>
                        <div class="checklist-item-controls">
                            <input type="number" 
                                class="delivery-input input" 
                                style="width: 70px !important; padding: 8px; text-align: center; font-size: 15px;" 
                                value="${delivered}" 
                                min="0" 
                                data-matid="${id}" 
                                data-required="${required}"
                            />
                            <button class="btn secondary save-delivery-btn" style="padding: 8px 14px; font-size: 14px;">Salvar</button>
                        </div>
                    </div>
                `;
            });
        }
        box.appendChild(listArea);


        // --- 5. Área de Assinatura ---
        const hasExistingSignature = !!s.signatureDataURL;
        const currentClerkName = getCurrentClerkName();
        const signaturePreviewStyle = hasExistingSignature ? 'display: block;' : 'display: none;';
        const signatureCanvasStyle = hasExistingSignature ? 'display: none;' : 'display: block;';
        
        const signatureArea = document.createElement('div');
        signatureArea.id = 'signature-area';
        signatureArea.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 class="section-title" style="font-size: 16px; margin: 0;">Assinatura e Conferência</h4>
                <button id="toggleSignatureBtn" class="btn secondary" style="padding: 10px 14px; font-size: 14px;">
                    ${hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura'}
                </button>
            </div>
            
            <div id="signature-content" style="display:none; margin-top: 15px;">
                <div id="signature-preview-container" style="${signaturePreviewStyle}">
                    <div class="small">Assinatura Salva: ${s.signerName || 'N/A'} (Conferente: ${s.clerkName || 'N/A'})</div>
                    <img id="signature-preview" src="${s.signatureDataURL || ''}" alt="Assinatura Salva" />
                </div>
                
                <div id="canvas-controls" style="${signatureCanvasStyle}">
                    <canvas id="signature-canvas"></canvas>
                    <div class="row" style="margin-top: 5px;">
                        <input id="signerName" class="input" placeholder="Nome Completo do Responsável" value="${s.signerName || ''}" ${hasExistingSignature ? 'disabled' : ''}/>
                    </div>
                    <div class="row" style="margin-top: 8px;">
                        <button id="clearSignature" class="btn secondary" style="width: 100px;">Limpar</button>
                        <button id="saveSignature" class="btn" style="flex:1;" ${hasExistingSignature ? 'disabled' : ''}>Salvar Assinatura & Conferente</button>
                    </div>
                </div>
                <div class="small" style="margin-top: 10px;">Conferente atual: <strong>${currentClerkName}</strong></div>
            </div> 
        `;
        box.appendChild(signatureArea);
        
        // --- 6. Exibe o modal ---
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden';

        // --- 7. Listeners do Modal ---
        $('closeChecklist').addEventListener('click', ()=>{
            modal.classList.remove('visible');
            document.body.style.overflow = '';
            loadStudentsList($('studentsFilterClass').value); // Recarrega a lista para atualizar o status de assinatura
        });

        // Toggle Assinatura
        const toggleBtn = $('toggleSignatureBtn');
        const signatureContent = $('signature-content');
        const canvasControls = $('canvas-controls');

        // Se houver assinatura prévia, já exibe por padrão (mas desabilitada a edição)
        if (hasExistingSignature) { 
            signatureContent.style.display = 'block'; 
        }

        toggleBtn.addEventListener('click', function() {
            const isVisible = signatureContent.style.display === 'block';
            signatureContent.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? (hasExistingSignature ? 'Ver Assinatura' : 'Abrir Assinatura') : (hasExistingSignature ? 'Ocultar Assinatura' : 'Ocultar');
            
            // Inicializa o SignaturePad apenas se for o primeiro acesso e a área estiver sendo aberta
            if(!hasExistingSignature && !signaturePadInstance && !isVisible) {
                const canvas = $('signature-canvas');
                signaturePadInstance = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)' 
                });
                canvasControls.style.display = 'block';
                $('signature-preview-container').style.display = 'none';
            }
        });

        // Limpar Assinatura
        if($('clearSignature')) $('clearSignature').addEventListener('click', ()=>{
            if(signaturePadInstance) signaturePadInstance.clear();
        });

        // Salvar Assinatura
        if($('saveSignature')) $('saveSignature').addEventListener('click', async function(){
            const signerName = $('signerName').value.trim();
            const clerkName = getCurrentClerkName();
            
            if(!signerName){
                alert('Preencha o nome do responsável.');
                return;
            }
            if(!signaturePadInstance || signaturePadInstance.isEmpty()){
                 alert('Por favor, colete a assinatura na área acima.');
                 return;
            }

            this.disabled = true;
            this.textContent = 'Salvando...';
            
            try{
                const dataURL = signaturePadInstance.toDataURL("image/png");
                await saveSignature(studentDocId, dataURL, signerName, clerkName);

                alert('Assinatura e dados de conferência salvos com sucesso!');
                
                // Feedback visual de sucesso e desabilita edição
                this.textContent = 'Assinatura Salva';
                $('clearSignature').disabled = true;
                $('signerName').disabled = true;
                
                // Atualiza a pré-visualização (se fosse reabrir)
                const preview = $('signature-preview');
                preview.src = dataURL;
                $('signature-preview-container').style.display = 'block';
                canvasControls.style.display = 'none';

            }catch(e){
                alert(e.message || 'Erro ao salvar assinatura');
            }finally{
                // Se deu erro, reabilita o botão
                if(this.textContent !== 'Assinatura Salva') {
                    this.disabled = false;
                    this.textContent = 'Salvar Assinatura & Conferente';
                }
            }
        });


        // 8. Listeners para os itens de entrega
        listArea.querySelectorAll('.checklist-item').forEach(item => {
            const inputEl = item.querySelector('.delivery-input');
            const remainingEl = item.querySelector('.remaining-qty');
            const saveBtn = item.querySelector('.save-delivery-btn');
            const matId = inputEl.dataset.matid;
            const requiredQty = parseInt(inputEl.dataset.required, 10);

            // Listener para o input de mudança de valor
            inputEl.addEventListener('input', function() {
                let newQty = parseInt(this.value, 10);
                // Limita a quantidade visível ao máximo digitado, mas o salvamento limita ao requerido
                const delivered = Math.min(newQty, requiredQty); 
                const remaining = requiredQty - delivered;
                
                remainingEl.textContent = remaining;
                remainingEl.style.color = remaining > 0 ? 'var(--danger)' : 'var(--success)';
            });

            // Listener para o botão Salvar
            saveBtn.addEventListener('click', async function(){
                this.disabled = true;
                this.textContent = '...';
                
                const newQty = parseInt(inputEl.value, 10);
                const success = await saveDelivery(studentDocId, matId, requiredQty, newQty, inputEl, remainingEl, false);
                
                this.disabled = false;
                this.textContent = 'Salvar';

                if (success) {
                    // Feedback visual temporário de sucesso
                    const originalBg = item.style.backgroundColor;
                    item.style.backgroundColor = 'var(--success-light)';
                    setTimeout(() => {
                        item.style.backgroundColor = originalBg;
                    }, 300);
                }
            });
        });

        // 9. Listener para o botão "Marcar Todos"
        $('markCompleteBtn').addEventListener('click', async function(){
            if(!confirm('Tem certeza que deseja marcar TODOS os materiais como ENTREGUES (Qtd. Entregue = Qtd. Necessária)?')) return;
            
            this.disabled = true;
            this.textContent = 'Marcando...';

            const items = listArea.querySelectorAll('.checklist-item');
            const promises = [];
            let successCount = 0;
            
            for (const item of items) {
                const inputEl = item.querySelector('.delivery-input');
                const remainingEl = item.querySelector('.remaining-qty');
                const matId = inputEl.dataset.matid;
                const requiredQty = parseInt(inputEl.dataset.required, 10);
                
                // Define o valor do input para o máximo
                inputEl.value = requiredQty; 
                
                // Salva a entrega
                const success = await saveDelivery(studentDocId, matId, requiredQty, requiredQty, inputEl, remainingEl, true);
                if (success) {
                    successCount++;
                    remainingEl.textContent = 0;
                    remainingEl.style.color = 'var(--success)';
                }
            }
            
            this.disabled = false;
            this.textContent = 'Marcar Todos como Entregues';
            alert(`${successCount} de ${items.length} itens marcados como entregues!`);

        });

    }catch(err){
        console.error('Erro openStudent', err);
        modal.innerHTML = `<div class="checklist-modal-box" style="padding: 20px;">
            <h3 style="color:var(--danger)">Erro ao carregar Checklist</h3>
            <div class="small">${err.message || 'Ocorreu um erro desconhecido.'}</div>
            <button class="btn secondary" style="margin-top: 15px;" onclick="document.getElementById('checklist-modal').classList.remove('visible'); document.body.style.overflow = '';">Fechar</button>
        </div>`;
        modal.classList.add('visible');
    }
}


/* ---------------------------
   QR & PRINT (TAB)
   --------------------------- */

// Gerar QRs
$('btnGenerateQRs').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');
    
    const classId = $('qrClassSelect').value;
    if(!classId) return alert('Selecione uma turma para gerar os QRs.');
    
    this.disabled = true;
    this.textContent = 'Gerando...';

    const gallery = $('qrGallery');
    gallery.innerHTML = '';

    try {
        const studentsSnap = await db.collection('students').where('classId', '==', classId).orderBy('name').get();

        if(studentsSnap.empty){
            gallery.innerHTML = '<div class="small" style="grid-column: 1 / -1;">Nenhum aluno encontrado nesta turma.</div>';
            return;
        }

        studentsSnap.forEach(d => {
            const s = d.data();
            const studentId = d.id;
            const qrUrl = getStudentQRUrl(studentId, 'print'); // Usando modo 'print' para abrir o documento simplificado
            
            // Cria um contêiner para cada QR Code
            const qrContainer = document.createElement('div');
            qrContainer.style = 'border: 1px solid var(--border-color); padding: 10px; border-radius: var(--radius); text-align: center; background: var(--card);';
            qrContainer.innerHTML = `
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">${s.name}</div>
                <div id="qr-${studentId}" style="width:120px; height:120px; margin: 0 auto;"></div>
                <div class="small">${s.studentId || 'N/A'}</div>
                <button class="btn secondary" style="padding: 6px 10px; font-size:12px; margin-top: 8px;" onclick="downloadQRCode('${studentId}', '${s.name.replace(/'/g, "\\'")}')">Download PNG</button>
            `;
            gallery.appendChild(qrContainer);
            
            // Renderiza o QR Code usando a biblioteca QRCode.js
            new QRCode(document.getElementById(`qr-${studentId}`), {
                text: qrUrl,
                width: 120,
                height: 120,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });

    } catch(err) {
        console.error('Erro ao gerar QR', err);
        gallery.innerHTML = '<div class="small" style="grid-column: 1 / -1; color:var(--danger)">Erro ao gerar QRs: ' + (err.message || err) + '</div>';
    } finally {
        this.disabled = false;
        this.textContent = 'Gerar QRs';
    }
});

function downloadQRCode(studentId, studentName) {
    const qrDiv = document.getElementById(`qr-${studentId}`);
    const canvas = qrDiv.querySelector('canvas');
    const img = qrDiv.querySelector('img'); // Em alguns navegadores (IE/Edge) pode usar <img>

    let dataURL;
    if (canvas) {
        dataURL = canvas.toDataURL("image/png");
    } else if (img) {
        dataURL = img.src;
    } else {
        alert('Não foi possível encontrar a imagem do QR Code.');
        return;
    }

    const link = document.createElement('a');
    link.href = dataURL;
    link.download = `QR_${studentName.replace(/ /g, '_')}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


/**
 * Gera um documento de checklist pronto para impressão em uma nova janela.
 * @param {string} studentDocId - O ID do documento do aluno no Firestore.
 */
async function generatePrintableChecklist(studentDocId){
    if(!db) return alert('Firestore não inicializado');

    // 1. Fetch Student Info
    const sdoc = await db.collection('students').doc(studentDocId).get();
    if(!sdoc.exists) return alert('Aluno não encontrado');
    const s = sdoc.data();

    // NOVIDADE: 1.1. Fetch Class Name
    let className = s.classId || 'Turma Desconhecida (ID: N/A)';
    if(s.classId){
        try{
            const classDoc = await db.collection('classes').doc(s.classId).get();
            if(classDoc.exists) className = classDoc.data().name;
            else className = `Turma Desconhecida (ID: ${s.classId})`;
        }catch(e){
            console.error('Erro ao buscar nome da turma:', e);
            className = `Erro ao buscar Turma (ID: ${s.classId})`;
        }
    }


    // 2. Fetch Class Materials
    const matsnap = await db.collection('materials').where('classId','==',s.classId).get();
    
    // 3. Fetch Deliveries
    const deliveriesSnap = await db.collection('deliveries').where('studentId','==',studentDocId).get();
    const deliveredQuantities = {};
    deliveriesSnap.forEach(d=> deliveredQuantities[d.data().materialId] = d.data().quantityDelivered || 0);

    const materialsArray = [];
    matsnap.forEach(m=> materialsArray.push({id:m.id, ...m.data()}));
    materialsArray.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); // Ordena por nome

    let checklistHtml = '';
    let totalMissing = 0;
    
    materialsArray.forEach(m => {
        const required = m.quantity || 1;
        const delivered = deliveredQuantities[m.id] || 0;
        const missing = required - delivered;
        if(missing > 0) totalMissing += missing;
        
        const status = missing === 0 ? 'COMPLETO' : (delivered > 0 ? 'INCOMPLETO' : 'PENDENTE');
        const statusColor = missing === 0 ? 'var(--success)' : 'var(--danger)';

        checklistHtml += `
            <div class="material-item-doc" style="font-size: 14px;">
                <div style="flex:1; width: 40%;">${m.name}</div>
                <div style="width: 15%; text-align: center;">${required}</div>
                <div style="width: 15%; text-align: center;">${delivered}</div>
                <div style="width: 15%; text-align: center; color: ${statusColor}; font-weight: 600;">${missing}</div>
                <div style="width: 15%; text-align: center;">${status}</div>
            </div>
        `;
    });

    // 4. Constrói o HTML da nova janela
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    const signatureImageHtml = s.signatureDataURL 
        ? `<img class="signature-image" src="${s.signatureDataURL}" alt="Assinatura Salva"/>`
        : `<div class="signature-image" style="display:flex; align-items:center; justify-content:center; font-size:12px; color:#888;">Área de Assinatura (Física)</div>`;
    
    const signatureInfo = s.signatureDataURL 
        ? `Entregue em: ${new Date(s.signatureTimestamp.toDate()).toLocaleDateString('pt-BR')}`
        : ``;

    const fullHtml = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Checklist - ${s.name}</title>
            <style>
                body { font-family: 'Inter', sans-serif; margin: 20px; }
                h1 { font-size: 20px; border-bottom: 2px solid #000; padding-bottom: 5px; }
                h2 { font-size: 16px; margin-bottom: 5px; }
                h3 { font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 25px; }
                .material-list { border: 1px solid #ccc; border-radius: 4px; margin-top: 10px; overflow: hidden; }
                .material-header-doc, .material-item-doc { display: flex; padding: 8px 10px; border-bottom: 1px solid #eee; align-items: center; }
                .material-header-doc { font-weight: bold; background: #eef4ff; color: #2b7cff; border-bottom: 2px solid #ccc; }
                .material-item-doc:last-child { border-bottom: none; }
                .material-item-doc > div { overflow: hidden; text-overflow: ellipsis; }
                .signature-area { display: flex; justify-content: space-between; margin-top: 50px; }
                .signature-block { display: inline-block; width: 48%; /* Aumentado um pouco para ocupar mais espaço */ vertical-align: top; text-align: center; }
                .signature-line { border-top: 1px solid #000; margin-top: 15px; /* Aumentado o espaço para a linha */ padding-top: 5px; font-weight: bold; }
                .signature-image { max-width: 100%; max-height: 100px; height: 100px; /* Altura fixa para o bloco da assinatura */ border: 1px solid #ccc; object-fit: contain; background: #f9f9f9; margin-bottom: 5px; }
                .footer-text { margin-top: 30px; text-align: center; font-size: 11px; color: #888; }
                /* Mídia de Impressão */ 
                @media print { 
                    body { font-size: 12px; margin: 10mm; /* Margens de impressão */ }
                    .signature-area { margin-top: 30px; }
                    .signature-line { margin-top: 10px; }
                    .material-item-doc, .material-header-doc { font-size: 11px; }
                }
            </style>
        </head>
        <body>
            <h1>Documento de Entrega de Material Escolar</h1>
            
            <h2>Aluno: ${s.name} (${s.studentId || 'N/A'})</h2>
            <h2>Turma: ${className}</h2>
            <div style="font-size: 14px; margin-top: 10px;">Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}</div>
            <div style="font-size: 14px; color: ${totalMissing === 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 700;">Status: ${totalMissing === 0 ? 'LISTA COMPLETA' : `FALTAM ${totalMissing} ITENS`}</div>

            <h3>Lista de Materiais</h3>
            <div class="material-list">
                <div class="material-header-doc">
                    <div style="flex:1; width: 40%;">Item</div>
                    <div style="width: 15%; text-align: center;">Requerido</div>
                    <div style="width: 15%; text-align: center;">Entregue</div>
                    <div style="width: 15%; text-align: center;">Falta</div>
                    <div style="width: 15%; text-align: center;">Status</div>
                </div>
                ${checklistHtml}
            </div>

            <div class="signature-area">
                <div class="signature-block">
                    ${signatureImageHtml}
                    <div class="signature-line">
                        RESPONSÁVEL (${s.signerName || 'Nome não Salvo'})
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: #888;">${signatureInfo}</div>
                </div>
                <div class="signature-block">
                    <div class="signature-image" style="border: 1px dashed #ccc;"></div>
                    <div class="signature-line">
                        CONFERENTE (Assinatura física)
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: #888;">Conferente Salvo: ${s.clerkName || 'N/A'}</div>
                </div>
            </div>

            <div class="footer-text">
                Este documento é uma via de conferência e entrega de material escolar. O responsável atesta o recebimento dos itens marcados como 'Entregues'.
            </div>
        </body>
        </html>
    `;

    printWindow.document.write(fullHtml);
    printWindow.document.close();
    printWindow.focus();
    // printWindow.print(); // Descomente se quiser forçar a abertura da caixa de impressão

}


/* ---------------------------
   REPORTS (TAB)
   --------------------------- */

$('btnRunReport').addEventListener('click', async function(){
    if(!db) return alert('Firestore não inicializado.');
    
    const classId = $('reportClass').value;
    if(!classId) return alert('Selecione uma turma para gerar o relatório.');
    
    this.disabled = true;
    this.textContent = 'Gerando...';

    try {
        const [studentsnap, matsnap, deliveriesSnap, classDoc] = await Promise.all([
            db.collection('students').where('classId', '==', classId).orderBy('name').get(),
            db.collection('materials').where('classId', '==', classId).get(),
            db.collection('deliveries').where('classId', '==', classId).get(),
            db.collection('classes').doc(classId).get()
        ]);

        const className = classDoc.exists ? classDoc.data().name : 'Turma Desconhecida';

        // 1. Mapear materiais e suas quantidades requeridas
        const requiredMaterials = {}; // { materialId: requiredQty }
        matsnap.forEach(d => requiredMaterials[d.id] = d.data().quantity || 1);
        
        if (matsnap.empty) {
            $('reportArea').innerHTML = `<div class="small">Nenhum material cadastrado para a turma ${className}.</div>`;
            return;
        }

        // 2. Mapear entregas por aluno
        // { studentId: { materialId: deliveredQty } }
        const studentDeliveries = {};
        deliveriesSnap.forEach(d => {
            const data = d.data();
            if (!studentDeliveries[data.studentId]) studentDeliveries[data.studentId] = {};
            studentDeliveries[data.studentId][data.materialId] = data.quantityDelivered || 0;
        });
        
        // 3. Calcular faltas por aluno
        const reportData = [];
        studentsnap.forEach(d => {
            const s = d.data();
            let totalMissing = 0;
            
            // Itera sobre todos os materiais requeridos para a turma
            Object.keys(requiredMaterials).forEach(matId => {
                const required = requiredMaterials[matId];
                const delivered = (studentDeliveries[d.id] && studentDeliveries[d.id][matId]) || 0;
                totalMissing += Math.max(0, required - delivered); // Não pode ser negativo
            });

            // Apenas alunos com alguma falta ou que ainda não assinaram
            if (totalMissing > 0 || !s.signatureDataURL) {
                 reportData.push({
                    name: s.name,
                    studentId: s.studentId || 'N/A',
                    totalMissing: totalMissing,
                    signed: !!s.signatureDataURL
                });
            }
        });

        // Ordenar: primeiro os alunos com mais faltas, depois por nome
        reportData.sort((a, b) => b.totalMissing - a.totalMissing || a.name.localeCompare(b.name));

        // 4. Montar a Tabela
        let tableHtml = `
            <table style="width:100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background: var(--accent-light); color: var(--accent); font-size: 14px;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #ccc;">Aluno</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #ccc; width: 120px;">Matrícula</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #ccc; width: 100px;">Faltas (Total)</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #ccc; width: 120px;">Assinatura</th>
                    </tr>
                </thead>
                <tbody>
        `;

        reportData.forEach(item => {
            const missingColor = item.totalMissing > 0 ? 'var(--danger)' : 'var(--success)';
            const signedStatus = item.signed ? 'Sim' : 'Não';
            const signedColor = item.signed ? 'var(--success)' : 'var(--danger)';

            tableHtml += `
                <tr style="font-size: 14px; border-bottom: 1px solid #eee;">
                    <td style="padding: 10px; text-align: left;">${item.name}</td>
                    <td style="padding: 10px; text-align: center;">${item.studentId}</td>
                    <td style="padding: 10px; text-align: center; color: ${missingColor}; font-weight: 600;">${item.totalMissing}</td>
                    <td style="padding: 10px; text-align: center; color: ${signedColor};">${signedStatus}</td>
                </tr>
            `;
        });
        
        tableHtml += `</tbody></table>`;

        // 5. Renderizar
        $('btnRunReport').disabled = false;
        $('btnRunReport').textContent = 'Gerar relatório';
        
        const table = document.createElement('div');
        table.className = 'card';
        table.innerHTML = `
            <h3 class="section-title" style="margin-top: 0;">Relatório de Faltas - ${className}</h3>
            ${tableHtml}
        `;

        $('reportArea').innerHTML = ''; // Limpa a área
        
        if (studentsnap.empty) {
            $('reportArea').innerHTML = '<div class="small">Nenhum aluno encontrado nesta turma para gerar o relatório.</div>';
        } else {
            // Cria um contêiner para o botão e a tabela
            const contentWrapper = document.createElement('div');
            
            // Adiciona o botão de fechar no topo
            contentWrapper.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <button class="btn secondary" 
                            style="background-color: var(--muted); color: white;" 
                            onclick="document.getElementById('reportArea').innerHTML = ''">
                        &larr; Fechar Relatório
                    </button>
                </div>`;

            // Anexa a tabela de relatório ao contêiner
            contentWrapper.appendChild(table);
            
            // Insere o contêiner completo na área do relatório
            $('reportArea').appendChild(contentWrapper);
        }
        
    }catch(err){
        console.error('Erro Relatório',err);
        alert('Erro ao gerar relatório: ' + (err.message||err));
        this.disabled = false;
        this.textContent = 'Gerar relatório';
    }
});

/* --------------------------- END OF JS --------------------------- */
</script>
</html>
